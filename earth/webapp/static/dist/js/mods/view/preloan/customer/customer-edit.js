define(function(require,exports,module){var e=require("scaffold/path"),t=require("component/popupTip"),i=require("component/fileUpload"),a=require("component/areaSelect"),r=require("baseView/baseFormView"),o=r.FieldsetView,n=r.FormDialogView,c=r.SketchItemView,l=jQuery,s=global_config.root,d=image_oss_host,m=function(e){var t='<li class="item" data-filename="'+e.fileName+'" data-currentstoredkey="'+(e.currentStoredKey||"")+'"><a target="_blank" class="filename" href="'+d.original+"/"+e.currentStoredKey+'">'+e.fileName+'</a><a href="#" class="delete">删除</a></li>';return t},u=global_const.loadingImg.clone(),h=Backbone.Model.extend({url:function(){return this.isUpdate?s+"/preloan/customer/edit":s+"/preloan/customers/add"},defaults:{provinceCode:"",cityCode:"",name:"",fName:"",regNo:"",industryUuid:"",address:"",contactPersons:[],confidentialityAgreement:{},creditQueryAuthorization:{},archives:[]},initialize:function(e){e&&e.customerUuid?this.isUpdate=!0:this.isUpdate=!1},parse:function(e){return e.data},manualSave:function(e){var t=this.toJSON();e=l.extend({data:{customerInfo:JSON.stringify(t)},emulateJSON:!0},e),this.save({},e)},lookupCommerce:function(e,t){var i=s+"/preloan/enterprise-credit",a={url:i,data:{name:e},dataType:"JSON"};a.success=t,l.ajax(a)}}),f=n.extend({template:_.template(l("#contacterEditTmpl").html(),{variable:"obj"}),initialize:function(){f.__super__.initialize.apply(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$(".form").validate({rules:{name:"required",email:"email",telephone:{mPhoneExt:!0}}})},validate:function(){return this.validator.form()},submitHandler:function(e){e.preventDefault(),this.validate()&&(this.save(),this.hide())}}),p=c.extend({template:_.template(l("#contacterTtemTmpl").html()),toEdit:function(){var e=new f({model:this.model});e.show()}}),v=o.extend({el:".form-wrapper",events:{"click #lookupCommerce":"onClickLookupCommerce","click .submit":"submitHandler","click .btn-contacter":"onClickBtnContacter","click #check-more":"onClickMoreCommerce",'keypress [name="name"]':"onChangeCustomerName","keydown .form":function(e){13===e.keyCode&&e.preventDefault()}},initialize:function(e){"string"==typeof e?(this.model=new h({customerUuid:e}),this.model.set(JSON.parse(this.$("#hiddenModelAttr").val())),this.correctCusName=this.$("input[name='name']").val().trim()):(this.model=new h,this.correctCusName=""),this.defineValidator(),this.initFileUpload(),this.arerSelect=new a({el:this.$(".area-select")}),this.contacterCollection=new Backbone.Collection(this.model.get("contactPersons")),this.listenTo(this.contacterCollection,"add",this.addOneContacter),this.addAllContacter(this.contacterCollection),this.addArchives(this.model.get("archives")),this.addSecretTreaty(this.model.get("confidentialityAgreement")),this.addCreditQueryAuthorization(this.model.get("creditQueryAuthorization"))},onChangeCustomerName:function(e){self.$("#check-more").hide()},onClickLookupCommerce:function(e){e.preventDefault();var i=l(e.target).prevAll("[name=name]").val(),a=this,r=this.$("#check-more");i?(e.target.disabled=!0,l(e.target).parent().append(u),this.model.lookupCommerce(i,function(i){if(0!=i.code)t.show(i.message||"未查询到该企业或该企业不存在！请确保客户名称准确无误！");else{var o=i.data;a.$("[name=fName]").val(o.fName),a.$("[name=regNo]").val(o.regNo),a.correctCusName=o.entName,r.attr("href",a.getMoreCommerceUrl({k:"commerce",regNo:o.regNo})),a.$("#check-more").show()}setTimeout(function(){e.target.disabled=!1,u.remove()},500)})):t.show("请先输入客户名称")},onClickBtnContacter:function(e){e.preventDefault();var t=this.contacterCollection,i=new Backbone.Model,a=new f({model:i,sourceModel:this.model});a.show(),i.once("change",function(e){t.add(e)})},onClickMoreCommerce:function(e){var t=(this.$("#check-more"),l("input[name='name']").val().trim()),i=this.$("#lookupCommerce");i.length?t==this.correctCusName&&""!=t||e.preventDefault():(window.open(this.getMoreCommerceUrl({k:"commerce",customerUuid:this.model.get("customerUuid")}),"_blank"),e.preventDefault())},getMoreCommerceUrl:function(t){return e.format({path:s+"/preloan/customer",query:t})},defineValidator:function(){this.validator=this.$(".form").validate({rules:{username:"required",provinceCode:"required",cityCode:"required",industryUuid:"required"}})},initFileUpload:function(){var e=this,t=function(t,i){var a=e.$(i.data("target"));a.hasClass("archives")?a.append(t):a.html(t)};i.globalUploadFile(this.$(".file-input"),{action:s+"/preloan/file",fileFilter:[".pdf",".doc",".docx",".png",".jpg",".rar",".zip"],onPlacement:t,createItemDom:m})},addOneContacter:function(e){var t=new p({model:e});this.$(".contacters").append(t.render().$el)},addAllContacter:function(e){for(var t=0,i=e.length;i>t;t++)this.addOneContacter(e.at(t))},createFileDoms:function(e){for(var t=m,i=l("<div/>"),a=0;a<e.length;a++)i.append(t(e[a]));return i.html()},addArchives:function(e){var t=this.$(".archives");t.append(this.createFileDoms(e))},addSecretTreaty:function(e){if(!_.isEmpty(e)&&e.fileName){var t=this.$(".confidentialitys");t.append(this.createFileDoms([e]))}},addCreditQueryAuthorization:function(e){if(!_.isEmpty(e)&&e.fileName){var t=this.$(".credit-query-authorization");t.append(this.createFileDoms([e]))}},extractDomData:function(){var e=function(e){var t=e.data();return t?{fileName:t.filename,currentStoredKey:t.currentstoredkey}:null},t=this._extractDomData(this.$(".real-value")),i=_.omit(t,"agreementNo","signedDate","sendDate","sendOrderNo","receiveDate","receiveOrderNo","cqaSendDate","cqaSendOrderNo","cqaReceiveDate","cqaReceiveOrderNo");i.confidentialityAgreement=_.pick(t,"agreementNo","signedDate","sendDate","sendOrderNo","receiveDate","receiveOrderNo");var a=e(this.$(".confidentialitys").children().first());null!=a&&(i.confidentialityAgreement.fileName=a.fileName,i.confidentialityAgreement.currentStoredKey=a.currentStoredKey);for(var r=["cqaSendDate","cqaSendOrderNo","cqaReceiveDate","cqaReceiveOrderNo"],o=["sendDate","sendOrderNo","receiveDate","receiveOrderNo"],n=_.pick(t,r),c={},l=0;l<r.length;l++){var s=r[l];"undefined"!=typeof n[s]&&(c[o[l]]=n[s])}i.creditQueryAuthorization=c;var d=e(this.$(".credit-query-authorization").children().first());null!=d&&(i.creditQueryAuthorization.fileName=d.fileName,i.creditQueryAuthorization.currentStoredKey=d.currentStoredKey),i.archives=[];for(var m=this.$(".archives").children(),l=0,u=m.length;u>l;l++)i.archives.push(e(m.eq(l)));return i.contactPersons=this.contacterCollection.toJSON(),i},save:function(){var e=this.extractDomData();this.model.set(e),this.model.manualSave({success:function(e,i){0==i.code?(t.show("成功，正在跳转..."),setTimeout(function(){AppRouters.navigate("preloan/customers",{absolute:!0})},1500)):t.show(i.message)}})},validate:function(){var e=this.validator.form();return e},submitHandler:function(e){e.preventDefault();var i=this.$("input[name='name']").val().trim();this.validate()&&(i=i.replace(/（/g,"(").replace(/）/g,")"),i==this.correctCusName?this.save():t.show("请输入正确的客户名称"))}});module.exports=v});