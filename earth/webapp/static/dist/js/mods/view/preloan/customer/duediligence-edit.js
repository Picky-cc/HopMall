define(function(require,exports,module){var e=require("scaffold/path"),i=require("component/popupTip"),t=require("component/fileUpload"),n=require("baseView/baseFormView"),a=(n.FieldsetView,n.FormDialogView),o=jQuery,r=global_config.root,d=image_oss_host,l=function(e,i){var t=i.parents(".field-row").find(".upload-files");t.html(e)},c=function(e){var i='<li class="item" data-filename="'+e.fileName+'" data-currentstoredkey="'+(e.currentStoredKey||"")+'"><a target="_blank" class="filename" href="'+d.original+"/"+e.currentStoredKey+'">'+e.fileName+'</a><a href="#" class="delete">删除</a></li>';return i},s={duediligence_item_license_original:[".png",".jpg"],duediligence_item_license_copy:[".png",".jpg"],duediligence_item_national_tax_certificate:[".png",".jpg"],duediligence_item_land_tax_certificate:[".png",".jpg"],duediligence_item_org_code_certificate_original:[".png",".jpg"],duediligence_item_org_code_certificate_copy:[".png",".jpg"],duediligence_item_shareholding_structure:[".pdf",".doc",".docx",".png",".jpg",".rar",".zip"],duediligence_item_by_laws:[".pdf",".doc",".docx",".png",".jpg",".rar",".zip"],duediligence_item_credit_query_authorization:[".png",".jpg"],duediligence_item_corporate_representative_id_card:[".png",".jpg"],duediligence_item_company_history:[".pdf",".doc",".docx",".png",".jpg",".rar",".zip"],duediligence_item_financial_report:[".pdf",".doc",".docx",".rar",".zip"],duediligence_item_audit_report:[".pdf",".doc",".docx",".rar",".zip"],duediligence_item_other_taxes_and_fees_description:[".pdf",".doc",".docx",".png",".jpg",".rar",".zip"],duediligence_item_contract:[".pdf",".doc",".docx",".png",".jpg",".rar",".zip"],duediligence_item_asset:[".pdf",".doc",".docx",".png",".jpg",".rar",".zip"],duediligence_item_other:[".pdf",".doc",".docx",".png",".jpg",".rar",".zip"]},p={action:r+"/preloan/file",onPlacement:l,createItemDom:c},f=a.extend({template:_.template(o("#editFileTmpl").html()||""),initialize:function(e){f.__super__.initialize.apply(this,arguments);var i=o.extend({},p,{fileFilter:e.fileFilter});t.globalUploadFile(this.$(".file-input"),i)},extractDomData:function(){var i=this._extractDomData(this.$(".real-value"));i.fileInfos=[];for(var t=this.$(".upload-files .item"),n=0;n<t.length;n++){var a=t.eq(n).data(),o=e.extname(a.filename);a&&i.fileInfos.push({fileName:i.fileName?i.fileName+o:a.filename,currentStoredKey:a.currentstoredkey})}return i},submitHandler:function(){this.save(),this.hide()}}),u=Backbone.View.extend({el:o(".form-wrapper"),events:{"click .offline-done":"onClickOfflineDone","click .submit":"onClickSubmit"},initialize:function(e){this.options=e||{};var i=this.getItemKey;this.$(".file-input").each(function(){var e=i(this),n=o.extend({},p,{fileFilter:s[e]});t.globalUploadFile(o(this),n)})},getItemKey:function(e){return o(e).parents("[data-item-key]").data("item-key")},onClickOfflineDone:function(e){},validate:function(){return!0},onClickSubmit:function(t){if(t.preventDefault(),this.validate()){var n=this.extractFromDom(),a=e.format({path:r+"/preloan/customer",query:{customerUuid:this.options.customerUuid,key:this.options.key,k:"duediligence"}});this.submit(n,function(){i.show("编辑成功，正在跳转..."),setTimeout(function(){location.assign(a)},1500)})}},extractFromSection:function(e){for(var i={},t=e.find("[data-item-key]"),n=e.find("[data-subitem-key]"),a=0;a<t.length;a++){var o=t.eq(a),r=o.data("item-key"),d=n.filter("[data-paritem-key="+r+"]"),l=this.extractFromField(o,d);i[r]=l}return i},extractFromField:function(e,i){var t={};t.hasOfflineArchives=e.find(".offline-done").get(0).checked,t.fileInfos=[];for(var n=e.find(".upload-files .item"),a=0;a<n.length;a++){var o=n.eq(a).data();o&&t.fileInfos.push({fileName:o.filename,currentStoredKey:o.currentstoredkey})}if(i&&i.length>0)for(var r=t.subTextItemsMap={},d=0;d<i.length;d++){var l=i.eq(d),c=l.data("subitem-key"),s=l.find(".real-value").val();r[c]=s}return t},extractFromDom:function(){for(var e={},i=this.$("[data-section-key]"),t=0;t<i.length;t++){var n=i.eq(t),a=n.data("section-key"),o=this.extractFromSection(n);e[a]=o}return e},submit:function(e,t){var n=r+"/preloan/customer/edit?k=duediligence",a={};a.customerUuid=this.options.customerUuid,a.key=this.options.key,a.sectionsMap=JSON.stringify(e),o.post(n,a,function(e){try{e=JSON.parse(e),0==e.code?t(e.data):i.show(e.message)}catch(n){i.show("无法解析的json格式")}})}});u.extend=function(e){var i=Backbone.View.extend.apply(this,arguments);return i.prototype.events=_.extend({},this.prototype.events,e.events),i};var m=u,g=u.extend({events:{"click .add":"onClickAdd"},onClickAdd:function(e){e.preventDefault();var i=o(e.target).parents(".field-row"),t=this.getItemKey(e.target),n=new Backbone.Model,a=i.find(".upload-files");n.once("change",function(e){if(a){var i=c(e.get("fileInfos")[0]);a.append(i)}});var r=new f({model:n,fileFilter:s[t]});"duediligence_item_financial_report"===t?(r.updateTitle("添加财务报告"),r.show()):"duediligence_item_audit_report"===t?(r.updateTitle("添加审计报告"),r.show()):"duediligence_item_other_taxes_and_fees_description"===t&&(r.updateTitle("添加其他税费事项说明"),r.show())}}),h=u.extend({events:{"click .add":"onClickAdd"},onClickAdd:function(e){e.preventDefault();var i=o(e.target).parents(".field-row"),t=this.getItemKey(e.target),n=new Backbone.Model,a=i.find(".upload-files");n.once("change",function(e){if(a){var i=c(e.get("fileInfos")[0]);a.append(i)}});var r=new f({model:n,fileFilter:s[t]});"duediligence_item_contract"===t?(r.updateTitle("协议材料"),r.show()):"duediligence_item_asset"===t?(r.updateTitle("资产材料"),r.show()):"duediligence_item_other"===t&&(r.updateTitle("其他材料"),r.show())}});exports.basic=m,exports.finance=g,exports.other=h});