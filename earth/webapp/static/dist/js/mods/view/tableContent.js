define(function(require,exports,module){var t=require("scaffold/util"),e=require("component/pageControl"),a=require("scaffold/path"),r=jQuery,i=global_const.loadingImg.clone(),s=t.extractValueFromDifferentDom,n=t.isIE(),o=Backbone.View.extend({template:_.template(r("#tableFieldTmpl").html()||""),el:".content",events:{"click #lookup":"_queryByParams","change .lookup-params":function(t){r(t.target).parents(".operations").length||r(t.target).is("[autoquery=false]")||this._queryByParams()},"keyup .lookup-params":function(t){r(t.target).parents(".operations").length||n&&13==t.which&&r(t.target).change()},"click .redirect,.prev,.next,.first-page,.last-page":"onClickPageNavigateBtn","keyup .redirect-form":"onKeyupRedirectForm","click .check-box":"onClickCheckbox","click .clear-input":"onClickClearInput","click .sort":"onClickSortBtn","change .real-value":"onChangeFormValue","click #exportExcel,.export-excel,.export[data-action]":"onClickExport"},initialize:function(){this.lookupParamsEl=this.$(".lookup-params").first(),this.tableListEl=this.$(".data-list"),this.queryAction=this.tableListEl.data("action"),this.autoload=this.tableListEl.data("autoload"),this.initialQueryParams=this.parseInitialQueryParams(),this.initLookupParams(),this.initSortParams(),this.initPageControl(),this.initCheckOperate(),r(document).on("click","a[href]",r.proxy(function(t){if(history.replaceState){var e=r(t.target);if(e.attr("target"))return;var i=e.attr("href");if(!i||"#"===i||/^javascript:/.test(i))return;var s=t.target.href.replace(/#.*/,""),n=location.href.replace(/#.*/,"");if(s==n)return;var o=this.collectParams();o.pageIndex=this.pageControl.pageIndex;var l=encodeURI(a.stringifyQueryObject(o));history.replaceState({},"","#"+l)}},this)),this.autoload&&this.getFirstPageData()},initCheckOperate:function(){var t=this,e=function(t,e){for(var a=0;a<t.length;a++){var r=t.eq(a);r.is(":disabled")||r.is(".disabled")||(r[0].checked=e)}};this.on("checkall.tablelist",function(a,r){var i=t.$(".check-box");e(i,a),t.trigger("checkbox.tablelist",a,r)}),this.on("checkitem.tablelist",function(a,r){if(a===!1){var i=t.$(".check-box-all");e(i,a),t.trigger("checkbox.tablelist",a,r)}})},initSortParams:function(){for(var t=this.initialQueryParams,e=this.tableListEl.find(".sort[data-paramname]"),a=0;a<e.length;a++){var r=e.eq(a),i=r.data("paramname");if(i){var s=t[i];s&&(r.removeClass("none desc asc"),r.addClass(s.toLowerCase()))}}},initLookupParams:function(){for(var t=this.initialQueryParams,e=this.lookupParamsEl.find(".real-value"),a=0;a<e.length;a++){var r=e.eq(a),i=r.data("paramname")||r.data("params")||r.attr("name");if(i){var s=t[i];if(r.is(".selectpicker"))null!=s?r.val(s):r.find("option").prop("selected",!0);else if(null!=s){r.val(s);var n=r.prev(".datetimepicker-form-control");n.length>0&&n.val(s)}}}},initPageControl:function(){var t=this.tableListEl,a=null!=this.initialQueryParams.pageIndex?this.initialQueryParams.pageIndex:1,s={el:this.$(".page-control").get(0),url:this.queryAction,pageIndex:a};this.pageControl=new e(s),this.pageControl.on("next:pagecontrol prev:pagecontrol redirect:pagecontrol",r.proxy(this.refreshTableDataList,this)),this.pageControl.once("request",function(){var e='<tr><td style="text-align: center; padding: 25px 0;" colspan="100"></td></tr>',a=r(e).find("td").html(i);t.find("tbody").html(a)})},parseInitialQueryParams:function(){var t=decodeURI(location.hash.slice(1)),e=a.parseQueryString(t);return e},getFirstPageData:function(){var t=this.collectParams(),e=this.pageControl.pageIndex;this.pageControl.redirect(e,t)},polish:function(t){return t},setPageControlOptions:function(t){this.pageControl.setOptions(t)},getPageControlOptions:function(){return this.pageControl.getOptions()},refreshTableDataList:function(t,e,a,r){if(this.template){var i;i=t.length<1?'<tr class="nomore"><td style="text-align: center;" colspan="100">没有更多数据</td></tr>':this.template({list:this.polish(t)}),this.tableListEl.find("tbody").html(i),this.trigger("refreshdata.tablelist",t,e,a,r)}},collectQueryParams:function(t){for(var e=this.lookupParamsEl.find(".real-value"),a=0,i=e.length;i>a;a++)r.extend(t,s(e.eq(a)));return t},collectSortParams:function(t){var e=this.tableListEl.find("thead .sort"),a={};return r.each(e,function(t,e){var i=r(e),s=i.data("paramname"),n=i.hasClass("desc")?"DESC":i.hasClass("asc")?"ASC":"";s&&n&&(a[s]=n)}),r.extend(t,a),t},collectParams:function(){var t={};return this.collectQueryParams(t),this.collectSortParams(t),t},_queryByParams:function(){this.shouldChangePageIndex=!1;var t=this.collectParams();this.pageControl.redirect(1,t)},query:function(){this._queryByParams()},refresh:function(){var t=this.collectParams();this.pageControl.refresh(t)},checkAll:function(t,e){this.allChecked=t,this.trigger("checkall.tablelist",t,e)},checkItem:function(t,e){this.itemChecked=t,this.trigger("checkitem.tablelist",t,e)},onClickCheckbox:function(t){var e=t.target.checked,a=r(t.target);a.is(".check-box-all")?this.checkAll(e,a):this.checkItem(e,a)},onChangeFormValue:function(){this.shouldChangePageIndex=!0},onClickClearInput:function(t){r(t.target).prev().val("")},onKeyupRedirectForm:function(t){if(13===t.keyCode){if(this.shouldChangePageIndex===!0)return void this._queryByParams();var e=this.collectParams();this.pageControl.importPageIndexRedirect(e)}},onClickPageNavigateBtn:function(t){if(t.preventDefault(),this.shouldChangePageIndex===!0)return void this._queryByParams();var e=r(t.target),a=this.collectParams();e.hasClass("prev")?this.pageControl.prev(a):e.hasClass("next")?this.pageControl.next(a):e.hasClass("redirect")?this.pageControl.importPageIndexRedirect(a):e.hasClass("first-page")?this.pageControl.first(a):e.hasClass("last-page")&&this.pageControl.last(a)},onClickSortBtn:function(t){var e=r(t.currentTarget),a=this.tableListEl.find("thead .sort");a.not(e.get(0)).removeClass("desc asc").addClass("none"),e.hasClass("desc")?e.removeClass("desc").addClass("asc"):e.hasClass("asc")?e.removeClass("asc").addClass("desc"):e.removeClass("none").addClass("desc"),this._queryByParams()},onClickExport:function(t){t.preventDefault();var e=r(t.target).data("action");if(e){var i=this.tableListEl.find("tbody").children(),s=0==i.length||i.first().is(".nomore");if(!s){var n=a.format({path:e,query:this.collectParams()});window.open(n,"_download")}}}});o.extend=function(t){var e=Backbone.View.extend.apply(this,arguments);return e.prototype.events=_.extend({},this.prototype.events,t.events),e},module.exports=o});