define(function(require,exports,module){var t=require("component/popupTip"),e=require("component/areaSelect"),i=require("baseView/baseFormView"),n=(i.FormDialogView,i.SketchItemView,global_config.root),a=(global_config.resource,$("#financialAccountList").val()||null,$("#accountInfoMap").val()||null,Backbone.Model.extend({urlRoot:"./leasing-bill",idAttribute:"billingPlanUuid",initialize:function(t,e){this.businessContractUuid=e.businessContractUuid,this.subjectMatterUuid=e.subjectMatterUuid},getBillTypeZh:function(t){var e;return e="COURSEOFDEALING_LEASING_WATER_FEES"===t?"水费户号":"COURSEOFDEALING_LEASING_GAS_FEES"===t?"燃气费户号":"COURSEOFDEALING_LEASING_ELECTRICITY_FEES"===t?"电费户号":"付款帐号"},isWEG:function(t){var e;return e="COURSEOFDEALING_LEASING_WATER_FEES"===t||"COURSEOFDEALING_LEASING_GAS_FEES"===t||"COURSEOFDEALING_LEASING_ELECTRICITY_FEES"===t},fetchAccount:function(t,e){var i="./leasing-bill-account",n=this;$.ajax({url:i,type:"post",dataType:"json",data:{billType:t,businessContractUuid:this.businessContractUuid},success:function(t){n.cachcAccounts=t.data.accounts,e(t.data.accounts,t)}})},getAccount:function(t){var e=_.findWhere(this.cachcAccounts,{accountOwnerName:t});return e},saveAll:function(t){this.save({},t)}})),o=Backbone.View.extend({template:_.template($("#accountItemTmpl").html(),{variable:"obj"}),candicateAccountItemTemplate:_.template($("#candicateAccountItemTmpl").html()),className:"field-row account-field",events:{"click .delete":"onClickDelete","click .btn-add-account":"onClickChooseAccount","click .add-other-account":"onClickAddOtherAccount","click .account-item":"onClickAccountItem"},initialize:function(){this.otherAccount=$('<div class="accounts clearfix" />'),this.listenTo(this.model,"change:accountInfo",this.render),this.listenTo(this.model,"change:billType change:entryType",function(){this.model.unset("accountInfo",{silent:!0}),this.render()})},render:function(){var t=this.model.get("entryType");if("BILL_ENTRY_TYPE_ACCOUNT_PAYABLE"!=t)this.$el.detach();else{var e=this.model.toJSON();e.isWEG=this.model.isWEG(e.billType),e.title=this.model.getBillTypeZh(e.billType);var i=this.template(e);this.$el.html(i),$("#amountField").after(this.$el)}return this},onClickDelete:function(){this.model.unset("accountInfo")},onClickAccountItem:function(t){var e=$(t.currentTarget).data("accountownername")+"";if(e){var i=this.model.getAccount(e);this.model.set("accountInfo",i)}},onClickChooseAccount:function(t){var e=this.model.get("billType"),i=function(t,i){var n=this.candicateAccountItemTemplate({billType:e,accounts:t,isWEG:this.model.isWEG(e)});this.otherAccount.html(n),this.$(".field-value").append(this.otherAccount)};this.model.fetchAccount(e,$.proxy(i,this))},onClickAddOtherAccount:function(t){t.preventDefault(),this.otherAccount.remove();var e=this.model.get("billType"),i=$("#judge-leasingtype").val();this.model.isWEG(e)?window.open(n+"/subject-matter/property/"+this.model.subjectMatterUuid):"CONTRACT_LEASING_PROPERTY"==i?window.open(n+"/business-contract/leasing-contract/"+this.model.businessContractUuid):window.open(n+"/business-contract/rental-contract/"+this.model.businessContractUuid)}}),c=Backbone.View.extend({el:".bill-form-wrapper",events:{"click .submit":"onSubmit","click .invoicing":"onClickInvoicing","change [data-params=entryType]":"onChangeEntryType","change [data-params=billType]":"onChangeBillType"},initialize:function(t){c.__super__.initialize.apply(this,arguments),this.invoiceForm=this.$(".sub-form"),this.areaSelect=new e({el:this.$(".area-select")}),this.defineValidator(),this.model=new a({entryType:this.$("[data-params=entryType]").val(),billType:this.$("[data-params=billType]").val()},{businessContractUuid:this.$("#businessContractUuid").val(),subjectMatterUuid:this.$("#subjectMatterUuid").val()}),this.accountFieldView=new o({model:this.model})},defineValidator:function(){this.validator=this.$(".form").validate({ignore:".hide [name]",rules:{billEffectiveDate:"required",billMaturityDate:"required",billTradeDate:"required",mobile:"mobile",amount:"nonNegativeInteger"},success:function(t,e){var i=$(e).parent();i.is(".imitate-datetimepicker-input")&&(e.value?i.removeClass("error"):i.addClass("error"))},errorPlacement:function(t,e){var i=e.parent();i.is(".parcel-input")?t.insertAfter(i):i.is(".imitate-datetimepicker-input")||t.insertAfter(e)}})},validate:function(){var t=this.validator.form(),e=!0,i=this.model.get("entryType");this.$('input[name="amount"]');if("BILL_ENTRY_TYPE_ACCOUNT_PAYABLE"===i){var n=this.model.get("accountInfo");e=!_.isEmpty(n),e?this.$(".btn-add-account").removeClass("error"):this.$(".btn-add-account").addClass("error")}return t&&e},getBillType:function(){var t=this.$('[data-params="billType"]').val();return t},onSubmit:function(e){if(e.preventDefault(),this.validate()){var i={};this.$("[data-params]").each(function(){var t=$(this).data("params"),e=$(this).val();i[t]=e}),i.billEffectiveDate=this.$('input[name="billEffectiveDate"]').val(),i.billMaturityDate=this.$('input[name="billMaturityDate"]').val(),i.billTradeDate=this.$('input[name="billTradeDate"]').val(),i.contractUuid=this.$('input[name="contractUuid"]').val();var n={};n.taxType=this.$('input[name="invoice-type"]').val(),n.invoiceTitle=this.$('input[name="invoiceTitle"]').val(),n.addressee=this.$('input[name="addressee"]').val(),n.mobile=this.$('input[name="mobile"]').val(),n.provinceCode=this.$('select[name="provinceCode"]').val(),n.cityCode=this.$('select[name="cityCode"]').val(),n.areaCode=this.$('select[name="areaCode"]').val(),n.address=this.$('input[name="address"]').val(),n.postcode=this.$('input[name="postcode"]').val(),i.taxInfo=n,this.model.set(i),this.model.saveAll({success:function(e,i){if(0!=i.code){i.data;t.show("参数非法！")}else{var n=i.data.businessContractUuid;t.once("closedialog",function(){"undefined"!=typeof n&&(location="./leasing-bill-list/index?businessContractUuid="+n)}),t.show("成功！")}}})}},onClickInvoicing:function(t){var e=t.target.checked;e?this.invoiceForm.removeClass("hide"):this.invoiceForm.addClass("hide")},onChangeEntryType:function(t){var e=$(t.target).find("option:selected").text();"付费账单（应付）"==e?(this.$(".pay-data").html("应付日期"),this.$(".pay-money").html("应付金额")):(this.$(".pay-data").html("应收日期"),this.$(".pay-money").html("应收金额")),this.$(".hd").text(e);var i=$(t.target).val();this.model.set("entryType",i)},onChangeBillType:function(t){var e=this.getBillType();this.model.set("billType",e)}});exports.EditBillView=c});