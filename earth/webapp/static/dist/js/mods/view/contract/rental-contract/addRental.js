define(function(require,exports,module){var e=require("scaffold/util").validateUtil,t=require("component/dialogView"),i=require("component/popupTip"),a=require("entity/contract/rentalContractModel").RentalContractModel,n=require("baseView/baseFormView").BaseFormView,o=require("./attachmentInfo"),s=require("./lesseeInfo"),r=require("./rentInfo"),l=require("./contractDeadline"),c=jQuery;c.validator.addMethod("varyCertificates",function(t,i){var a=c(i).prev("[name=certificateType]").val();return 0==a?this.optional(i)||e.isIDCardValid(t):!0},"请输入正确的证件号");var d=n.extend({el:".rental-form-wrapper",initSubView:function(){var e=this.model,t=this;this.contractDeadlineView=new l({el:this.$(".contract-deadline-info"),model:e.contractBasicInfo,sourceModel:e}),this.contractDeadlineView.on("payperiod:clear",function(){t.rentView.clearWritedStage()}),this.lesseeView=new s({el:this.$(".lessee-info"),model:e.renterInfo,sourceModel:e}),this.rentView=new r({el:this.$(".rent-info"),model:e.paymentInfo,sourceModel:e}),this.attachmentView=new o({el:this.$(".attachment-info"),model:e.attachmentInfo,sourceModel:e})},initValidator:function(){this.validator=this.$(".downstream-leasee-form").validate({ignore:".hide [name]",onsubmit:!1,rules:{issueTime:"required",effectiveTime:"required",maturityTime:"required",certificateNo:{varyCertificates:!0},depositeAmount:{money:!0},mobile:{mPhoneExt:!0}},success:function(e,t){var i=c(t).parent();i.is(".imitate-datetimepicker-input")&&(t.value?i.removeClass("error"):i.addClass("error"))},errorPlacement:function(e,t){var i=t.parent();i.is(".parcel-input")?e.insertAfter(i):i.is(".imitate-datetimepicker-input")||e.insertAfter(t)}})},initialize:function(e){d.__super__.initialize.apply(this,arguments),this.model=new a,"string"==typeof e&&this.model.set({businessContractUuid:e}),this.model.fillInternalModel(JSON.parse(this.$("#hiddenModelAttr").val())),this.initSubView(),this.initValidator(),this.succDialogView=new t,this.listenTo(this.succDialogView,"goahead",function(e){location="../rental-contract-view/"+e}).listenTo(this.succDialogView,"closedialog",function(e){"undefined"==typeof e?location="../rental-contract-list/index":location="../rental-contract-view/"+e})},validate:function(){var e=this.validator.form(),t=this.contractDeadlineView.validate(),i=this.lesseeView.validate(),a=this.rentView.validate(),n=this.attachmentView.validate();return t&&i&&a&&n&&e},submitHandler:function(e){if(!this.validate())return void this.trigger("invalid");this.contractDeadlineView.save(),this.lesseeView.save(),this.rentView.save(),this.attachmentView.save();var t=this.succDialogView;this.model.saveAll({success:function(e,a){0==a.code?t.show("成功录入租约!",a.data.businessContractUuid):i.show(a.message)}})}});exports.AddRentalView=d});