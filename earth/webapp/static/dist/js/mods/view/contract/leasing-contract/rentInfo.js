define(function(require,exports,module){var e=require("component/areaSelect"),t=require("component/popupTip"),a=require("baseView/baseFormView"),i=require("entity/contract/leasingContractModel").PayStageItemModel,r=require("entity/contract/leasingContractModel").ExtraRuleItemModel,n=a.FieldsetView,o=a.SketchItemView,l=a.FormDialogView,s=jQuery,d=o.extend({template:_.template(s("#payStageItemTmpl").html()),initialize:function(){d.__super__.initialize.apply(this,arguments);var e=this,t=this.errorLabel=s('<label class="error-abnormal" for="">');this.listenTo(this.model,"payperiod:validate",function(a,i){a?(e.$el.removeClass("error"),t.remove()):e.$el.addClass("error").after(t.show().html(i))})},toDelete:function(e){var t=s(e.target);t.hasClass("disabled")||t.attr("disabled")||this.modelIsLast()&&this.model.destroy()},toEdit:function(){var e=new h({model:this.model});e.show()},remove:function(){this.errorLabel.remove(),d.__super__.remove.apply(this,arguments)}}),m=o.extend({template:_.template(s("#extraRuleItemTmpl").html()),toEdit:function(){var e=new u({model:this.model});e.show()},render:function(){var e=this.model.toJSON(),t=this.model.getAllClauseTypes(),a=_.findWhere(t,{value:e.clauseType});e.clauseTypeAlias=a.name;var i=this.template(e);return this.$el.html(i),this}}),c=l.extend({className:"modal fade form-modal contract-date-limit",initialize:function(){c.__super__.initialize.apply(this,arguments),this.datepicker=this.$(".beginend-datepicker"),this.initValidator()},initValidator:function(){this.validator=this.$(".form").validate({ignore:"input:disabled",rules:{amountPerMonth:{positiveNumber:!0}},onfocusout:!1,onkeyup:!1,errorPlacement:function(e,t){var a=t.parent();a.is(".parcel-input")?e.insertAfter(a):t.is("[name=paymentPeriod]")||e.insertAfter(t)}})},remove:function(){var e=this.datepicker.data("datepicker");e&&e.remove(),c.__super__.remove.apply(this,arguments)},validate:function(e){var t=this.validator.form();return t},submitHandler:function(e){var t=this._extractDomData(this.$(".real-value"),!0);this.validate(t)&&(this.model.set(t),this.hide())}}),h=c.extend({template:_.template(s("#editPayStageTmpl").html(),{variable:"obj"}),render:function(){var e=this.model,t=e.collection,a=e.toJSON();a.limitDate={},t?a.limitDate={startDate:!1,endDate:t.last()===e}:a.limitDate={startDate:a.startDate&&!1,endDate:!0},this.$el.html(this.template(a))},validate:function(e){var t=this.validator.form(),a=!0,i=this.$(".starttime-datepicker"),r=this.$(".endtime-datepicker");if(e.startDate?i.removeClass("error"):(a=!1,i.addClass("error")),e.endDate?r.removeClass("error"):(a=!1,r.addClass("error")),!a)return a&&t;var n=this.model.getContractDeadLine(),o=this.$("#deadline_error");o.length<1&&(o=s('<label id="deadline_error" class="error-abnormal">'));var l=n.effectiveTime&&new Date(n.effectiveTime)>new Date(e.startDate),d=n.maturityTime&&new Date(n.maturityTime)<new Date(e.endDate);return l||d?(a=!1,l?i.addClass("error"):i.removeClass("error"),d?r.addClass("error"):r.removeClass("error"),this.$(".datetimepick-wrapper").after(o.html("不能超过合同期限("+n.effectiveTime+"至"+n.maturityTime+")"))):(o.remove(),i.removeClass("error"),r.removeClass("error")),a?a&&t:a&&t},_validatePeriodMonth:function(e){if(!e.paymentPeriod)return!1;var t=new Date(e.startDate),a=new Date(e.endDate),i=(a.getFullYear()-t.getFullYear(),a.getMonth()-t.getMonth()+1,this.$("#paymentPeriodLimit_error"));return i.length<1&&(i=s('<label id="paymentPeriodLimit_error" class="error-abnormal">')),this.$("[name=paymentPeriod]").removeClass("error"),i.remove(),!0}}),u=c.extend({template:_.template(s("#editExtraRuleTmpl").html(),{variable:"obj"}),events:{"click [name=fixed]":"onClickFixed","change [name=paymentPeriod]":"onChangePaymentPeriod"},onChangePaymentPeriod:function(e){var t=this.$('[name="payDayInMonth"]'),a=t.find("option").first();-1==s(e.target).val()?(a.get(0).selected=!0,t.get(0).disabled=!0):t.get(0).disabled=!1},onClickFixed:function(e){var t=e.target.checked,a=this.$("[name=amountPerMonth]");t?(a.val(""),a.get(0).disabled=!0):a.get(0).disabled=!1},render:function(){var e=this.model.toJSON();e.clauseTypes=this.model.getRemainClauseTypes();var t=this.template(e);return this.$el.html(t),this}}),v=n.extend({events:{"click .invoicing":"invoicingHandler","click .add-pay-stage":"beforeAddSketchViewHandler","click .add-extra-rule":"beforeAddSketchViewHandler"},initialize:function(t){v.__super__.initialize.apply(this,arguments),this.invoiceForm=this.$(".sub-form");new e({el:this.$(".area-select")});this.sourceModel=t.sourceModel;var a=this.payStageCollection=new Backbone.Collection(this.model.get("rentingIntervalList"),{model:i,sourceModel:t.sourceModel});this.listenTo(a,"add",this.addOnePayStage),this.listenTo(a,"all",function(){this.model.set("rentingIntervalList",a.toJSON())});var n=this.extraRuleCollection=new Backbone.Collection(this.model.get("supplementaryTermInfo").supplementaryTermList,{model:r});this.listenTo(n,"add",function(e){this.addOneExtraRule(e),this.isRemainClauseType()||this.$(".add-extra-rule").parent().hide()}),this.listenTo(n,"remove",function(e){this.$(".add-extra-rule").parent().show()}),this.listenTo(n,"all",function(){var e=this.model.get("supplementaryTermInfo");e.supplementaryTermList=n.toJSON(),this.model.set("supplementaryTermInfo",e)}),this.addAllPayStage(),this.addAllExtraRule()},isRemainClauseType:function(){var e=new r({},{collection:this.extraRuleCollection});return 0!=e.getRemainClauseTypes().length},addOnePayStage:function(e){var t=new d({model:e});this.$(".paystages").append(t.render().$el),this.$(".add-pay-stage").removeClass("error")},addAllPayStage:function(){for(var e=this.payStageCollection,t=0,a=e.length;a>t;t++)this.addOnePayStage(e.at(t));this.isRemainClauseType()||this.$(".add-extra-rule").parent().hide()},addOneExtraRule:function(e){var t=new m({model:e});this.$(".extrarules").append(t.render().$el),this.$(".add-extra-rule").removeClass("error")},addAllExtraRule:function(){for(var e=this.extraRuleCollection,t=0,a=e.length;a>t;t++)this.addOneExtraRule(e.at(t))},clearWritedStage:function(){for(var e=this.payStageCollection;e.length;)e.last().destroy()},beforeAddSketchViewHandler:function(e){e.preventDefault();var t=s(e.target),a=this.sourceModel,i=a.contractBasicInfo.toJSON();return i&&i.effectiveTime&&i.maturityTime?void(t.is(".add-pay-stage")?this.addPayStageHandler():t.is(".add-extra-rule")&&this.addExtraRuleHandler()):(a.trigger("contractdate:lack"),void(location.href="#contractDeadlineAnchor"))},addExtraRuleHandler:function(){var e=this.extraRuleCollection,t=this.sourceModel.contractBasicInfo.toJSON(),a={};a.startDate=t.effectiveTime,a.endDate=t.maturityTime;var i=new r(a,{collection:e}),n=new u({model:i});i.once("change",function(){e.add(i)}),n.show()},addPayStageHandler:function(){var e=this.sourceModel.contractBasicInfo.toJSON(),a=this.payStageCollection,r=a.last(),n={};if(r&&r.get("endDate")===e.maturityTime)return void t.show("合同期限已满");if(r){var o=new Date(r.get("endDate"));o.setDate(o.getDate()+1),n.startDate=o.format("yyyy-MM-dd"),n.endDate=e.maturityTime,n.payDayInMonth=r.get("payDayInMonth")}else n.startDate=e.effectiveTime,n.endDate=e.maturityTime;var l=new i(n,{sourceModel:this.sourceModel}),s=new h({model:l});l.once("change",function(){a.add(l)}),s.show()},invoicingHandler:function(e){var t=e.target.checked;t?this.invoiceForm.removeClass("hide"):this.invoiceForm.addClass("hide")},extractDomData:function(){var e=(this.invoiceForm.get(0),this.$(".real-value").not(function(){return s(this).parents(".sub-form").length>0})),t=this._extractDomData(e,!0),a=this.getInvoicingData();return a&&(t.taxInfo=a),t},getInvoicingData:function(){var e=this.$(".invoicing")[0].checked;if(e){var t=this._extractDomData(this.invoiceForm.find(".form-control"),!0);return t.taxType=this.invoiceForm.find("[name=invoice-type]:checked").val(),t}},validate:function(){var e=!0,t=!0,a=!0;return this.$(".paystages").children(".item").length>0?this.$(".add-pay-stage").removeClass("error"):(this.$(".add-pay-stage").addClass("error"),e=!1),e?(t=this.validateStage(this.payStageCollection),e&&t&&a):void 0},validateStage:function(e){for(var t=!0,a=0,i=e.length;i>a;a++)e.at(a).validateStageDate()||(t=!1);if(!t)return t;var r=e.first().isEqualContractStartDate(),n=e.last().isEqualContractEndDate();return t&&r&&n},save:function(){var e=this.extractDomData();e.taxInfo||this.model.unset("taxInfo"),this.model.set(e)}});module.exports=v});