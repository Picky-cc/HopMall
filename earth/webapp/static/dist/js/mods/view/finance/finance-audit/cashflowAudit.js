define(function(require,exports,module){require("component/autocomplete");var t=(require("scaffold/util"),require("scaffold/path")),e=require("baseView/tableContent"),i=require("component/dialogView"),n=require("component/popupTip"),o=(require("baseView/baseFormView").FormDialogView,require("entity/finance/cashflowModel").CashflowModel,require("entity/finance/cashflowModel").CashflowCollection),a=require("./sidebarBillSelect"),l=require("./markCashType"),c=require("./cashManipulateLog"),s=require("./showCreateBill"),r=require("./exportData").ExportKingDeeDataView,u=require("./exportData").ExportYonYouDataView,h=require("./addCashFlow"),d=(global_config.root,jQuery),m=(d(document.body),global_const.loadingImg),p=Backbone.View.extend({tagName:"tr",className:"bill-card-box",template:_.template(d("#billCardTmpl").html()),itemTemplate:_.template(d("#billCardItemTmpl").html()),events:{"click .submit":"onClickSubmit","click .add-bill":"onClickAddBill","click .check-bill":"onClickCheckBill","blur .reconcile-money-input":function(t){this.auditInputReconcile(d(t.target))},"click .show-create-bill":"onClickCreateBill"},initialize:function(){this.on("validate:reconcile",function(t){t.flag?(t.el.val(t.reconcileMoney.toFixed(2)),this.updateSummary()):this.toastErrorTip(t.el,t.message)}),this.listenTo(this.model,"request",this.wating),this.listenTo(this.model,"sync",this.render),this.listenTo(this.model,"change:auditStatus",function(t,e){"CLOSE"==e&&this.model.foldIn()}),this.listenTo(this.model,"bill:search",function(t,e){0==e.code?this.model.existBill(t.billingPlanUuid)?n.show("订单已在列表中"):this.model.addBill(t):n.show(e.message)}),this.listenTo(this.model,"bill:add",function(t){this.computeBillItemData(t,this.model.get("mode"));var e=this.$(".record-list"),i=this.itemTemplate({item:t,app:this.model.get("app")});e.append(i),this.updateSummary()}),this.listenTo(this.model,"bill:submit",function(t){0==t.code?(this.model.setMode("match"),this.model.foldOut()):n.show(t.message)}),this.listenTo(this.model,"totalbookingAmount:invalid",function(t,e){n.show(t)})},wating:function(){var t=d('<td colspan="1000" style="text-align: center;">');t.append(m.clone()),this.$el.html(t)},detach:function(){this.$el.detach()},render:function(){var t=this.model.toJSON(),e="";"match"==t.mode&&"CLOSE"==t.auditStatus?e='<td colspan="1000" style="text-align: center;">没有数据</td>':(t=this.computeData(t),e=this.template(t)),this.$el.html(e)},computeBillItemData:function(t,e){var i=function(t){var i;i=t.receivableAmount-("match"===e?t.settlementAmount:t.currentSpecificAmount),d.isNumeric(i)||(i=t.receivableAmount),t.subtractAmount=Math.min(i,this.model.get("amount"))},n=function(t){var e=[],i=[],n=t.showData.accountAndNameMap||{};d.each(n,function(t,n){e.push(t),i.push(n)}),t.showData.accountName=i.join(", "),t.showData.accountNo=e.join(", ")};if(null==t.receivableAmount)throw"该条记录错误，没有应付金额";null==t.settlementAmount&&(t.settlementAmount=0),null==t.currentSpecificAmount&&(t.currentSpecificAmount=0),i.call(this,t),n.call(this,t)},computeData:function(t){for(var e=t.records||[],i=0,n=0,o=e.length;o>n;n++){var a=e[n];this.computeBillItemData(a,t.mode),"VOUCHER_ISSUED"==a.journalVoucherStatus&&(i+=+("undefined"!=typeof a.bookingAmount?a.bookingAmount:a.subtractAmount))}return t.totalDebitAmount=i.toFixed(2),t},updateSummary:function(){var t=function(){var t=0;return this.$(".record-item").each(function(e,i){var n=d(i);if(n.find(".check-bill").get(0).checked){var o=+n.find(".reconcile-money-input").val();isNaN(o)||(t+=o)}}),t},e=t.call(this),i=this.model.get("amount")-e;this.$(".summary .money").html(e.toFixed(2)),this.$(".summary .balance-money").html(i.toFixed(2))},popupSidebar:function(t){var e=this,i=new a(t);i.on("sidebar:selecedbill",function(t){e.model.searchBill({billingPlanUuid:t})}).on("sidebar:createbill",function(t){e.popupCreateBillView(t)}),i.show().slideIn("right",200)},auditInputReconcile:function(t){var e=+t.data("subtractvalue"),i=+t.val().trim(),n={el:t,reconcileMoney:i};return isNaN(i)?(n.message="请输入正确的金额",n.flag=!1,this.trigger("validate:reconcile",n),n):i>e?(n.message="对账金额不能大于默认金额",n.flag=!1,this.trigger("validate:reconcile",n),n):0>=i?(n.message="对账金额应大于0",n.flag=!1,this.trigger("validate:reconcile",n),n):(n.flag=!0,this.trigger("validate:reconcile",n),n)},toastErrorTip:function(t,e){var i=t.prev(".error"),n=12*e.length+30;i.length<1?(i=d('<span class="error">'+e+"</span>"),t.before(i)):i.html(e),i.width(n).addClass("anim-fadeIn");var o=t.data("timer");o&&clearTimeout(o),o=setTimeout(function(){i.fadeOut(500,function(){i.remove()})},4e3),t.data("timer",o)},validate:function(){var t=!0,e=this,i=this.getCheckedRecordItem();return i.length<1?t:(i.each(function(i,n){var o=e.auditInputReconcile(d(n).find(".reconcile-money-input"));o.flag||(t=!1)}),t)},getCheckedRecordItem:function(){var t=this.$(".record-item .check-bill:checked").parents(".record-item");return t},popupCreateBillView:function(t){var e=this.$(".balance-money").text();if(0>=+e)return void n.show("剩余对账金额小于等于0时无法再进行制单操作");t=d.extend({},{appId:this.model.getAppId(),cashFlowTime:this.model.get("time"),accountSide:this.model.get("accountSide"),balanceMoney:e},t);var i=new Date(t.cashFlowTime),o=i.getFullYear(),a=i.getMonth(),l=new Date;l.setFullYear(o,a,1),t.billEffectiveDate=l;var c=new Date;c.setFullYear(o,a+1,1),c.setDate(c.getDate()-1),t.billMaturityDate=c;var r=new Backbone.Model(t),u=new s({model:r}),h=this;r.once("change",function(t){h.model.searchBill({billingPlanNumber:t.get("billingPlanNumber")})}),u.show()},onClickCreateBill:function(t){t.preventDefault();var e=this.model.get("records")[0],i={subjectMatterSourceNo:e?e.showData.subjectMatterSourceNo:""};this.popupCreateBillView(i)},onClickSubmit:function(t){if(this.validate()){var e=this.getCheckedRecordItem(),i=d.map(e,function(t){var e=d(t);return{billingPlanUuid:e.data("billing_plan_uuid"),bookingAmount:e.find(".reconcile-money-input").val()}});this.model.validateBill(i)&&this.model.submitBill(i)}},onClickCheckBill:function(t){var e=d(t.target).parents(".record-item").find(".reconcile-money-input");t.target.checked?e.removeClass("default"):e.addClass("default"),this.auditInputReconcile(e)},onClickAddBill:function(t){t.preventDefault(),this.popupSidebar({appId:this.model.getAppId(),cashFlowTime:this.model.get("time"),keyWord:this.model.get("payName")?this.model.get("payName").slice(0,4):""})}}),f=Backbone.View.extend({tagName:"tr",className:"bill-item",template:_.template(d("#cashflowItemTmpl").html()),events:{"click .cancel-bill":"onClickCancelBill","click .regulate-bill":"onClickRegulateBill","click .expand-bill":"onClickExpandBill","click .mark-bill":"onClickMarkBill","click .detail-bill":"onClickDetailBill"},initialize:function(t){this.billCardView=new p({model:this.model}),this.cancelDialog=new i({bodyInnerTxt:"取消对账后，系统将不为当前流水匹配账单，请确认"}),this.listenTo(this.cancelDialog,"goahead",function(t){this.model.cancel()}),this.initModel()},initModel:function(){this.listenTo(this.model,"change:auditStatus",this.render),this.listenTo(this.model,"change:markInfo",function(t,e){this.$(".mark-type").text(e.financialAccountAlias)}),this.listenTo(this.model.collection,"reset",function(){this.remove(),this.billCardView.remove()}),this.listenTo(this.model,"foldin",function(){this.$el.removeClass("z-active"),this.billCardView.detach()}),this.listenTo(this.model,"foldout",function(){this.$el.addClass("z-active"),this.$el.after(this.billCardView.$el)}),this.listenTo(this.model,"cancel",function(t){this.cancelDialog.hide(),0!=t.code&&n.show(t.message)})},render:function(){var t=this.model.toJSON(),e=this.template({appArriveRecord:t});this.$el.html(e)},onClickCancelBill:function(t){t.preventDefault(),this.cancelDialog.show()},onClickRegulateBill:function(t){t.preventDefault(),this.model.regulate()},onClickExpandBill:function(t){t.preventDefault(),this.model.toggle()},onClickMarkBill:function(t){t.preventDefault();var e=function(t,e){if(0==t.code){var i=new l({model:e});i.show()}else n.show(t.message)};this.model.fetchMarkInfo(e)},onClickDetailBill:function(t){t.preventDefault();var e=function(t,e){if(0==t.code){var i=new c({className:"modal fade table-modal",title:"流水操作详情",excludeGoahed:!0,model:e});i.show()}else n.show(t.message)};this.model.fetchLog(e)}}),g=e.extend({events:{"change #appIdSelect":"onChangeAppId","change .account-info":"onClickAccountInfo","change [name=accountNo]":"onChangeAccountNo","click #allExpand":"onClickAllExpand","click #exportKingDeeVoucher":"onClickExportKingDeeVoucher","click #exportYonYouVoucher":"onClickExportYonYouVoucher","click #exportAppArriveRecord":"onClickExportAppArriveRecord","click #addCashFlow":"onAddCashFlow"},actions:{trade_parties:"./query-trade-parties",account:"./list-account-accountName?type=appId",export_apparrive_record:"./export-apparrive-record"},initialize:function(t){this.accountSide=t,this.allExpandEl=this.$("#allExpand"),this.initCollection(),this.initFinancialAccount(),this.initAutoComplete(),g.__super__.initialize.apply(this,arguments)},initAutoComplete:function(){var t=this,e=this.$('[name="queryKeyWord"]'),i={action:this.actions.trade_parties,container:this.$(".auto-complete-list"),parse:function(e){if(0==e.code){var i=[],n=[];return _.each(e.data.tradeParties,function(t,e){var o={};o.name=e,o.isHost=0==t,o.isHost?i.push(o):n.push(o)}),"debit"===t.accountSide?n.concat(i):i.concat(n)}return[]},search:function(e){return{appId:t.getAppId(),keyWord:e}},parcelItem:function(t){var e;return e=t.isHost?"<li class='item'><span>"+t.name+"</span><span style='color: #ff7500'>（房东）</span></li>":"<li class='item'><span>"+t.name+"</span></li>"},onSync:function(t,e,i){t.length<1&&i.hide()},onSubmit:function(e,i,n){var o=i.find("span").first().text();"enter"==n?e.val(o):"click"==n&&e.val(o.slice(0,4)),t.query()}};e.autocomplete(i)},initCollection:function(){this.collection=new o,this.listenTo(this.collection,"reset",function(t,e){var i;if(t.length<1)i='<tr><td style="text-align: center;" colspan="100">没有更多数据</td></tr>';else{i=[];for(var n=0,o=t.length;o>n;n++){var a=new f({model:t.at(n)});a.render(),i.push(a.el)}}this.tableListEl.find(" > tbody").html(i)})},initFinancialAccount:function(){var t=this.collection.getMarkTypes(),e="";d.each(t,function(t,i){e+='<option value="'+t+'">'+i+"</option>"}),this.$("[name=financialAccountName]").append(e)},getAppId:function(){return this.$('[name="appId"]').val()},polish:function(t){var e=this.accountSide;return t.forEach(function(t){t.accountSide=e}),t},refreshTableDataList:function(t,e,i,n){if(this.allExpandEl.html("全部展开"),t.length<1)this.collection.reset();else{var o=this.polish(t);this.collection.reset(o)}this.trigger("refreshdata.tablelist")},onClickAllExpand:function(t){t.preventDefault(),this.collection.isAllShow?(this.allExpandEl.html("全部展开"),this.collection.foldIn()):(this.allExpandEl.html("全部收起"),this.collection.foldOut())},onChangeAccountNo:function(t){var e=d(t.target).find(":selected"),i=e.data("attr")||{};"cash"===i.type?this.$("#addCashFlow").show():this.$("#addCashFlow").hide()},onClickAccountInfo:function(t){var e=d(t.target),i=e.find(":selected"),n=i.data("id"),o=function(t){var e=t.get(0).options;d.each(e,function(t,e){var i=d(e).data("id");return i===n?void(e.selected=!0):void 0})};e.is("#accountNo")?o(this.$("#accountName")):e.is("#accountName")&&o(this.$("#accountNo")),this._queryByParams()},onChangeAppId:function(t){var e=this,i=d(t.target).val(),n='<option value="">银行账户号</option>',o='<option value="">银行账户名</option>';if(!i)return this.$("#accountNo").html(n),void this.$("#accountName").html(o);var a={url:this.actions.account,type:"post",dataType:"json",data:{appId:i}};a.success=function(t){0==t.code&&(t.data.accountList.forEach(function(t){n+='<option data-id="'+t.id+'" value="'+t.accountNo+'">'+t.accountShortName+"</option>",o+='<option data-id="'+t.id+'" value="'+t.accountName+'">'+t.accountName+"</option>"}),e.$("#accountNo").html(n),e.$("#accountName").html(o))},d.ajax(a)},onClickExportKingDeeVoucher:function(t){t.preventDefault();var e,i;i=this.collectParams(),i.accountSide=this.accountSide,e=new r({query:i}),e.show()},onClickExportYonYouVoucher:function(t){t.preventDefault();var e,i;i=this.collectParams(),i.accountSide=this.accountSide,e=new u({query:i}),e.show()},onClickExportAppArriveRecord:function(e){e.preventDefault();var i,n;n=this.collectParams(),n.accountSide=this.accountSide,i=t.format({path:this.actions.export_apparrive_record,query:n}),location.assign(i)},onAddCashFlow:function(t){t.preventDefault();var e,i,o=this;i=this.collectParams(),i.accountSide=this.accountSide,e=new h({query:i}),e.once("sync:save",function(t){0==t.code?(n.show("添加成功！"),o.refresh()):n.show(t.message)}),e.show()}});exports.CashflowDebitView=g});