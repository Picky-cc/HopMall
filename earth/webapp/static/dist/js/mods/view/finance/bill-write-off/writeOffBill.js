define(function(require,exports,module){var e=(require("scaffold/util"),require("scaffold/path"),require("baseView/tableContent")),t=require("component/dialogView"),i=require("component/popupTip"),l=(require("baseView/baseFormView").FormDialogView,require("entity/finance/billWriteOffModel").BillWriteOffModel,require("entity/finance/billWriteOffModel").BillWriteOffCollection),n=require("./writeOffBillManipulate").ManipulateLogView,o=(global_config.root,jQuery),a=(o(document.body),global_const.loadingImg),c=Backbone.View.extend({tagName:"tr",className:"bill-card-box",template:_.template(o("#billCardTmpl").html()),events:{"click .submit":"onClickSubmit","click .check-bill":"onClickCheckBill","blur .reconcile-money-input":function(e){this.auditInputReconcile(o(e.target))}},initialize:function(){this.on("validate:reconcile",function(e){e.flag?e.el.val(e.reconcileMoney.toFixed(2)):this.toastErrorTip(e.el,e.message),this.updateSummary()}),this.listenTo(this.model,"request",this.wating),this.listenTo(this.model,"sync",this.render),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"bill:submit",function(e){0!=e.code&&i.show(e.message),this.model.refresh()}),this.listenTo(this.model,"totaloffSetAmount:invalid",function(e,t){i.show(e)})},wating:function(){var e=o('<td colspan="1000" style="text-align: center;">');e.append(a.clone()),this.$el.html(e)},detach:function(){this.$el.detach()},render:function(){var e=this.model.toJSON(),t="";e=this.computeData(e),t=this.template(e),this.$el.html(t)},computeBillItemData:function(e,t){if(null==e.amount)throw"该条记录错误，没有应付金额";e.subtractAmount=e.remainderAmount},computeData:function(e){for(var t=e.records||[],i=0,l=0,n=t.length;n>l;l++){var o=t[l];this.computeBillItemData(o,e.mode),i+=+("undefined"!=typeof o.writeOffAmount?o.writeOffAmount:o.remainderAmount)}return e.totalDebitAmount=i.toFixed(2),e},updateSummary:function(){var e=function(){var e=0;return this.$(".record-item").each(function(t,i){var l=o(i);if(l.find(".check-bill").get(0).checked){var n=+l.find(".reconcile-money-input").val();isNaN(n)||(e+=n)}}),e},t=e.call(this),i=this.model.get("canTotalWriteOffAmount")-t;this.$(".summary .money").html(t.toFixed(2)),this.$(".summary .balance-money").html(i.toFixed(2))},auditInputReconcile:function(e){var t=+e.data("subtractvalue"),i=+e.val().trim(),l={el:e,reconcileMoney:i};return isNaN(i)?(l.message="请输入正确的金额",l.flag=!1,this.trigger("validate:reconcile",l),l):i>t?(l.message="冲销金额不能大于默认金额",l.flag=!1,this.trigger("validate:reconcile",l),l):0>=i?(l.message="冲销金额应大于0",l.flag=!1,this.trigger("validate:reconcile",l),l):(l.flag=!0,this.trigger("validate:reconcile",l),l)},toastErrorTip:function(e,t){var i=e.prev(".error"),l=12*t.length+30;i.length<1?(i=o('<span class="error">'+t+"</span>"),e.before(i)):i.html(t),i.width(l).addClass("anim-fadeIn");var n=e.data("timer");n&&clearTimeout(n),n=setTimeout(function(){i.fadeOut(500,function(){i.remove()})},4e3),e.data("timer",n)},validate:function(){var e=!0,t=this,i=this.getRecordItemEls();return i.checkeds.each(function(i,l){var n=t.auditInputReconcile(o(l).find(".reconcile-money-input"));n.flag||(e=!1)}),e},getRecordItemEls:function(){var e={},t=this.$(".record-item .check-bill");return e.checkeds=t.filter(":checked").parents(".record-item")||[],e.uncheckeds=t.not(":checked").parents(".record-item")||[],e},onClickSubmit:function(e){if(this.validate()){var t=this.getRecordItemEls(),i=o.map(t.checkeds,function(e){var t=o(e);return{billingPlanUuid:t.data("billing_plan_uuid"),offSetAmount:t.find(".reconcile-money-input").val()}}),l=o.map(t.uncheckeds,function(e){var t=o(e);return t.data("billing_plan_uuid")});this.model.validateBill(i)&&this.model.submitBill(i,l)}},onClickCheckBill:function(e){var t=o(e.target).parents(".record-item").find(".reconcile-money-input");e.target.checked?t.removeClass("default"):t.addClass("default"),this.auditInputReconcile(t)}}),s=Backbone.View.extend({tagName:"tr",className:"bill-item",template:_.template(o("#billWriteOffItemTmpl").html()),events:{"click .expand-bill":"onClickExpandBill","click .regulate-bill":"onClickRegulateBill","click .cancel-bill":"onClickCancelBill","click .detail-bill":"onClickDetailBill"},initialize:function(e){this.billCardView=new c({model:this.model}),this.cancelDialog=new t({bodyInnerTxt:"取消冲销后，将不会为你显示该账单，请确认"}),this.listenTo(this.cancelDialog,"goahead",function(e){this.model.cancel(e)}),this.initModel()},initModel:function(){this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"refresh",function(e){0!=e.code&&i.show(e.message),this.model.foldIn(),this.render()}),this.listenTo(this.model.collection,"reset",function(){this.remove(),this.billCardView.remove()}),this.listenTo(this.model,"foldin",function(){this.$el.removeClass("z-active"),this.billCardView.detach()}),this.listenTo(this.model,"foldout",function(){this.$el.addClass("z-active"),this.$el.after(this.billCardView.$el)}),this.listenTo(this.model,"cancel",function(e){this.cancelDialog.hide(),0!=e.code&&i.show(e.message)})},render:function(){var e=this.model.toJSON(),t=this.template({data:e});this.$el.html(t)},onClickCancelBill:function(e){e.preventDefault(),this.cancelDialog.show()},onClickRegulateBill:function(e){e.preventDefault(),this.model.regulate()},onClickExpandBill:function(e){e.preventDefault(),this.model.toggle()},onClickDetailBill:function(e){e.preventDefault();var t=function(e,t){if(0==e.code){var l=new n({className:"modal fade table-modal",title:"冲销操作详情",excludeGoahed:!0,model:t});l.show()}else i.show(e.message)};this.model.fetchLog(t)}}),r=e.extend({events:{"click #allExpand":"onClickAllExpand"},initialize:function(e){this.billEntryType=e,this.allExpandEl=this.$("#allExpand"),this.initCollection(),r.__super__.initialize.apply(this,arguments)},initCollection:function(){this.collection=new l,this.listenTo(this.collection,"reset",function(e,t){var i;if(e.length<1)i='<tr><td style="text-align: center;" colspan="100">没有更多数据</td></tr>';else{i=[];for(var l=0,n=e.length;n>l;l++){var o=new s({model:e.at(l)});o.render(),i.push(o.el)}}this.tableListEl.find(" > tbody").html(i)})},polish:function(e){var t=this.billEntryType;return e.forEach(function(e){e.billEntryType=t}),e},refreshTableDataList:function(e,t,i,l){if(this.allExpandEl.html("全部展开"),e.length<1)this.collection.reset();else{var n=this.polish(e);this.collection.reset(n)}this.trigger("refreshdata.tablelist")},onClickAllExpand:function(e){e.preventDefault(),this.collection.isAllShow?(this.allExpandEl.html("全部展开"),this.collection.foldIn()):(this.allExpandEl.html("全部收起"),this.collection.foldOut())}});exports.BillWriteOffView=r});