define(function(require,exports,module){var t=global_helperObj,e=global_validateHelper,i=jQuery,a=/\<!--\s*#inject_area#\s*--\>/,s=["{% if(!_.isEmpty(undefine)) { %}",'    <div class="block block-data" data-key="undefine">','      <h3 class="hd">未定义字段</h3>','      <div class="bd clearfix">',"        {% _.each(undefine, function(val, key){ %}",'          <div class="col-item" data-key="{%- key %}" data-datatype="">','            <span class="col-key" title="{%- key %}">{%- key %}：</span>','            <span class="col-val">{%= global_validateHelper.validateAndPack(val, null, displayMode) %}</span>',"          </div>","        {% }); %}","      </div>","    </div>","{% } %}"].join(""),l=['<div class="block block-historycheck">','  <h3 class="hd">历史审核</h3>','  <div class="bd" id="auditHistoryList">',"  </div>","</div>"].join(""),o=['<div class="col-item">','    <span>【{%= new Date(createTime).format("yyyy-MM-dd HH:mm:ss") %}】</span>&nbsp;&nbsp;',"    <span>","    {% if(rentAuditStatus == '1'){ %}","租赁合同通过,","{% } %}","    {% if(hostingAuditStatus == '1'){ %}","托管合同通过,","{% } %}","    {% if(rentHostingAuditStatus == '1'){ %}","租赁托管比对通过,","{% } %}","    {% if(cashFlowAuditStatus == '1'){ %}","流水通过,","{% } %}","    </span>","    <span>审核结果：</span>","    {% if(status == '2') { %}",'        <span class="error">不通过</span>&nbsp;&nbsp;',"        <span>备注：</span>",'        <span class="error">{%- result %}</span>',"    {% }else if(status == '1') { %}","        <span>已通过</span>&nbsp;&nbsp;","        <span>备注：</span>",'        <span>{%- result ? result : "无" %}</span>',"    {% } %}","</div>"].join(""),r=_.template(o),c=Backbone.View.extend({tagName:"div",id:"arDetailEl",className:"partition-module",template:_.template(i("#ardocTmpl").html()||""),events:{"blur .form-control":"validateField",'click [data-toggle="datetimepicker"]':"showDatepicker","click #modified":"modifiedDocumentRecord","hidden.bs.modal":"detachFromDomTree","click .check-box-all":"toggleAllCheckbox","click .check-box":"verifyIsAllCheck"},$loading:i('<div class="central">').html(global_const.loadingImg),initialize:function(t){this.listenTo(this.model,"sync",this.fillInteralData),this.listenTo(this.model,"request",this.waitingMask),this.listenTo(this.model,"error",this.errorHandler),t.structure&&(this.structure=t.structure,this.blockTemplate=_.template(this.compactHtml(this.structure.detailViewTmpl))),this.datetimepickerCache=[]},compactHtml:function(t){return t=t.replace(a,function(){return s+l})},validateField:function(t){var a=i(t.target),s=a.parents(".col-item"),l=s.data("datatype");if(l){var o=e.validate(a.is("input")?a.val():a.html(),l);o!==!0?(a.addClass("form-control-error"),a.after(i('<div class="error">').html(o.message))):(a.is(".form-control")?a.removeClass("form-control-error"):a.parents(".form-control").removeClass("form-control-error"),s.find(".error").remove())}},waitingMask:function(t,e,i){i.closeModal||this.wrapperEl.html("").append(this.$loading)},detachFromDomTree:function(){this.$el.detach(),i.each(this.datetimepickerCache,function(t,e){e.el.data("my.datetimepicker",null),e.remove()})},render:function(){var t=this.template();return this.$el.html(t),this.modalEl=this.$("#dialog"),this.wrapperEl=this.$(".modal-body"),this},showDatepicker:function(e){var a=i(e.currentTarget),s=a.data("my.datetimepicker");if(!s){var l=!1;i(e.target).is(".input-group-addon, .glyphicon-remove")&&(l=!0),a.data("my.datetimepicker",s=t.datepicker(a)),this.datetimepickerCache.push(s),l?s.clear():s.show()}},errorHandler:function(){this.wrapperEl.html('<div class="central"><p>系统出错或数据有误</p></div>')},getAuditHistory:function(){function t(t){for(var e=[],i=0,a=t.length;a>i;i++)e.push(r(t[i]));return e.join("")||"没有历史审核记录"}var e=this,a=this.model.get("id");if(null!=a){var s="./"+a+"/log";i.getJSON(s,{},function(i){if("0"==i.code){var a=JSON.parse(i.data.list);e.$("#auditHistoryList").html(t(a))}})}},getDataDiffResult:function(){var t=this.model.get("id");if(null!=t){var e="./"+t+"/diff";i.getJSON(e,{},function(t){if("0"==t.code){var e=JSON.parse(t.data.diffResultMaps);for(var a in e){var s=a.split("."),l=s[0],o=s[1],r=i("div[data-key='"+l+"'] div[data-key='"+o+"'] span[class='col-val']"),c=e[a].preValue;r.append("<i class='icon modified-tip' data-title='修改前记录：<strong>"+c+"</strong>'></i>")}}})}},fillInteralData:function(t,e,i){if(i.closeModal)this.modalEl.modal("hide");else if(!t||_.isEmpty(t))this.errorHandler();else{var a=t instanceof Backbone.Model?t.toJSON():t;a.displayMode=this.displayMode||"noedit";var s=this.blockTemplate(a);this.wrapperEl.html(s),this.getAuditHistory(),this.getDataDiffResult()}return this},attachToDomTree:function(t){"edit"===this.displayMode?(this.$("#modified").show(),this.$(".cancel-dialog").html("取消")):(this.$("#modified").hide(),this.$(".cancel-dialog").html("关闭")),t.append(this.$el),this.modalEl.modal()},collectFormData:function(){var t={};return this._collectNormalBlockData(t),this._collectAuditResultData(t),t},_collectNormalBlockData:function(t){var e=this.$(".block-data");e.each(function(){var e=i(this).data("key");if(!e)return!0;var a=t[e]={};i(this).find(".col-item").each(function(){var t,e=i(this).data("key"),s=i(this).find(".real-val");t=s.is("input")?s.val():s.html(),a[e]=i.trim(t)})})},_collectAuditResultData:function(t){var e={},a=this.$(".block-checkresult");if(!(a.length<1)){var s=a.find("#auditStatus").val(),l=i.trim(a.find("textarea").val());""!==s?e.auditStatus=s:e.auditStatus=null,e.auditResult=l,this.$(".checkboxs [name]").each(function(){var t=this.name,i=this.checked?"1":"0";e[t]=i}),t.audit=e}},toggleAllCheckbox:function(t){if(!i(t.target).is(".txt")){var e=i(t.currentTarget),a=e.children("input[type=checkbox]")[0].checked;a?this.$(".checkboxs input[type=checkbox]").each(function(){this.checked=!0}):this.$(".checkboxs input[type=checkbox]").each(function(){this.checked=!1})}},verifyIsAllCheck:function(t){if(!i(t.target).is(".txt")){var e=this.$(".checkboxs input[type=checkbox]"),a=e.filter(":checked").length,s=e.filter(function(){return i(this).parent().is(".check-box-all")}).get(0);s.checked&&a--,a>=e.length-1?(s.checked=!0,this.$("#auditStatus").children().each(function(){return"1"==this.value?(this.selected=!0,!1):void 0})):(s.checked=!1,this.$("#auditStatus").children().each(function(){return"2"==this.value?(this.selected=!0,!1):void 0}))}},modifiedDocumentRecord:function(){if(this.displayMode&&"noedit"!==this.displayMode){var t=this.collectFormData();if(t.audit){if(!t.audit.auditStatus)return this.$("#auditStatus").addClass("form-control-error"),void this.$("#auditResult").removeClass("form-control-error");if("2"==t.audit.auditStatus&&!t.audit.auditResult)return this.$("#auditStatus").removeClass("form-control-error"),void this.$("#auditResult").addClass("form-control-error")}this.$("#auditStatus").removeClass("form-control-error"),this.$("#auditResult").removeClass("form-control-error"),this.model.save(t,{closeModal:!0})}},setDisplayMode:function(t){var e=["edit","noedit"];~e.indexOf(t)?this.displayMode=t:this.displayMode="noedit"}});module.exports=c});