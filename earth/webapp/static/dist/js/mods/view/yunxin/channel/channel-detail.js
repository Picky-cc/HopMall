define(function(require,exports,module){require("scaffold/dragula/dragula.css");var t=require("scaffold/util"),e=require("scaffold/dragula/dragula"),n=require("component/pagination"),a=require("component/popupTip"),i=require("component/stepOperation"),s=require("baseView/baseFormView").FormDialogView,o=jQuery,l=global_config.root,r=global_helperObj.RadioCheckboxControl,h=Backbone.Model.extend({defaults:{financialContractUuid:"",businessType:"",accountSide:"",paymentStrategyMode:"0",paymentChannelUuids:[],paymentChannelOrderForBanks:{}},actions:{save:l+"/paymentchannel/switch/strategy/saveResult",getPaymentChannelList:l+"/paymentchannel/switch/strategy/step/2",getAllBank:l+"/paymentchannel/switch/strategy/step/3",previewPaymentChannelOrderForBanks:l+"/paymentchannel/switch/paymentChannelOrder"},save:function(){var t=this,e=this.toJSON(),n={url:this.actions.save,dataType:"json",processData:!1,type:"post",contentType:"application/json",data:JSON.stringify(e)};n.success=function(e){t.trigger("sync",t,e)},o.ajax(n)},getAllBank:function(t){if(this.bankList)return void t({code:0,data:{list:this.bankList}});var e=this,n={url:this.actions.getAllBank,dataType:"json",data:_.pick(this.toJSON(),"financialContractUuid","businessType","accountSide")};n.success=function(n){e.bankList=n.data.list||[],t&&t(n)},o.ajax(n)},getPaymentChannelList:function(t){if(this.paymentChannelList)return void t({code:0,data:{list:this.paymentChannelList}});var e=this,n={url:this.actions.getPaymentChannelList,dataType:"json",data:_.pick(this.toJSON(),"financialContractUuid","businessType","accountSide")};n.success=function(n){e.paymentChannelList=n.data.list||[],t&&t(n)},o.ajax(n)},updatePaymentChannelOrder:function(){var t=this.get("paymentChannelUuids"),e=this.paymentChannelList,n=[];t.forEach(function(t){for(var a=0,i=e.length;i>a;a++){var s=e[a];if(s.paymentChannelUuid===t){e.splice(a,1),n.push(s);break}}}),this.paymentChannelList=n.concat(e)}}),c={enableNextStop:function(){this.$(".next").attr("disabled",null)},disableNextStop:function(){this.$(".next").attr("disabled",!0)},show:function(){this.activate(1),this.$(".next").attr("disabled",null),this.$el.show()},hide:function(){this.$el.hide()}},d=i.extend({templates:o(".single .step-content-item .template").toArray().map(function(t){var e=o(t).html();return _.template(e)}),events:{"click .panel":"onClickPanel"},initialize:function(){this.on("steped",function(t){var e=this.$contentItems.eq(t-1),n=this.templates[t-1];switch(t){case 1:this.enteredStep1(e,n);break;case 2:this.enteredStep2(e,n)}}),this.on("step:done",this.onStepDone),this.$(".step-tip-item").removeClass("z-active").first().addClass("z-active"),d.__super__.initialize.apply(this,arguments)},onClickPanel:function(t){var e=o(t.currentTarget);e.is(".z-active")?(e.removeClass("z-active"),this.$(".tip").hide()):(this.$(".panel").removeClass("z-active"),e.addClass("z-active"),e.is(".closed")?this.$(".tip").show():this.$(".tip").hide())},onStepDone:function(){var t=this.$(".panel.z-active"),e=t.data("payment-channel-uuid");this.model.set("paymentChannelUuids",[e])},enteredStep1:function(t,e){var n=this.model,a=e(n.toJSON());t.html(a),this.enableNextStop()},enteredStep2:function(t,e){var n=this.model,i=this;n.getPaymentChannelList(function(s){if(0!=s.code)return void a.show(s.message);var o=e({list:n.paymentChannelList,model:n});t.html(o),n.paymentChannelList&&n.paymentChannelList.length||i.disableNextStop()})}});o.extend(d.prototype,c);var p=i.extend({templates:o(".issuer .step-content-item .template").toArray().map(function(t){var e=o(t).html();return _.template(e)}),initialize:function(){this.on("step",function(t){switch(t){case 2:this.beforeLeaveStep2();break;case 3:this.beforeLeaveStep3()}}),this.on("steped",function(t){var e=this.$contentItems.eq(t-1),n=this.templates[t-1];switch(t){case 1:this.enteredStep1(e,n);break;case 2:this.enteredStep2(e,n);break;case 3:this.enteredStep3(e,n);break;case 4:this.enteredStep4(e,n)}}),this.on("step:done",this.onStepDone),this.$(".step-tip-item").removeClass("z-active").first().addClass("z-active"),p.__super__.initialize.apply(this,arguments)},onStepDone:function(){},beforeLeaveStep2:function(){var t=this.$(".panel").toArray().map(function(t){return o(t).data("payment-channel-uuid")});this.model.set("paymentChannelUuids",t),this.model.updatePaymentChannelOrder()},beforeLeaveStep3:function(){var t={};this.$("tbody tr").each(function(){var e=o(this),n=e.data("bank-code"),a=e.find("input:checked").data("payment-channel-uuid");t[n]=a}),this.model.set("paymentChannelOrderForBanks",t)},enteredStep1:function(t,e){var n=this.model,a=e(n.toJSON());t.html(a),this.enableNextStop()},enteredStep2:function(t,n){var i=this.model,s=this;i.getPaymentChannelList(function(o){if(0!=o.code)return void a.show(o.message);var l=n({list:i.paymentChannelList,model:i.toJSON()});t.html(l),s.dragController=e([t.find(".drag-wrapper").get(0)]),i.paymentChannelList&&i.paymentChannelList.length||s.disableNextStop()})},enteredStep3:function(t,e){var n=this.model,i=this;n.getAllBank(function(s){if(0!=s.code)return void a.show(s.message);var o=e({paymentChannelList:n.paymentChannelList,bankList:n.bankList,model:n.toJSON()});t.html(o),i.radioController&&i.radioController.remove(),i.radioController=new r(t.find(".data-list tbody"),{groupSelector:"tr"})})},enteredStep4:function(t,e){var n=this.model,a=n.paymentChannelList.slice(0),i=n.bankList.slice(0),s=n.get("paymentChannelOrderForBanks"),o=i.map(function(t){var e=[],n=[];return a.forEach(function(a){a.paymentChannelUuid===s[t.bankCode]?e.push(a):n.push(a)}),t.paymentChannelOrder=e.concat(n),t}),l=e({previewList:o,paymentChannelList:a,model:n.toJSON()});t.html(l)}});o.extend(p.prototype,c);var u=s.extend({el:o("#setChannelStrategy").get(0),events:{"change [name=channel-mode]":"onChangeChannelMode"},initialize:function(){u.__super__.initialize.apply(this,arguments),this.singleStrategy=new d({model:this.model,el:this.$(".single").get(0)}),this.issuerStrategy=new p({model:this.model,el:this.$(".issuer").get(0)}),this.listenTo(this.singleStrategy,"step:done",function(){this.model.save(),this.hide()}),this.listenTo(this.issuerStrategy,"step:done",function(){this.model.save(),this.hide()}),this.singleStrategy.show(),this.issuerStrategy.hide(),this.listenTo(this.model,"change:paymentStrategyMode",function(t,e){1==e?(this.singleStrategy.hide(),this.issuerStrategy.show()):(this.singleStrategy.show(),this.issuerStrategy.hide())}),this.listenTo(this.model,"sync",function(e,n){0==n.code?(a.show("提交成功"),t.delayReload()):a.show(n.message)})},onChangeChannelMode:function(t){var e=o(t.target).val();this.model.set("paymentStrategyMode",e)}}),m=s.extend({el:o("#priorityPreview").get(0),initialize:function(){var t=this,e=n.extend({refreshTableDataList:function(t,e,n,a){if(this.template){var i;i=t.length<1?'<tr class="nomore"><td style="text-align: center;" colspan="'+this.rowNum+'">没有更多数据</td></tr>':this.template({list:this.polish(t),paymentChannelSize:t[0].paymentChannelList.length}),this.tableListEl.html(i),this.trigger("refresh",t,e,n,a)}},collectParams:function(){return t.model.toJSON()}});this.pagination=e.find(".block")}}),y=Backbone.View.extend({el:o(".content").get(0),events:{"click .set-channel-strategy":"onClickSetChannelStrategy","click .btn-priority-preview":"onClickPreviewPriority"},onClickSetChannelStrategy:function(t){t.preventDefault();var e=o(t.target),n=new h({financialContractUuid:this.financialContractUuid,accountSide:e.parents("[data-account-side]").data("account-side"),businessType:e.parents("[data-business-type]").data("business-type")}),a=new u({model:n});a.show()},onClickPreviewPriority:function(t){t.preventDefault();var e=o(t.target),n=new h({financialContractUuid:this.financialContractUuid,accountSide:e.parents("[data-account-side]").data("account-side"),businessType:e.parents("[data-business-type]").data("business-type")}),a=new m({model:n});a.show()},initialize:function(t){this.financialContractUuid=t}});module.exports=y});