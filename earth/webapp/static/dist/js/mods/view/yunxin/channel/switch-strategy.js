define(function(require,exports,module){var e=require("component/popupTip"),t=require("baseView/baseFormView").BaseFormView,i=jQuery,a=global_config.root,r={MINE:0,AGENT:1},n=Backbone.Model.extend({actions:{save:a+"/paymentchannel/switch/strategy/submit",debitStrategy:a+"/paymentchannel/switch/strategy/debit",creditStrategy:a+"/paymentchannel/switch/strategy/credit"},save:function(){var e=this,t={dataType:"json",type:"post",url:this.actions.save,data:this.toJSON()};t.success=function(t){e.trigger("strategy:save",t)},i.ajax(t)},getDebitStrategy:function(e){var t=this,a=e===r.MINE?"debitStrategyMode":"acdebitStrategyMode";if("-1"==this.get(a))t.trigger("strategy:debit",[],{code:0,data:{lsit:[]}},e);else{var n={url:this.actions.debitStrategy,dataType:"json",data:{financialContractUuid:this.get("financialContractUuid"),businessType:e}};n.success=function(i){var a=[],r=[],n=i.data.list||[];n.forEach(function(e){"OFF"==e.channelStatus?a.push(e):r.push(e)}),t.trigger("strategy:debit",r.concat(a),i,e)},i.ajax(n)}},getCreditStrategy:function(e){var t=this,a=e===r.MINE?"creditStrategyMode":"accreditStrategyMode";if("-1"==this.get(a))t.trigger("strategy:credit",[],{code:0,data:{lsit:[]}},e);else{var n={url:this.actions.creditStrategy,dataType:"json",data:{financialContractUuid:this.get("financialContractUuid"),businessType:e}};n.success=function(i){var a=[],r=[],n=i.data.list||[];n.forEach(function(e){"OFF"==e.channelStatus?a.push(e):r.push(e)}),t.trigger("strategy:credit",r.concat(a),i,e)},i.ajax(n)}}}),d=t.extend({el:".form-wrapper",template:_.template(i(".form").html()),creditStrategyItemTeplate:_.template(i("#creditStrategyItemTmpl").html()),debitStrategyItemTeplate:_.template(i("#debitStrategyItemTmpl").html()),events:{"change [name=creditStrategyMode],[name=accreditStrategyMode]":"onChangeCreditStrategyMode","change [name=debitStrategyMode],[name=acdebitStrategyMode]":"onChangeDebitStrategyMode","click .item-debit,.item-credit":"onClickStrategyItem"},initialize:function(e){d.__super__.initialize.apply(this,arguments),this.initModel(e),this.model.getDebitStrategy(r.MINE),this.model.getCreditStrategy(r.MINE),this.model.getDebitStrategy(r.AGENT),this.model.getCreditStrategy(r.AGENT),this.render()},render:function(){var e=this.model.toJSON(),t=this.template(e);this.$(".form").html(t).show()},initModel:function(e){var t=JSON.parse(this.$("[name=oridinalAttr]").val()||"{}"),i={financialContractUuid:e,creditChannelUuid:t.creditStrategyData?t.creditStrategyData.paymentChannelUuid:"",debitChannelUuid:t.debitStrategyData?t.debitStrategyData.paymentChannelUuid:"",debitStrategyMode:t.debitPaymentChannelMode,creditStrategyMode:t.creditPaymentChannelMode,accreditChannelUuid:t.accreditStrategyData?t.accreditStrategyData.paymentChannelUuid:"",acdebitChannelUuid:t.acdebitStrategyData?t.acdebitStrategyData.paymentChannelUuid:"",acdebitStrategyMode:t.acdebitPaymentChannelMode,accreditStrategyMode:t.accreditPaymentChannelMode};this.model=new n(i),this.listenTo(this.model,"strategy:save",this.onStrategySave),this.listenTo(this.model,"strategy:debit",this.onStratgyDebitGet),this.listenTo(this.model,"strategy:credit",this.onStratgyCreditGet)},onClickStrategyItem:function(e){e.preventDefault();var t=i(e.currentTarget);if(t.hasClass("closed"))return i(e.target).is("a")&&window.open(e.target.href,"_blank"),void e.stopPropagation();var a=t.data();a.name=t.text(),t.is(".item-credit")?this.handleClickItemCredit(a):t.is(".item-debit")&&this.handleClickItemDebit(a)},handleClickItemDebit:function(e){if(e.businessType==r.MINE){this.$(".fieldset-mine .debitChannelName").text(e.name);var t=i(".fieldset-mine .debit-strategy-list .dropdown-toggle");t.hasClass("error")&&t.removeClass("error"),this.model.set({debitChannelUuid:e.uuid})}else{this.$(".fieldset-agent .debitChannelName").text(e.name);var t=i(".fieldset-agent .debit-strategy-list .dropdown-toggle");t.hasClass("error")&&t.removeClass("error"),this.model.set({acdebitChannelUuid:e.uuid})}},handleClickItemCredit:function(e){if(e.businessType==r.MINE){this.$(".fieldset-mine .creditChannelName").text(e.name);var t=i(".fieldset-mine .credit-strategy-list .dropdown-toggle");t.hasClass("error")&&t.removeClass("error"),this.model.set({creditChannelUuid:e.uuid})}else{this.$(".fieldset-agent .creditChannelName").text(e.name);var t=i(".fieldset-agent .credit-strategy-list .dropdown-toggle");t.hasClass("error")&&t.removeClass("error"),this.model.set({accreditChannelUuid:e.uuid})}},onChangeCreditStrategyMode:function(e){var t=i(e.target),a=t.val();t.is("[name=accreditStrategyMode]")?(this.model.set({accreditStrategyMode:a}),this.model.set({accreditChannelUuid:""}),this.model.getCreditStrategy(r.AGENT)):(this.model.set({creditStrategyMode:a}),this.model.set({creditChannelUuid:""}),this.model.getCreditStrategy(r.MINE))},onChangeDebitStrategyMode:function(e){var t=i(e.target),a=t.val();t.is("[name=acdebitStrategyMode]")?(this.model.set({acdebitStrategyMode:a}),this.model.set({acdebitChannelUuid:""}),this.model.getDebitStrategy(r.AGENT)):(this.model.set({debitStrategyMode:a}),this.model.set({debitChannelUuid:""}),this.model.getDebitStrategy(r.MINE))},onStrategySave:function(t){0==t.code?location.href=a+"/paymentchannel/switch/list":e.show(t.message)},onStratgyCreditGet:function(t,i,a){if(0!=i.code)return void e.show(i.message);var n=this.creditStrategyItemTeplate({list:t,businessType:a,selectedPaymentChannelUuid:a==r.MINE?this.model.get("creditChannelUuid"):this.model.get("accreditChannelUuid")});if(a==r.MINE){var d=this.$(".fieldset-mine .credit-strategy-list .dropdown-menu").html(n).find(".selected").first();this.$(".fieldset-mine .creditChannelName").text(d.text()||"请选择交易通道")}else{var d=this.$(".fieldset-agent .credit-strategy-list .dropdown-menu").html(n).find(".selected").first();this.$(".fieldset-agent .creditChannelName").text(d.text()||"请选择交易通道")}},onStratgyDebitGet:function(t,i,a){if(0!=i.code)return void e.show(i.message);var n=this.debitStrategyItemTeplate({list:t,businessType:a,selectedPaymentChannelUuid:a==r.MINE?this.model.get("debitChannelUuid"):this.model.get("acdebitChannelUuid")});if(a==r.MINE){var d=this.$(".fieldset-mine .debit-strategy-list .dropdown-menu").html(n).find(".selected").first();this.$(".fieldset-mine .debitChannelName").text(d.text()||"请选择交易通道")}else{var d=this.$(".fieldset-agent .debit-strategy-list .dropdown-menu").html(n).find(".selected").first();this.$(".fieldset-agent .debitChannelName").text(d.text()||"请选择交易通道")}},validate:function(){var e=!0;this.$(".fieldset-mine .debitChannelName").toArray().forEach(function(t){var a=i(t);""===a.text()?(a.parent(".dropdown-toggle").addClass("error"),e=!1):a.parent(".dropdown-toggle").removeClass("error")});var t=!0;return this.$(".fieldset-mine .creditChannelName").toArray().forEach(function(e){var a=i(e);""===a.text()?(a.parent(".dropdown-toggle").addClass("error"),t=!1):a.parent(".dropdown-toggle").removeClass("error")}),e&&t},submitHandler:function(){this.validate()&&this.model.save()}});module.exports=d});