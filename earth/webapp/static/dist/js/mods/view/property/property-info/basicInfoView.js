define(function(require,exports,module){require("component/autocomplete");var e=require("component/fileUpload"),t=require("scaffold/util"),i=(t.validateUtil.regExps,require("component/areaSelect")),a=require("baseView/baseFormView"),o=a.FieldsetView,n=a.FormDialogView,r=jQuery,s=global_config.root,c=Backbone.Model.extend({urlRoot:s+"/community/saveCommunity",save:function(e,t){var i=this;0 in arguments&&this.set(e,{validate:!0}),this.trigger("request");var a={url:this.urlRoot,type:"post",dataType:"json",data:this.toJSON()};a.success=function(e){t.success&&t.success(e),0==e.code&&i.trigger("sync",i,e,t)},a.error=function(){t.error&&t.error.call(null,arguments),i.trigger("error")},a.complete=function(){t.complete&&t.complete.call(null,arguments)},r.ajax(a)}}),l=n.extend({template:_.template(r("#editCommunityTmpl").html(),{variable:"obj"}),className:"modal fade form-modal",initialize:function(){l.__super__.initialize.apply(this,arguments),this.validator=this.$(".form").validate({rules:{provinceCode:"required",cityCode:"required",areaCode:"required"}}),this.areaSelet=new i({el:this.$(".area-select"),defSelectProvince:this.model.get("provinceCode"),defSelectCity:this.model.get("cityCode"),defSelectDistrict:this.model.get("areaCode")})},submitHandler:function(e){if(this.validator.form()){var t=this._extractDomData(this.$(".form-control")),i=this;this.model.save(t,{success:function(e){0!=e.code?i.popupTip(e.message):i.hide()}})}}}),m=o.extend({el:r(".property-info"),events:{"blur .room-no":function(e){this.model.rSet("subjectMatterAppendix.roomNo",e.target.value)},"click .add-cur-posi":"onClickAddCurPosi"},initialize:function(e){var t=this.$(".area").data();this.areaSelect=new i({el:this.$(".area-select"),defSelectProvince:t.provincecode,defSelectCity:t.citycode,defSelectDistrict:t.areacode}),this.__parent__=e.__parent__,this.listenTo(this.model,"change:subjectMatterAppendix",function(){var e=this.model.rGet("subjectMatterAppendix.community"),t=this.model.rGet("subjectMatterAppendix.address"),i=[e,t,this.model.rGet("subjectMatterAppendix.roomNo")];this.$(".address").text(t),this.$('[name="community"]').val(e),this.$(".property-name").val(i.join(""))}),this.initFileUploader(),this.initCommunity()},initFileUploader:function(){var t=this.$(".property-certificate-images");e.globalUploadImage(this.$(".property-file-input"),{onPlacement:function(e,i){t.html(e)}});var i=this;e.globalUploadFile(this.$(".assecsory-file-input"),{onSuccess:function(e,t){t.removeClass("error")},onPlacement:function(e,t){i.$(t.data("target")).html(e)}})},initCommunity:function(){var e=this,t=this.areaSelect;this.$(".btm-extra-text");this.communityEl=this.$(".community"),this.communityEl.autocomplete({action:s+"/community/getCommunityList",container:this.$(".auto-complete-list"),parse:function(e){return 0==e.code?e.data.communityList:[]},search:function(){var e=t.getValue().split("-");return{provinceCode:e[0],cityCode:e[1],areaCode:e[2]}},parcelItem:function(e){var t='<li class="item" data-communityuuid="'+e.communityUuid+'"><span class="title">'+e.communityName+'</span><span class="sub-title">'+e.address+"</span></li>";return t},onSync:function(e,t,i){var a="";e.length<1?(a='<p>未找到对应小区/楼宇？</p><p><a href="#" class="add-cur-posi">添加</a><span> '+t+" </span>为小区/楼宇</p>",i.html(a)):(a='<p><a href="#" class="add-cur-posi">添加</a><span> '+t+" </span>为小区/楼宇</p>",i.append(a))},onSubmit:function(t,i){var a=i.find(".title").text(),o=i.find(".sub-title").text();e.setCommunityIsNotInput(!0),e.model.rSet("subjectMatterAppendix.community",a),e.model.rSet("subjectMatterAppendix.address",o)},onClose:function(t,i){t&&"select"!==t.triggerType&&(e.setCommunityIsNotInput(!1),e.model.rSet("subjectMatterAppendix.community",i.val()),e.model.rSet("subjectMatterAppendix.address",""))}})},onClickAddCurPosi:function(e){e.preventDefault();var t=this,i=this.areaSelect.getValue().split("-"),a=new c({communityName:this.communityEl.val(),provinceCode:i[0],cityCode:i[1],areaCode:i[2]}),o=new l({model:a});a.once("sync",function(e){t.setCommunityIsNotInput(!0),t.model.rSet("subjectMatterAppendix.community",e.get("communityName")),t.model.rSet("subjectMatterAppendix.address",e.get("address")),t.areaSelect.refresh(e.get("provinceCode"),e.get("cityCode"),e.get("areaCode"))}),o.show()},setCommunityIsNotInput:function(e){this.__parent__.communityIsNotInput=e,this.__parent__.validator.element("[name=community]")},validate:function(){return this.__parent__.communityIsNotInput},extractDomData:function(){var e=function(e){var t=e.data();return t?{imgKey:t.original,thumbNailsImgKey:t.thumbnail,imageName:""}:{}},t=function(e){var t=e.data();return t?{fileName:t.filename,fileUrlKey:t.original}:{}},i=this._extractDomData(this.$("[data-params]"));return i.propertyCertificateImg=e(this.$(".property-certificate-images .item")),i.attachmentFile=t(this.$(".attachment-files .item")),i.provinceCode=this.$('[name="provinceCode"]').val(),i.cityCode=this.$('[name="cityCode"]').val(),i.areaCode=this.$('[name="areaCode"]').val(),i.address=this.$(".address").text(),i},save:function(){var e=this.extractDomData();this.model.rSet("subjectMatterAppendix",e)}});module.exports=m});