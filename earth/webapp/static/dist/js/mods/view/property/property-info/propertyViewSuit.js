define(function(require,exports,module){var e=require("component/popupTip"),t=require("component/dialogView"),i=require("scaffold/util"),o=i.validateUtil.regExps,a=require("entity/property/propertyModel").PropertyModel,n=require("baseView/baseFormView").BaseFormView,r=require("./basicInfoView"),s=require("./hostInfoView"),l=require("./houseInfoView"),u=require("./memoInfoView"),d=n.extend({el:".property-form-wrapper",initialize:function(e){d.__super__.initialize.apply(this,arguments),"string"==typeof e?this.communityIsNotInput=!0:this.communityIsNotInput=!1,this.initModel(e),this.initSubView(),this.initValidator(),this.succDialogView=new t({cancelBtnTxt:"取消",goaheadBtnTxt:"继续"})},initValidator:function(){var e=this;jQuery.validator.addMethod("communityIsNotInput",function(t,i){return this.optional(i)||e.communityIsNotInput},"请添加或选择正确的小区名称"),jQuery.validator.addMethod("validateLevel",function(t,i){if(o.chineseCharactor.test(t))return!1;var a=e.$('input[name="totalLevels"]').val();return o.positiveInteger.test(a)&&o.positiveInteger.test(t)?+a>=+t:!0},"楼层信息不正确"),jQuery.validator.addMethod("validateTotalLevel",function(t,i){if(!o.positiveInteger.test(t))return!1;var a=e.$('input[name="level"]').val();return o.positiveInteger.test(a)?+t>=+a:!0},"楼层信息不正确"),this.validator=$(".property").validate({ignore:".hide [name], [type=file]",onsubmit:!1,groups:{floor:"level totalLevels",houseType:"roomNum hallNum bathroomNum kitchenNum"},rules:{provinceCode:"required",cityCode:"required",totalLevels:"validateTotalLevel",level:"validateLevel",roomNum:"nonNegativeInteger",hallNum:"nonNegativeInteger",bathroomNum:"nonNegativeInteger",kitchenNum:"nonNegativeInteger",sourcePropertyNo:"numberAndAlphabet",community:{required:!0,communityIsNotInput:!0}},messages:{sourcePropertyNo:{numberAndAlphabet:"请输入正确的自有物业编号，格式仅支持数字和英文哦"}},errorPlacement:function(e,t){var i=t.parent(),o=t.attr("name");~["level","totalLevels"].indexOf(o)?i.parent().append(e):~["roomNum","hallNum","bathroomNum","kitchenNum"].indexOf(o)?i.parent().append(e):i.is(".parcel-input")?e.insertAfter(i):t.is(".community")?i.append(e):e.insertAfter(t)}})},initModel:function(e){var t;this.model=new a,"string"==typeof e&&this.model.set("subjectMatterUuid",e);try{t=JSON.parse($("#workingDataTmpl").val())}catch(i){t={}}this.model.set(t),this.model.rSet("subjectMatterAppendix.leaseType",this.$("#leasingType").val())},initSubView:function(){this.houseInfoView=new l({model:this.model,__parent__:this}),this.hostSketchListView=new s({model:this.model,__parent__:this}),this.basicPropertyView=new r({model:this.model,__parent__:this}),this.memoPropertView=new u({model:this.model,__parent__:this})},validate:function(){var e=this.validator.form(),t=this.basicPropertyView.validate(),i=this.houseInfoView.validate(),o=this.hostSketchListView.validate(),a=this.memoPropertView.validate();return e&&t&&a&&o&&i},submitHandler:function(t){if(!this.validate())return void this.trigger("invalid");this.basicPropertyView.save(),this.memoPropertView.save(),this.hostSketchListView.save(),this.houseInfoView.save();var i=!!this.model.get("subjectMatterUuid"),o=this.succDialogView,a=function(e){AppRouters.navigate("business-contract/rental-contract/?subjectMatterUuid="+e,{absolute:!0})},n=function(e){"undefined"==typeof e?AppRouters.navigate("../property-list/index"):AppRouters.navigate("../property-view/"+e)};this.model.manualSave({success:function(t,r){var s=r.data.subjectMatterUuid;if(0==r.code)i?(e.once("closedialog",n),e.show("成功！",s)):(o.once("goahead",a),o.once("closedialog",n),o.show("物业房源信息添加成功，继续完成上游合同录入？",s));else for(var l in r.data)r.data.hasOwnProperty(l)&&e.show(r.data[l])}})}});exports.AddPropertyView=d});