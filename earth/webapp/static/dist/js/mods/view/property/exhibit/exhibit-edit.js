define(function(require,exports,module){var e=(require("scaffold/path"),require("component/popupTip")),t=require("component/dialogView"),i=require("component/fileUpload"),o=require("baseView/baseFormView"),n=o.FieldsetView,a=(o.FormDialogView,o.SketchItemView,jQuery),r=global_config.root,s=Backbone.Model.extend({url:r+"/subject-matter/exhibit/promotionInfoSave",actions:{publish:r+"/subject-matter/exhibit/publish"},defaults:{subjectMatterUuid:"",subjectMatterPromotionInfo:{houseImg:[],mobileHouseImg:[],roomType:"",bedRoomType:"",decorateType:"",independentBathroom:"",rentPrice:"",tradeInterval:"",depositPrice:"",movingTime:null,telphone:"",contactName:"",inventoryStatus:"",activeExhibitUuid:"",promotionTitle:"",promotionContent:"",balcony:"",isPublishInfoComplete:""}},parse:function(e){return e.data},save:function(e){s.__super__.save.call(this,{},e)},exhibit:function(e){var t={url:this.actions.publish,type:"post",data:{leasingSubjectMatterUuid:this.get("subjectMatterUuid")}};t.success=function(t){t=JSON.parse(t),e&&e(t)},a.ajax(t)},setIsCompleted:function(e){var t=this.get("subjectMatterPromotionInfo");t.isPublishInfoComplete=e?1:0,this.set("subjectMatterPromotionInfo",t)}}),l=n.extend({el:".form-wrapper",events:{"click #save":"onClickSave","click #preview":"onClickPreview","click #exhibit":"onClickExhibit","change [name=roomType]":"onChangeRoomType","click .cover-set":"onClickSetCover","click .cover-delete":"onClickDelCover"},initialize:function(e){this.model=new s({subjectMatterUuid:e}),this.defineValidator(),this.initFileUplad(),this.roomTypeSelectEl=this.$(".bed-room-type").remove(),this.roomTypeSelectEl.removeClass("hide");var i=this,o=this.previewDialog=new t({bodyInnerTxt:"是否先保存",cancelBtnTxt:"否",goaheadBtnTxt:"是"});o.on("goahead",function(){var e=i.isValid();i.save(e,function(){o.hide(),i.preview()})}),o.on("cancel",function(){o.hide(),i.preview()})},initFileUplad:function(){var e=image_oss_host,t=this.$(".photo-covers");i.globalUploadImage(this.$(".file-input"),{limitNum:8,createItemDom:function(t,i){var o='<li class="item" data-original="'+t.original+'" data-thumbnail="'+t.thumbnail+'"><img src="'+e.thumbnail+"/"+t.thumbnail+'"><a class="operation cover-set">封</a><a class="operation cover-delete"></a></li>';return o},onPlacement:function(e,i){t.append(e)},onSuccess:function(e,t){t.removeClass("error")}})},defineValidator:function(){this.formEl=this.$(".form");var e={ignore:!1,onsubmit:!1,rules:{roomType:"required",bedRoomType:"required",rentPrice:{money:!0},depositPrice:{money:!0},telphone:{mobile:!0},movingTime:"required"},messages:{roomType:{required:"请先勾选"},bedRoomType:{required:"请先勾选"}},success:function(e,t){var i=a(t).parent();i.is(".imitate-datetimepicker-input")&&(t.value?i.removeClass("error"):i.addClass("error"))},errorPlacement:function(e,t){var i=t.parent();i.is(".parcel-input")?e.insertAfter(i):i.find(".right-extra-text").length>0?i.append(e):i.is(".imitate-datetimepicker-input")||(i.is(".radio-box")?i.parent().append(e):e.insertAfter(t))}};this.validator=this.formEl.validate(e)},validate:function(){var e=this.validator.form(),t=this.$(".photo-covers .item").length>0;return t?this.$(".file-input").removeClass("error"):this.$(".file-input").addClass("error"),e&&t},isValid:function(){var e=this.validator,t=e.settings.showErrors;e.settings.showErrors=function(){};var i=this.validator.form();return e.settings.showErrors=t,i},extractDomData:function(){var e=function(e){var t=e.data();return t?{imgKey:t.original,thumbNailsImgKey:t.thumbnail,imageName:""}:{}},t=this._extractDomData(this.$(".real-value"),!0),i=[],o=[];return this.$(".photo-covers .item").each(function(){var t=a(this),n=e(t);t.find(".triangle").length>0?(o.push(n),i.unshift(n)):i.push(n)}),t.houseImg=i,t.mobileHouseImg=o.length>0?o:i.slice(0,1),t.roomType=a("[name=roomType]:checked").val(),t.bedRoomType=a("[name=bedRoomType]:checked").val(),t.independentBathroom=a("[name=independentBathroom]:checked").val(),t.balcony=a("[name=balcony]:checked").val(),t},save:function(e,t){var i=this,o=this.extractDomData();this.model.set("subjectMatterPromotionInfo",o),this.model.setIsCompleted(e),this.model.save({success:function(e,o){t.call(i,o)}})},preview:function(){var e=r+"/mobile/exhibit/property-list/index#!/preview/"+this.model.get("subjectMatterUuid");window.open(e)},exhibit:function(t){var i=this.extractDomData();this.model.set("subjectMatterPromotionInfo",i),this.model.setIsCompleted(t);var o=function(t,i){0==i.code?(e.show("正在发布..."),t.exhibit(function(t){0==t.code?(e.show("成功，正在跳转..."),setTimeout(function(){location.assign(r+"/subject-matter/exhibit/property-list/index")},1500)):e.show(t.message)})):e.show(i.message)};this.model.save({success:o})},onClickSetCover:function(e){e.preventDefault();var t=a('<span class="triangle">');this.$(".photo-covers .triangle").remove();a(e.target).parent().append(t)},onClickDelCover:function(e){e.preventDefault();var t=a(e.currentTarget);t.parent().remove(),a(document).trigger("delete.fileitem",t)},onChangeRoomType:function(e){1==e.target.value?this.$(".room-type").after(this.roomTypeSelectEl):this.roomTypeSelectEl.remove()},onClickSave:function(){var t=this.isValid();this.save(t,function(t){0==t.code?(e.show("成功，正在跳转..."),setTimeout(function(){location.assign(r+"/subject-matter/exhibit/property-list/index")},1500)):e.show(t.message)})},onClickPreview:function(){this.previewDialog.show()},onClickExhibit:function(){var e=this.validate();e&&this.exhibit(e)}});exports.PublishEditView=l});