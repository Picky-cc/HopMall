define(function(require,exports,module){var e=require("baseView/baseFormView"),t=(require("scaffold/util").validateUtil,require("entity/property/propertyModel").FareTypeModel),i=e.FieldsetView,a=e.SketchItemView,n=e.FormDialogView,o=a.extend({template:_.template($("#itemAccountInfoViewTmpl").html()||""),toEdit:function(){var e=new r({model:this.model});e.show()}}),r=n.extend({id:"payTimeInputDialog",className:"modal fade form-modal",template:_.template($("#editAccountInfoViewTmpl").html()||"",{variable:"obj"}),initialize:function(){r.__super__.initialize.apply(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$(".form").validate({rules:{accountNo:"required",accountOwnerName:"required",subbranch:"required",type:"required"}})},render:function(){var e=this.model.toJSON();e.fareTypes=this.model.getRemainFareType();var t=this.template(e);return this.$el.html(t),this},validate:function(){return this.validator.form()},submitHandler:function(e){this.validate()&&(this.save(),this.hide())}}),l=i.extend({el:$(".other-info"),events:{"click .btn-addfare":"onClickAddfare"},validate:function(){return!0},initialize:function(){l.__super__.initialize.apply(this,arguments),this.fareTypesCollection=new Backbone.Collection(this.convertToArray(this.model.getAccountInfoMap()),{model:t}),this.listenTo(this.fareTypesCollection,"add",function(e){this.addOneFare(e),this.isRemainFareType()||this.$(".btn-addfare").hide()}),this.listenTo(this.fareTypesCollection,"remove",function(){this.$(".btn-addfare").show()}),this.addAllFare()},convertToArray:function(e){var t=[];for(var i in e){var a=e[i];a.type=i,t.push(a)}return t},convertToMap:function(e){for(var t=e.toJSON(),i={},a=0;a<t.length;a++)i[t[a].type]=t[a];return i},save:function(){var e=this.convertToMap(this.fareTypesCollection),t=this.extractDomData();this.model.set("memo",t),this.model.setAccountInfoMap(e)},isRemainFareType:function(){var e=new t({},{collection:this.fareTypesCollection});return 0!=e.getRemainFareType().length},addAllFare:function(){for(var e=this.fareTypesCollection,t=0,i=e.length;i>t;t++)this.addOneFare(e.at(t));this.isRemainFareType()||this.$(".btn-addfare").hide()},addOneFare:function(e){var t=new o({model:e}),i=t.render().$el;this.$(".addfare").append(i)},onClickAddfare:function(e){var i=this.fareTypesCollection,a=new t({},{collection:i}),n=new r({model:a});a.once("change",function(e){i.add(e)}),n.show()}});module.exports=l});