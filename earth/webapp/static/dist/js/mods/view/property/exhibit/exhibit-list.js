define(function(require,exports,module){var t=require("component/popupTip"),e=require("baseView/tableContent"),i=global_config.root,a=jQuery,n={Waiting_For_Rent:"待租",On_Lease:"已租"},s=(_.invert(n),{0:"未发布",1:"已发布"}),c=_.invert(s),l=e.extend({actions:{publish:i+"/subject-matter/exhibit/publish","publish-batch":i+"/subject-matter/exhibit/publish-batch",rollback:i+"/subject-matter/exhibit/rollback","rollback-batch":i+"/subject-matter/exhibit/rollback-batch"},events:{"click #exportExcel":"onClickExport","click #rollbackBatch":"onClickRollbackBatch","click #publishBatch":"onClickPublishBatch","click .publish":"onClickPublish","click .rollback":"onClickRollback"},initialize:function(){l.__super__.initialize.apply(this,arguments),this.on("checkbox.tablelist",this.onChangeCheckbox)},polish:function(t){var e=function(t){return Math.floor((Date.now()-t)/864e5)};return t.forEach(function(t){t.propertyStatusDesc=n[t.propertyStatus],t.inventoryStatusDesc=s[t.inventoryStatus],1==t.inventoryStatus&&t.lastPublishedTime?t.lastPublishedDays=e(t.lastPublishedTime):t.lastPublishedDays=0}),t},canPublishBatch:function(t){var e=this.getInventoryStatus,i=this.getIsPublishInfoComplete,a=t.filter(function(){var t=e(this),a=i(this);return 0==t&&1==a});return a.length===t.length},canRollbackBatch:function(t){var e=this.getInventoryStatus,i=t.filter(function(){var t=e(this);return 1==t});return i.length===t.length},postJSON:function(e,i,n){var s=this,c=this.actions[e],l={url:c,type:"post",data:i};l.success=function(e){e=JSON.parse(e),0!=e.code?t.show(e.message):(n&&n(e),s.refresh())},a.ajax(l)},onChangeCheckbox:function(t,e){var i=this.getCheckedItemDom();i.length<1?(this.$("#publishBatch").attr("disabled",!0).html("全部发布"),this.$("#rollbackBatch").attr("disabled",!0).html("全部撤回")):(this.canPublishBatch(i)?this.$("#publishBatch").attr("disabled",!1).html("全部发布("+i.length+")"):this.$("#publishBatch").attr("disabled",!0).html("全部发布"),this.canRollbackBatch(i)?this.$("#rollbackBatch").attr("disabled",!1).html("全部撤回("+i.length+")"):this.$("#rollbackBatch").attr("disabled",!0).html("全部撤回"))},onClickRollback:function(e){e.preventDefault();var i=this.getItemDom(e.target),a=this.getLeasingSubjectMatterUuid(i);a&&this.postJSON("rollback",{leasingSubjectMatterUuid:a},function(e){t.show("成功")})},onClickRollbackBatch:function(e){var i=this.getCheckedItemDom(e.target),a=this.getCheckedLeasingSubjectMatterUuid(i);a&&a.length>0&&this.postJSON("rollback-batch",{leasingSubjectMatterUuidListJson:JSON.stringify(a)},function(e){t.show("成功撤回 "+e.data.success+" 条")})},onClickPublish:function(e){if(e.preventDefault(),!a(e.target).is(".disabled")){var i=this.getItemDom(e.target),n=this.getLeasingSubjectMatterUuid(i);n&&this.postJSON("publish",{leasingSubjectMatterUuid:n},function(e){t.show("成功")})}},onClickPublishBatch:function(e){var i=this.getCheckedItemDom(e.target),a=this.getCheckedLeasingSubjectMatterUuid(i);a&&a.length>0&&this.postJSON("publish-batch",{leasingSubjectMatterUuidListJson:JSON.stringify(a)},function(e){t.show("成功发布 "+e.data.success+" 条")})},onClickExport:function(t){t.preventDefault();var e=a(t.target).data("action");if(e){var i=this.collectParams(),n=[];for(var s in i){var c=s+"="+i[s];n.push(c)}var l=e+"?"+n.join("&"),o=window.open(l,"_download");o&&setTimeout(function(){o.closed||o.close()},100)}},getItemDom:function(t){return a(t).parents("tr")},getCheckedItemDom:function(){return this.tableListEl.find("tbody .check-box:checked").parents("tr")},getCheckedLeasingSubjectMatterUuid:function(t){for(var e=[],i=this.getLeasingSubjectMatterUuid,a=0,n=t.length;n>a;a++)e.push(i(t[a]));return e},getLeasingSubjectMatterUuid:function(t){return a(t).data("leasingsubjectmatteruuid")},getInventoryStatus:function(t){var e=a(t).find(".inventory-status").html();return c[e]},getIsPublishInfoComplete:function(t){return a(t).data("ispublishinfocomplete")}});exports.PublishListView=l});