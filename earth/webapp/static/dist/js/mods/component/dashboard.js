define(function(require,exports,module){var t=require("./backdrop"),e=require("scaffold/path"),a=sessionStorage,n=global_const.loadingImg,i=Backbone.View.extend({events:{"click [data-key]":"onClickTabMenuItem","change .selectpicker":"onChangeSelectpicker","click a[data-path]":"onClickHref"},initialize:function(){if(this.tabContentCache={},this.tabContentEl=this.$(".tab-content"),this.tabMenuEl=this.$(".nav-tabs"),this.selectpickerEl=this.$(".selectpicker"),this.backdrop=new t({zIndex:7}),this.on("request",function(){this.tabContentEl.html(n.clone())}),this.initActiveTab(),this.$el.data("disable-toggle"))return void this.fetchTabContent();var e=this,a=$(".web-g-hd .btn-toggle-dashboard");this.listenTo(this.backdrop,"close:backdrop",function(){this.$el.addClass("hide")}),this.listenTo(this.backdrop,"open:backdrop",function(){this.$el.removeClass("hide"),this.fetchTabContent()}),a.on("click",function(){e.backdrop.toggle()}),$(window).on("keyup.dashboard",function(t){27==t.keyCode&&e.backdrop.hide()})},initActiveTab:function(){if(a)var t=a.getItem("active_tab_key"),e=this.$el.find("a[data-key="+t+"]").parent("li");e&&0!=e.length||(e=this.$el.find(".nav-tabs li").first()),e.addClass("active")},onClickHref:function(t){t.preventDefault();var a=$(t.currentTarget),n=this.getSeletedProject(),i=e.stringifyQueryObject(n),c="t="+Date.now(),o=a.data("path"),s=a.data("hash"),r=a.data("search");r=r?r+"&"+c:c,s=s?s+"&"+i:i,location.assign(encodeURI(o+"?"+r+"#"+s))},onChangeSelectpicker:function(){this.fetchTabContent()},onClickTabMenuItem:function(t){t.preventDefault();var e=$(t.currentTarget),n=e.parent();n.is(".active")||(this.tabMenuEl.children().removeClass("active"),n.addClass("active"),a&&a.setItem("active_tab_key",e.attr("data-key")),this.fetchTabContent())},getActiveTabMenu:function(){return this.tabMenuEl.find(".active")},getActiveTabMenuHref:function(){var t=this.getActiveTabMenu(),e=t.find("a"),a=e.data("href");return a},getSeletedProject:function(){var t={},e=this.selectpickerEl.selectpicker("val");return t.financialContractIds=e?JSON.stringify(e):"[]",t},fetchTabContent:function(){var t=this,e=this.getActiveTabMenuHref();if(e){var a=this.getSeletedProject();t.trigger("request"),$("<div/>").load(e,a,function(e,a,n){if("error"==a||200!=n.status)t.tabContentEl.html("系统异常请稍候重试");else if($(e).data("dashboard-item")){t.tabContentEl.html(e);var i=0;t.tabContentEl.find("[data-total]").each(function(){i+=+$(this).data("total")});var c=t.getActiveTabMenu();c.find(".total").html(i)}else t.tabContentEl.html("系统异常请稍候重试");t.trigger("refresh",e,a)})}}}),c=$(".dashboard");c.length>0&&(module.exports=new i({el:c.get(0)}))});