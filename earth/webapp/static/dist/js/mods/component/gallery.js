define(function(require,exports,module){function t(t,i,s){e.isFunction(i)&&(s=i,i={}),e.getJSON(t,i,function(t){s(0==t.code?t.data.imgs:[])})}var i=require("./backdrop"),e=jQuery,s=e("body"),n=global_const.loadingImg,l='<div class="inner"><div class="bd"><img class="current" src="" alt=""><a href="javascript: void 0;" class="btn prev"></a><a href="javascript: void 0;" class="btn next"></a></div><div class="ft"><ul class="imgs"></ul></div></div>',r=Backbone.View.extend({tagName:"div",className:"gallery",template:_.template(l),events:{"click .prev":"prevItem","click .next":"nextItem","click .item":"selectItem",click:"fadeOut"},initialize:function(t){e.extend(this,{itemImgWidth:82},t),this.imgs&&this.setPhotos(this.imgs),this.removalItem=[]},fadeOut:function(t){if(t.target===this.el){var i=this;this.$el.fadeOut(150,function(){i.$el.detach()})}},open:function(){s.append(this.$el),this.$el.show()},initBackdropView:function(){this.backdropView=new i,this.backdropView.open(),this.listenTo(this.backdropView,"close:backdrop",this.remove)},setPhotos:function(t){this.render(t),this.imgs=t},render:function(t){if(t.length>0){this.$el.html(this.template()),this.imgListEl=this.$(".imgs"),this.currentShowEl=this.$(".current"),this.currentShowEl.attr("src",t[0]);var i=e.map(t,function(t){return'<li class="item"><a><img src="'+t+'" alt=""></a></li>'});this.imgListEl.width(t.length*this.itemImgWidth).html(i.join("")).children().first().addClass("z-active")}else this.$el.html('<div class="nomore">没有更多</div>')},waitting:function(){return this.$el.html("").append(n.clone()),this},isSpillRightBoundry:function(t){var i=t.position(),e=this.$(".ft").width();return i.left+this.itemImgWidth>e},isGetLeftBoundry:function(t){return 0===t.position().left},prevItem:function(t){var i=this.$(".item.z-active"),e=i.prev();(this.removalItem.length>0||e.length>0)&&(this.isGetLeftBoundry(i)&&this.removalItem.length>0&&(e=this.removalItem.shift().prependTo(this.imgListEl)),this._selectItem(e,i))},nextItem:function(t){var i=this.$(".item.z-active"),e=i.next();if(e.length>0){if(this.isSpillRightBoundry(i)){var s=this.imgListEl.children();this.removalItem.push(s.eq(0).remove()),this.removalItem.push(s.eq(1).remove())}else this.isSpillRightBoundry(e)&&this.removalItem.push(this.imgListEl.children().first().remove());this._selectItem(e,i)}},selectItem:function(t){this._selectItem(e(t.currentTarget),this.$(".item.z-active"))},_selectItem:function(t,i){i.removeClass("z-active"),t.addClass("z-active");var e=t.find("img").attr("src");this.currentShowEl.attr("src",e)}});e(document).on("click",".show-gallery",function(i){var s,n=e(i.currentTarget),l=n.data();(l.action||l.imgurls)&&((s=n.data("galleryObj"))?s.open():(s=new r,n.data("galleryObj",s),l.action?t(l.action,function(t){s.setPhotos(t),s.open()}):l.imgurls&&(s.setPhotos(l.imgurls.split(/\s*,\s*/)),s.open())))}),module.exports=r});