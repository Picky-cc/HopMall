define(function(require,exports,module){function e(e){a.extend(this,r,e),this.fileInput=this.el.find("input[type=file]");var t=this.fileInput.attr("name");if(t&&(this.uploadParamName=t),!this.uploadParamName)throw"指定上传文件控件的name属性";this.uploadParamName=t,this.init()}var t=require("scaffold/path"),i=require("./popupTip"),a=jQuery,n=document,o=a(n.body),l=!!window.FormData,r={process:!1,maxSize:!1,fileFilter:[]},s={BeforeUpload:"beforeupload",Process:"process",Error:"error",Success:"success",Load:"loadlocalfile",Complete:"complete"},m=_.template('<form style="display: inline;" name="{%= formName %}" target="{%= frameName %}" method="post" enctype="multipart/form-data" action="{%= action %}"></form>'),f=_.template('<iframe style="display: none;" name="{%= frameName %}"></iframe>');_.extend(e.prototype,Backbone.Events,{init:function(){if(!l){var e=_.uniqueId("iframe"),t=_.uniqueId("form");this.formEl=a(m({frameName:e,action:this.action,formName:t})),this.iframeEl=a(f({frameName:e}))}this.el.on("change","input[type=file]",_.bind(this.fileUploadChange,this))},resetFormElement:function(e){e.wrap("<form>").parent("form").get(0).reset(),e.unwrap()},fileUploadChange:function(e){function t(e){return e.files?e.files[0]:e.value?{name:e.value,size:0}:void 0}var a=t(e.target);if(a){if(!this.isRightType(a.name)){var n=this.fileFilter.map(function(e){return'"'+e+'"'});return i.show("只能上传 "+n.join("、")+" 文件！"),void this.resetFormElement(this.fileInput)}if(!this.isLowMaxSize(a.size))return i.show("文件太大"),void this.resetFormElement(this.fileInput);this.uploadFile=a,this.trigger(s.Load,a)}},exist:function(e){return!1},isRightType:function(e){var i=t.extname(e),a=this.fileFilter;return!(a.length>0&&0===~a.indexOf(i.toLowerCase()))},isLowMaxSize:function(e){return _.isNumber(this.maxSize)?this.maxSize>=e:!0},setDisable:function(e){e?(this.el.addClass("disabled"),this.fileInput.attr("disabled",!0)):(this.el.removeClass("disabled"),this.fileInput.attr("disabled",null))},post:function(){var e=this;if(e.trigger(s.BeforeUpload),l){var t={type:"post",url:this.action,dataType:"json",contentType:!1,processData:!1,success:function(t){"0"==t.code?e.trigger(s.Success,t.data,e.uploadFile):i.show(t.message)},complete:function(){e.trigger(s.Complete)}},n=new FormData;n.append(e.uploadParamName,this.uploadFile),t.data=n,a.ajax(t)}else e.el.after(e.formEl),e.formEl.append(e.el),o.append(e.iframeEl),e.iframeEl.on("load",function(){var t=a(this).contents().find("body").html();try{t=JSON.parse(t),"0"==t.code?e.trigger(s.Success,t.data,e.uploadFile):i.show(t.message)}catch(n){e.trigger(s.Error,t)}e.trigger(s.Complete),e.formEl.remove(),e.iframeEl.remove()}),e.formEl.submit(),e.formEl.after(e.el);this.resetFormElement(this.fileInput)}});var u=global_config.root,c=image_oss_host,d=global_const.loadingImg,p={action:u+"/Image/uploadImage",fileFilter:[".jpg",".png"],uploadParamName:"image",onSuccess:function(){},onPlacement:function(e,t){a(t.data("target")).html(e)},createItemDom:function(e,t){var i='<li class="item" data-original="'+e.original+'" data-thumbnail="'+e.thumbnail+'"><img class="img" src="'+c.thumbnail+"/"+e.thumbnail+'"></li>';return i}},h={action:u+"/Image/uploadFile",limitNum:null,uploadParamName:"file",fileFilter:[".pdf",".doc",".jpg",".png"],onSuccess:function(e,t){},onPlacement:function(e,t){a(t.data("target")).html(e)},createItemDom:function(e,t){var i='<li class="item" data-filename="'+t.name+'" data-original="'+e.original+'"><a class="filename" href="'+c.original+"/"+e.original+'">'+t.name+'</a><a href="#" class="delete">删除</a></li>';return i}},g=function(t,i){var n=0,o=d.clone().css("margin-left",15),l=new e(a.extend({el:t},i));l.on("loadlocalfile",function(){t.after(o),l.post()}).on("success",function(e,a){i.onSuccess(e,t);var o=i.createItemDom(e,a);i.onPlacement(o,t),n++,i.limitNum&&n>=i.limitNum&&t.hide()}).on("complete",function(){o.remove()}),a(document).on("delete.fileitem",function(e){n--,i.limitNum&&n<i.limitNum&&t.show()}),t.data("fileUploadPlugin",l)};e.globalUploadImage=function(e,t){t=a.extend({},p,t),e.each(function(){g(a(this),t)})},e.globalUploadFile=function(e,t){t=a.extend({},h,t),e.each(function(){g(a(this),t)})},module.exports=e});