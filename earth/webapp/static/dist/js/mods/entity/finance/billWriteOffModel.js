define(function(require,exports,module){var t=global_config.root,i=Backbone.Model.extend({urlRoot:"./match/",actions:{cancel:"./close-bill",submit:"./do-offset",log:"./detail",refresh:t+"/finance/payment-bill-list/query"},defaults:{linkedContractUuid:"",log:{},records:[]},initialize:function(){this.isShow=!1},parse:function(t){if(0==t.code){var i={records:t.data.list};return i}popupTip.show(t.message)},setMode:function(t){this.set("mode",t,{silent:!0})},toggle:function(t){this.isShow?this.foldIn(t):(this.setMode(this.get("writeOff")?"match":"seem"),this.foldOut(t))},foldOut:function(t){t||(t={}),this.isShow=!0,t.silent||this.trigger("foldout"),this.fetch({data:{billEntryType:this.get("billEntryType"),linkedContractUuid:this.get("linkedContractUuid"),writeOffMode:this.get("writeOffMode")}},t)},foldIn:function(t){t||(t={}),this.isShow=!1,t.silent||this.trigger("foldin")},regulate:function(){this.setMode("seem"),this.foldOut()},cancel:function(){var t=this,i={url:this.actions.cancel,type:"post",dataType:"json",data:{billingPlanUuid:this.get("billingPlanUuid")}};i.success=function(i){t.trigger("cancel",i),0==i.code&&t.destroy()},$.ajax(i)},refresh:function(){var t=this,i={url:this.actions.refresh,dataType:"json",data:{billingPlanUuid:this.get("billingPlanUuid")}};i.success=function(i){if(0==i.code){var e=i.data.list[0];e&&t.set(e)}t.trigger("refresh",i)},$.ajax(i)},validateBill:function(t){var i=t.reduce(function(t,i){var e,n;return e="object"==typeof t?t.offSetAmount:t,n="object"==typeof i?i.offSetAmount:i,+e+ +n},0),e=(this.get("amount"),this.get("canTotalWriteOffAmount")),n=i-e;return n>0?(this.trigger("totaloffSetAmount:invalid","冲销金额不能大于流水金额",t),!1):!0},submitBill:function(t,i){var e=this,n=this.get("billingPlanUuid"),l=(this.get("records"),{redBlackBillingUuidPair:{},redBlackOffSetAmountMap:{},unWriteOff:{}});l.unWriteOff[n]=i;for(var o=0,s=[],a={},f=0,r=t.length;r>f;f++){var u=t[f];s.push(u.billingPlanUuid),a[u.billingPlanUuid]=u.offSetAmount,o+=+u.offSetAmount}s.length>0?l.redBlackBillingUuidPair[n]=s:l.redBlackBillingUuidPair=null,$.isEmptyObject(a)?l.redBlackOffSetAmountMap=null:(a[n]=o,l.redBlackOffSetAmountMap=a);var c={url:this.actions.submit,type:"post",dataType:"json",contentType:"application/json",data:JSON.stringify(l)};c.success=function(t){e.trigger("bill:submit",t)},$.ajax(c)},getLog:function(){return this.get("log")},fetchLog:function(t){var i=this,e={url:this.actions.log,type:"get",dataType:"json",data:{billingPlanUuid:this.get("billingPlanUuid")}};e.success=function(e){0==e.code&&i.set("log",e.data,{silent:!0}),t&&t(e,i)},$.ajax(e)}}),e=Backbone.Collection.extend({model:i,initialize:function(){this.isAllShow=!1},toggle:function(t){this.isAllShow?this.foldIn(t):this.foldOut(t)},foldOut:function(t){t||(t={}),this.isAllShow=!0,this.forEach(function(i){i.setMode(i.get("writeOff")?"match":"seem"),i.foldOut(t)}),t.silent||this.trigger("foldout:all")},foldIn:function(t){t||(t={}),this.isAllShow=!1,this.forEach(function(i){i.foldIn(t)}),t.silent||this.trigger("foldin:all")},reset:function(){this.isAllShow=!1,e.__super__.reset.apply(this,arguments)}});exports.BillWriteOffModel=i,exports.BillWriteOffCollection=e});