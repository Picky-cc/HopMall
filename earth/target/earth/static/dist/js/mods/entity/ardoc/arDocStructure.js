define(function(require,exports,module){function t(t,e){if(_.isString(t)?this.structure=JSON.parse(t):this.structure=t,!this._validate(this.structure))throw"模版结构定义不正确";this.options=e||{},this.blocks=[],this.init()}var e=(Backbone.Model.extend({defaults:function(){return{uuid:-1,displayName:"",interalName:"",matchPatterns:"",dataType:"string"}}}),Backbone.Model.extend({initialize:function(t,e){e||(e={}),this.key=e.key},addColumn:function(t){var e=this.get("columns");e[_.uniqueId()]=t,this.set("columns",e)},removeColumn:function(t){var e=this.get("columns"),n=this.getColumn(t),i={};return _.each(e,function(t,e){-1===n.indexOf(t)&&(i[e]=t)}),this.set("columns",i),n},getColumn:function(t,e){var n=this.get("columns"),i=_.map(n,function(t){return t});return _.where(i,t||{})},validate:function(t){return t.uuid&&t.name&&_.isArray(t.columns)?void 0:"error"}}));t.prototype={constructor:t,init:function(){this._extractBlocks(),this.createDetailInfoViewTemplate()},_validate:function(t){return!!(t.uuid&&t.name&&_.isObject(t.documents))},_extractBlocks:function(){var t=this.structure.documents;for(var e in t)this.addBlockStructure(e,t[e]);return this.sortBlocks(),this},sortBlocks:function(){var t=this.blocks,e={a_rentContract:10,b_hostingContract:8,c_assetPackage:6,audit:4};t.sort(function(t,n){var i=e[t.key]||Math.random(),r=e[n.key]||Math.random();return r>i})},createDetailInfoViewTemplate:function(t){t&&(this.options.createDetailViewTmpl=t);var e=this.options.createDetailViewTmpl,n="";return e?(_.isString(e)?n=e:_.isFunction(e)?n=e():_.isElement(e.get(0))&&(n=$(e).html()),this.detailViewTmpl=_.template(n)(this.structure),this.detailViewTmpl):void 0},extractColumnsForTablePlugins:function(){var t=this._extractColumnsInNormalBlocks();return t.normal=_.map(t.normal,function(t,e){return{field:t.interalName,title:t.displayName}}),t.audit=_.map(t.audit,function(t,e){return"auditStatus"==t.interalName?{field:t.interalName,title:"审核状态"}:{field:t.interalName,title:t.displayName}}),t},_extractColumnsInNormalBlocks:function(){for(var t={normal:[],audit:[]},e=this.blocks,n=0,i=e.length;i>n;n++)"audit"===e[n].key?t.audit=t.audit.concat(e[n].getColumn()):t.normal=t.normal.concat(e[n].getColumn());return t},removeBlockByKey:function(t){for(var e=this.blocks,n=[],i=0,r=e.length;r>i;i++)e[i].key===t&&(n=n.concat(e.splice(i,1)));return n},addBlockStructure:function(t,n){var i=new e(n,{key:t});return this.blocks.push(i),i},getBlockStructure:function(t){for(var e=this.blocks,n=0,i=e.length;i>n;n++)if(e[n].key===t)return e[n];return null}},exports.ARDocBlockStructure=e,exports.ARDocTotalStructure=t});