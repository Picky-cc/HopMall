define(function(require,exports,module){var e=require("baseView/tableContent"),t=require("component/popupTip"),i=require("component/dialogView"),l=require("view/baseFormView").FormDialogView,n=require("./cash-flow-audit-entity"),a=require("scaffold/path"),s=(n.CashFlowAuditModel,n.CashFlowAuditCollection),o=n.CashBillModel,h=global_const.loadingImg,r=e.extend({initialize:function(e){r.__super__.initialize.apply(this,arguments),this.initCollection()},onClickExport:function(e){e.preventDefault();var t=this.collectParams(),l=t.tradeStartTime,n=t.tradeEndTime;if(!l||!n){var s=new i;return s.show("请选择入账起止时间!"),void s.on("goahead",function(){this.hide()})}var o=Date.parse(l.replace(/\-/g,"/")),h=Date.parse(n.replace(/\-/g,"/")),r=Math.floor((h-o)/1e3),d=259200;if(r>d){var c=new i;return c.show("时间跨度不允许超过3天！"),void c.on("goahead",function(){this.hide()})}var m=$(e.target).data("action");if(m){var p=this.tableListEl.find("tbody").children(),f=0==p.length||p.first().is(".nomore");if(!f){var u=a.format({path:m,query:t});window.open(u,"_download")}}},initCollection:function(){this.collection=new s,this.listenTo(this.collection,"reset",function(e,t){var i;if(e.length<1)i='<tr><td style="text-align: center;" colspan="100">没有更多数据</td></tr>';else{i=[];for(var l=0,n=e.length;n>l;l++){var a=new d({model:e.at(l)});a.render(),i.push(a.el)}}this.tableListEl.find(" > tbody").html(i)})},refreshTableDataList:function(e,t,i,l){if(e.length<1)this.collection.reset();else{var n=this.polish(e);this.collection.reset(n)}this.trigger("refreshdata.tablelist")}}),d=Backbone.View.extend({tagName:"tr",className:"bill-item",template:_.template($("#tableFieldTmpl").html(),{variable:"obj"}),events:{"click .btn-recharge":"onClickExpend","click .expand-bill":"onClickExpend"},initialize:function(){this.billView=new c({model:this.model}),this.listenTo(this.model,"expand",function(){this.billView.$el.insertAfter(this.$el),this.$el.addClass("z-active")}),this.listenTo(this.model,"collapse",function(){this.billView.$el.remove(),this.$el.removeClass("z-active")})},render:function(){var e=this.model.toJSON(),t=this.template(e);this.$el.html(t)},onClickExpend:function(e){e.preventDefault(),$(e.target).hasClass("btn-recharge")?this.model.set("isRecharge",!0):this.model.set("isRecharge",!1),this.model.toggle()}}),c=Backbone.View.extend({tagName:"tr",className:"bill-card-box",template:_.template($("#CashBillTmpl").html(),{variable:"obj"}),events:{"click .add-bill":"onClickAddBill"},initialize:function(){this.listenTo(this.model.bills,"request",function(){var e=$('<td colspan="1000" style="text-align: center;">');e.append(h.clone()),this.$el.html(e)});var e=this.model.bills;this.listenTo(e,"reset",function(){this.addContent()}),this.listenTo(e,"add",function(){this.addContent()})},addContent:function(){var e=this.model.bills,t=[];if(e.length<1)this.model.set("isRecharge",!0);else for(var i=0;i<e.length;i++){e.at(i).set("isRecharge",this.model.get("isRecharge"));var l=new m({model:e.at(i)});l.render(),t.push(l.el)}var n=$(this.template());n.find(".record-list").append(t),this.model.get("isRecharge")&&n.find(".clearfix ").removeClass("hide"),this.$el.html(n)},render:function(){var e=(this.model.toJSON(),this.template());this.$el.html(e)},onClickAddBill:function(e){e.preventDefault();var t=new o,i=new p({model:t});i.show(),this.listenTo(t,"addbill",function(){this.model.bills.add(t)})}}),m=Backbone.View.extend({tagName:"tr",template:_.template($("#CashBillItemTmpl").html(),{variable:"obj"}),events:{"click .btn-success":"onClickSbumit"},render:function(){var e=this.model.toJSON(),t=this.template(e);this.$el.html(t)},onClickSbumit:function(){t.show("充值账单提交成功！")}}),p=l.extend({template:_.template($("#AddBillDialogTmpl").html()),initialize:function(){p.__super__.initialize.apply(this,arguments)},save:function(){var e=this.extractDomData();this.model.set(e),this.model.trigger("addbill")},submitHandler:function(e){this.save(),this.hide()}});module.exports=r});