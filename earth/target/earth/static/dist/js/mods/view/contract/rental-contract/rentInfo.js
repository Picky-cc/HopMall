define(function(require,exports,module){var e=require("component/areaSelect"),t=require("component/popupTip"),a=require("baseView/baseFormView"),i=require("entity/contract/rentalContractModel").PayStageItemModel,r=require("entity/contract/rentalContractModel").ExtraRuleItemModel,n=require("entity/contract/rentalContractModel").FreeRentStageItemModel,o=a.FieldsetView,l=a.SketchItemView,s=a.FormDialogView,d=jQuery,c=function(e){var t=new Date(e);return t.setDate(t.getDate()+1),t.format("yyyy-MM-dd")},m=function(e){var t=new Date(e);return t.setDate(t.getDate()-1),t.format("yyyy-MM-dd")},h=l.extend({template:_.template(d("#payStageItemTmpl").html()),initialize:function(){h.__super__.initialize.apply(this,arguments);var e=this,t=this.errorLabel=d('<label class="error-abnormal" for="">');this.listenTo(this.model,"payperiod:validate",function(a,i){a?(e.$el.removeClass("error"),t.remove()):e.$el.addClass("error").after(t.show().html(i))})},toDelete:function(e){var t=d(e.target);t.hasClass("disabled")||t.attr("disabled")||this.modelIsLast()&&this.model.destroy()},toEdit:function(){var e=new p({model:this.model});e.show()},remove:function(){this.errorLabel.remove(),h.__super__.remove.apply(this,arguments)}}),u=l.extend({template:_.template(d("#extraRuleItemTmpl").html()),toEdit:function(){var e=new g({model:this.model});e.show()},render:function(){var e=this.model.toJSON(),t=this.model.getAllClauseTypes(),a=_.findWhere(t,{value:e.clauseType});e.clauseTypeAlias=a.name;var i=this.template(e);return this.$el.html(i),this}}),v=l.extend({template:_.template(d("#freeRentStageItemTmpl").html()),initialize:function(){v.__super__.initialize.apply(this,arguments);var e=this,t=this.errorLabel=d('<label class="error-abnormal" for="">');this.listenTo(this.model,"payperiod:validate",function(a,i){a?(e.$el.removeClass("error"),t.remove()):e.$el.addClass("error").after(t.show().html(i))})},toEdit:function(){var e,t,a=this.model.getContractDeadLine(),i={},r=this.model.collection,n=r.indexOf(this.model),o=n-1>=0?r.at(n-1):null,l=n+1<r.length?r.at(n+1):null;e=o?c(o.get("endDate")):a.effectiveTime,t=l?m(l.get("startDate")):a.maturityTime,i.startDatePicker={endDate:t},i.endDatePicker={endDate:t};var s=new y({model:this.model,datepickerOptions:i});s.show()},toDelete:function(e){var t=d(e.target);t.hasClass("disabled")||t.attr("disabled")||this.modelIsLast()&&this.model.destroy()},remove:function(){this.errorLabel.remove(),v.__super__.remove.apply(this,arguments)}}),f=s.extend({className:"modal fade form-modal contract-date-limit",initialize:function(){f.__super__.initialize.apply(this,arguments),this.datepicker=this.$(".beginend-datepicker"),this.initValidator()},initValidator:function(){this.validator=this.$(".form").validate({ignore:"input:disabled",rules:{amountPerMonth:{positiveNumber:!0}},onfocusout:!1,onkeyup:!1,errorPlacement:function(e,t){var a=t.parent();a.is(".parcel-input")?e.insertAfter(a):t.is("[name=paymentPeriod]")||e.insertAfter(t)}})},remove:function(){var e=this.datepicker.data("datepicker");e&&e.remove(),f.__super__.remove.apply(this,arguments)},validate:function(e){var t=this.validator.form();return t},submitHandler:function(e){var t=this._extractDomData(this.$(".real-value"),!0);this.validate(t)&&(this.model.set(t),this.hide())}}),p=f.extend({template:_.template(d("#editPayStageTmpl").html(),{variable:"obj"}),render:function(){var e=this.model,t=e.collection,a=e.toJSON();a.limitDate={},t?a.limitDate={startDate:!1,endDate:t.last()===e}:a.limitDate={startDate:a.startDate&&!1,endDate:!0},this.$el.html(this.template(a))},validate:function(e){var t=this.validator.form(),a=!0,i=this.$(".starttime-datepicker"),r=this.$(".endtime-datepicker");if(e.startDate?i.removeClass("error"):(a=!1,i.addClass("error")),e.endDate?r.removeClass("error"):(a=!1,r.addClass("error")),!a)return a&&t;var n=this.model.getContractDeadLine(),o=this.$("#deadline_error");o.length<1&&(o=d('<label id="deadline_error" class="error-abnormal">'));var l=n.effectiveTime&&new Date(n.effectiveTime)>new Date(e.startDate),s=n.maturityTime&&new Date(n.maturityTime)<new Date(e.endDate);return l||s?(a=!1,l?i.addClass("error"):i.removeClass("error"),s?r.addClass("error"):r.removeClass("error"),this.$(".datetimepick-wrapper").after(o.html("不能超过合同期限("+n.effectiveTime+"至"+n.maturityTime+")"))):(o.remove(),i.removeClass("error"),r.removeClass("error")),a?a&&t:a&&t},_validatePeriodMonth:function(e){if(!e.paymentPeriod)return!1;var t=new Date(e.startDate),a=new Date(e.endDate),i=(a.getFullYear()-t.getFullYear(),a.getMonth()-t.getMonth()+1,this.$("#paymentPeriodLimit_error"));return i.length<1&&(i=d('<label id="paymentPeriodLimit_error" class="error-abnormal">')),this.$("[name=paymentPeriod]").removeClass("error"),i.remove(),!0}}),g=f.extend({template:_.template(d("#editExtraRuleTmpl").html(),{variable:"obj"}),events:{"click [name=fixed]":"onClickFixed","change [name=paymentPeriod]":"onChangePaymentPeriod"},onChangePaymentPeriod:function(e){var t=this.$('[name="payDayInMonth"]'),a=t.find("option").first();-1==d(e.target).val()?(a.get(0).selected=!0,t.get(0).disabled=!0):t.get(0).disabled=!1},onClickFixed:function(e){var t=e.target.checked,a=this.$("[name=amountPerMonth]");t?(a.val(""),a.get(0).disabled=!0):a.get(0).disabled=!1},render:function(){var e=this.model.toJSON();e.clauseTypes=this.model.getRemainClauseTypes();var t=this.template(e);return this.$el.html(t),this}}),y=s.extend({id:"payTimeInputDialog",className:"modal fade form-modal",template:_.template(d("#editFreeRentStageTmpl").html(),{variable:"obj"}),initialize:function(e){y.__super__.initialize.apply(this,arguments),this.validator=this.$(".form").validate(),this.datepicker=this.$(".beginend-datepicker"),global_helperObj.beginEndDatepicker(this.datepicker,e.datepickerOptions)},remove:function(){var e=this.datepicker.data("datepicker");e&&e.remove(),y.__super__.remove.apply(this,arguments)},render:function(){var e=this.model,t=(e.collection,e.toJSON());this.$el.html(this.template(t))},hadStuffDate:function(e,t,a){var i=!0;return e.startDate?t.removeClass("error"):(i=!1,t.addClass("error")),e.endDate?a.removeClass("error"):(i=!1,a.addClass("error")),i},validate:function(e){var t=this.validator.form(),a=!0,i=this.$(".starttime-datepicker"),r=this.$(".endtime-datepicker");return a=this.hadStuffDate(e,i,r),a&&t},submitHandler:function(e){var t=this._extractDomData(this.$(".real-value"));this.validate(t)&&(this.model.set(t),this.hide())}}),D=o.extend({events:{"click .invoicing":"invoicingHandler","click .add-free-rent-stage":"beforeAddSketchViewHandler","click .add-pay-stage":"beforeAddSketchViewHandler","click .add-extra-rule":"beforeAddSketchViewHandler"},initialize:function(t){D.__super__.initialize.apply(this,arguments),this.invoiceForm=this.$(".sub-form");new e({el:this.$(".area-select")});this.sourceModel=t.sourceModel;var a=this.payStageCollection=new Backbone.Collection(this.model.get("rentingIntervalList"),{model:i,sourceModel:t.sourceModel});this.listenTo(a,"add",this.addOnePayStage),this.listenTo(a,"all",function(){this.model.set("rentingIntervalList",a.toJSON())});var o=this.extraRuleCollection=new Backbone.Collection(this.model.get("supplementaryTermInfo").supplementaryTermList,{model:r});this.listenTo(o,"add",function(e){this.addOneExtraRule(e),this.isRemainClauseType()||this.$(".add-extra-rule").parent().hide()}),this.listenTo(o,"remove",function(e){this.$(".add-extra-rule").parent().show()}),this.listenTo(o,"all",function(){var e=this.model.get("supplementaryTermInfo");e.supplementaryTermList=o.toJSON(),this.model.set("supplementaryTermInfo",e)});var l=this.freeRentStageCollection=new Backbone.Collection(this.model.get("freeRentingIntervalList"),{model:n,sourceModel:t.sourceModel});this.listenTo(l,"add",this.addOneFreeRentStage),this.listenTo(l,"all",function(){this.model.set("freeRentingIntervalList",l.toJSON())}),this.addAllPayStage(),this.addAllExtraRule(),this.addAllFreeRentStage()},isRemainClauseType:function(){var e=new r({},{collection:this.extraRuleCollection});return 0!=e.getRemainClauseTypes().length},addOnePayStage:function(e){var t=new h({model:e});this.$(".paystages").append(t.render().$el),this.$(".add-pay-stage").removeClass("error")},addAllPayStage:function(){for(var e=this.payStageCollection,t=0,a=e.length;a>t;t++)this.addOnePayStage(e.at(t));this.isRemainClauseType()||this.$(".add-extra-rule").parent().hide()},addOneExtraRule:function(e){var t=new u({model:e});this.$(".extrarules").append(t.render().$el),this.$(".add-extra-rule").removeClass("error")},addAllExtraRule:function(){for(var e=this.extraRuleCollection,t=0,a=e.length;a>t;t++)this.addOneExtraRule(e.at(t))},addOneFreeRentStage:function(e){var t=new v({model:e});this.$(".free-rent-stage").append(t.render().$el),this.$(".add-free-rent-stage").removeClass("error")},addAllFreeRentStage:function(){for(var e=this.freeRentStageCollection,t=0,a=e.length;a>t;t++)this.addOneFreeRentStage(e.at(t))},clearWritedStage:function(){for(var e=this.payStageCollection;e.length;)e.last().destroy()},clearFreeRentStage:function(){for(var e=this.freeRentStageCollection;e.length;)e.last().destroy()},beforeAddSketchViewHandler:function(e){e.preventDefault();var t=d(e.target),a=this.sourceModel,i=a.contractBasicInfo.toJSON();return i&&i.effectiveTime&&i.maturityTime?void(t.is(".add-pay-stage")?this.addPayStageHandler():t.is(".add-extra-rule")?this.addExtraRuleHandler():t.is(".add-free-rent-stage")&&this.addFreeRentStageHandler()):(a.trigger("contractdate:lack"),void(location.href="#contractDeadlineAnchor"))},addExtraRuleHandler:function(){var e=this.extraRuleCollection,t=this.sourceModel.contractBasicInfo.toJSON(),a={};a.startDate=t.effectiveTime,a.endDate=t.maturityTime;var i=new r(a,{collection:e}),n=new g({model:i});i.once("change",function(){e.add(i)}),n.show()},addPayStageHandler:function(e){var a=this.sourceModel.contractBasicInfo.toJSON(),r=this.payStageCollection,n=r.last(),o={};if(n&&n.get("endDate")===a.maturityTime)return void t.show("合同期限已满");if(n){var l=new Date(n.get("endDate"));l.setDate(l.getDate()+1),o.startDate=l.format("yyyy-MM-dd"),o.endDate=a.maturityTime,o.payDayInMonth=n.get("payDayInMonth")}else o.startDate=a.effectiveTime,o.endDate=a.maturityTime;var s=new i(o,{sourceModel:this.sourceModel}),d=new p({model:s});s.once("change",function(){r.add(s)}),d.show()},addFreeRentStageHandler:function(e){var a=this.sourceModel.contractBasicInfo.toJSON(),i=this.freeRentStageCollection,r=i.last(),o={};if(r&&r.get("endDate")===a.maturityTime)return void t.show("合同期限已满");var l={},s=r?c(r.get("endDate")):null,d=a.maturityTime;l.startDatePicker={startDate:s,endDate:d},l.endDatePicker={startDate:s,endDate:d};var m=new n(o,{sourceModel:this.sourceModel}),h=new y({model:m,datepickerOptions:l});m.once("change",function(){i.add(m)}),h.show()},invoicingHandler:function(e){var t=e.target.checked;t?this.invoiceForm.removeClass("hide"):this.invoiceForm.addClass("hide")},extractDomData:function(){var e=(this.invoiceForm.get(0),this.$(".real-value").not(function(){return d(this).parents(".sub-form").length>0})),t=this._extractDomData(e,!0),a=this.getInvoicingData();return a&&(t.taxInfo=a),t},getInvoicingData:function(){var e=this.$(".invoicing")[0].checked;if(e){var t=this._extractDomData(this.invoiceForm.find(".form-control"));return t.taxType=this.invoiceForm.find("[name=invoice-type]:checked").val(),t}},validate:function(){var e=!0,t=!0,a=!0;return this.$(".paystages").children(".item").length>0?this.$(".add-pay-stage").removeClass("error"):(this.$(".add-pay-stage").addClass("error"),e=!1),e?(t=this.validateStage(this.payStageCollection),e&&t&&a):void 0},validateStage:function(e){for(var t=!0,a=0,i=e.length;i>a;a++)e.at(a).validateStageDate()||(t=!1);if(!t)return t;var r=e.first().isEqualContractStartDate(),n=e.last().isEqualContractEndDate();return t&&r&&n},save:function(){var e=this.extractDomData();e.taxInfo||this.model.unset("taxInfo"),this.model.set(e)}});module.exports=D});