define(function(require,exports,module){var e=(require("component/popupTip"),require("component/fileUpload")),t=require("scaffold/util").validateUtil,i=require("entity/property/propertyModel").OwnerInfomationsModel,a=require("baseView/baseFormView"),n=a.FieldsetView,r=a.SketchItemView,o=a.FormDialogView,l=(global_const.root,o.extend({template:_.template($("#editHostInfoViewTmpl").html(),{variable:"obj"}),className:"modal fade form-modal",events:{"click .ownerType":"switchOwnerPage"},initialize:function(){l.__super__.initialize.apply(this,arguments),this.switchOwnerPage(),this.initValidator(),this.initFileUploader()},initValidator:function(){var e=this;jQuery.validator.addMethod("uniqueCertificateNo",function(t,i){var a=e.getOwnerType(),n=e.$('.personal [name="certificateType"]').val(),r=e.$('.personal [name="certificateNo"]'),o=r.val(),l="0"==a&&"0"==n&&o&&e.model.isIdExist(o);return this.optional(i)||!l},"身份证号不能重复！"),jQuery.validator.addMethod("validateIDCard",function(i,a){var n=e.getOwnerType();if("1"==n)return!0;var r=e.$('.personal [data-params="certificateType"]:visible').val();return"0"==r?this.optional(a)||t.isIDCardValid(i):!0},"您的证件号无法被地球人所识别"),jQuery.validator.addMethod("validateRegistrationLicenseNo",function(i,a){var n=e.getOwnerType();return"0"==n?!0:this.optional(a)||t.regExps.number.test(i)},"您的工商注册执照号无法被地球人所识别"),jQuery.validator.addMethod("validateOwnerName",function(i,a){var n=e.getOwnerType(),r=this.optional(a);return"0"==n?r||t.regExps.chineseCharactor.test(i)||t.regExps.englishName.test(i):r||!t.regExps.includeNumber.test(i)},"业主名称不能是这样的吧"),jQuery.validator.addMethod("validateCertificateType",function(t,i){var a=e.getOwnerType(),n=e.$("[name=certificateType]").val();return"0"==a&&-1!=n?""!==t.trim():!0},"证件号不能为空"),jQuery.validator.addMethod("validateCertificateNo",function(t,i){var a=e.getOwnerType(),n=e.$('.personal [name="certificateNo"]').val();return"0"==a&&""!=n.trim()?-1!=t:!0},"请选择证件类型"),this.validator=this.$(".form").validate({ignore:"[type=file], :hidden",onsubmit:!1,rules:{ownerName:{required:!0,validateOwnerName:!0},certificateNo:{validateRegistrationLicenseNo:!0,validateIDCard:!0,uniqueCertificateNo:!0,validateCertificateType:!0},certificateType:{validateCertificateNo:!0}},errorPlacement:function(e,t){t.is("[name=certificateType]")||e.insertAfter(t)}})},initFileUploader:function(){var t=this;e.globalUploadImage(this.$(".file-input"),{onPlacement:function(e,i){t.$(i.data("target")).html(e)}})},getOwnerType:function(){return this.$(".ownerType:checked").val()},switchOwnerPage:function(){var e=this.$(".ownerType:checked").val();"0"==e?(this.$(".personal").show(),this.$(".enterprise").hide()):(this.$(".personal").hide(),this.$(".enterprise").show())},validate:function(){var e=this.validator.form();return e},extractDomData:function(){var e,t=function(e){var t=e.data();return t?{imgKey:t.original,thumbNailsImgKey:t.thumbnail,imageName:""}:{}},i={};if(i.ownerType=this.$(".ownerType:checked").val(),"0"==i.ownerType){e=this._extractDomData(this.$(".personal [data-params]"),!0);var a=this.$(".front-pic-images .item");a.length>0?e.frontCertificateImg=t(a):e.frontCertificateImg=null;var n=this.$(".back-pic-images .item");n.length>0?e.backCertificateImg=t(n):e.backCertificateImg=null}else{e=this._extractDomData(this.$(".enterprise [data-params]"));var a=this.$(".enterprise-pic-images .item");a.length>0?e.frontCertificateImg=t(a):e.frontCertificateImg=null,e.backCertificateImg=null}return $.extend(i,e),i},submitHandler:function(e){this.validate()&&(this.save(),this.hide())}})),s=r.extend({template:_.template($("#hostSketchInfoViewTmpl").html()),toEdit:function(){var e=new l({model:this.model});e.show()}}),d=n.extend({el:$(".host-info"),events:{"click .add":"onClickAdd"},initialize:function(e){this.sketchListEl=this.$(".sketch-list"),this.collection=new Backbone.Collection(this.model.get("ownerInfomations"),{model:i,completeModel:this.model}),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"all",this.save),this.addAll()},onClickAdd:function(e){e.preventDefault();var t=this,a=new i({},{completeModel:this.model}),n=new l({model:a});a.once("change",function(){t.collection.add(a)}),n.show()},validate:function(){var e=this.collection.length>0;return e?this.$(".add").removeClass("error"):this.$(".add").addClass("error"),e},addOne:function(e){var t=new s({model:e});this.sketchListEl.append(t.render().$el),this.$(".add").removeClass("error")},addAll:function(){for(var e=this.collection,t=0,i=e.length;i>t;t++)this.addOne(e.at(t))},save:function(){var e=this.collection.toJSON();this.model.set("ownerInfomations",e)}});module.exports=d});