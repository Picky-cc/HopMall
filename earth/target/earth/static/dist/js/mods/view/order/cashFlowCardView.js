define(function(require,exports,module){var t=require("entity/order/cashFlowCardModel"),i=require("component/dialogView"),e=require("component/popupTip"),a=require("scaffold/util"),l=jQuery,o=l(document.body),n=Number,s=_.isNumber,c=global_const.loadingImg,r=function(){var t={},i=l("#cashFlowCardItemTmpl"),e=i.html();t.fillCashFlowTrTmplFunc=_.template(e);var o=l(e).find("td").length,n=["<td><input type='text' placeholder='请输入流水号...' class='serial-number'></td>",a.copyStringWithNum(o-1,"<td></td>")].join("");return t.blankBillTrTmpl=_.template(n)(),t.cashFlowCardTmpl=l("#cashFlowCardTmpl").html()||"",t}(l),u=Backbone.View.extend({events:{"click .submit":"submitBill","click .add-bill":"addBill","click .check-bill":"checkBill","blur .reconcile-money-input":"reconcileMoneyInputBlurHandler","focus .reconcile-money-input":"reconcileIptFocus","keyup .serial-number":"getBillHandler","blur .serial-number":"getBillHandler","click .unbind":"unbindContract","click .veto":"vetoCashFlow"},tagName:"tr",className:"bill-card-box",template:_.template(r.cashFlowCardTmpl),initialize:function(t){l.extend(this,_.pick(t,["auditBillUuid","appId","contractId","totalRent","cashFlowItemEl","repaymentAuditStatus"])),this.totalRent=n(this.totalRent.replace(/,/g,"")),this.initModel(t),this.initDialogView(),this.switchView(t.mode);var e=this;this.unbindDialogView=new i({bodyInnerTxt:"确认与改条流水解绑吗？"}),this.listenTo(this.unbindDialogView,"goahead",function(t){e._unbindContract(t)}),this.vetoDialogView=new i({bodyInnerTxt:"确认取消该条流水对账吗？"}),this.listenTo(this.vetoDialogView,"goahead",function(t){e._vetoCashFlow(t)})},initModel:function(i){this.model=new t({auditBillUuid:i.auditBillUuid},i),this.listenTo(this.model,"request",this.wating),this.listenTo(this.model,"sync",this.render),this.listenTo(this.model,"add:cashflow",this.addCashFlowHandler)},addCashFlowHandler:function(t,i){this._processOneCashFlowItemData(t),this.recordList.find(".blank-item").replaceWith(r.fillCashFlowTrTmplFunc({item:t,appId:i.get("appId")})),this.updateTotalAmout()},initDialogView:function(){var t=this,e=this.wrongDialogView=new i;this.listenTo(e,"goahead",function(){e.hide(),t._submitBill(t.collectBillData())});var a=this.succDialogView=new i;this.listenTo(a,"goahead",function(){t.switchView("match"),a.hide()})},render:function(){var t=this.template(this.compactData(this.model.toJSON()));return this.$el.html(t),this.recordList=this.$(".record-list"),this},_processOneCashFlowItemData:function(t){var i=function(t){var i;i=t.showData.amount-("match"===this.viewMode?t.settlementAmount:t.currentSpecificAmount),s(i)||(i=t.showData.amount),t.subtractAmount=Math.min(i,this.totalRent)};null==t.settlementAmount&&(t.settlementAmount=0),null==t.currentSpecificAmount&&(t.currentSpecificAmount=0),i.call(this,t)},compactData:function(t){t.mode=this.viewMode;for(var i,e=t.records,a=0,l=0,o=e.length;o>l;l++)i=e[l],this._processOneCashFlowItemData(i),"VOUCHER_ISSUED"==i.journalVoucherStatus&&(a+=n("undefined"!=typeof i.bookingAmount?i.bookingAmount:i.subtractAmount));return t.totalDebitAmount=a.toFixed(2),t},wating:function(){var t=l('<td colspan="1000" style="text-align: center;">');return t.append(c.clone()),this.$el.html(t),this},checkBill:function(t){var i=l(t.target),e=i.parents(".record-item").find(".reconcile-money-input");this.validateReconcileIpt(e)&&(i.get(0).checked?(this.updateTotalAmout(n(e.val())),e.removeClass("default")):this.updateTotalAmout(-n(e.val())))},updateTotalAmout:function(){function t(){var t=0;return this.$(".record-item").each(function(i,e){var a=l(e);if(a.find(".check-bill").get(0).checked){var o=n(a.find(".reconcile-money-input").val());isNaN(o)||(t+=o)}}),t}var i=this.$(".summary .money"),e=t.call(this);i.html(e.toFixed(2))},reconcileMoneyInputBlurHandler:function(t){this.validateReconcileIpt(l(t.target)),this.updateTotalAmout()},validateReconcileIpt:function(t){var i=+t.data("subtractvalue"),e=t.val().trim();return e=+e,isNaN(e)?(this.toastErrorTip(t,"请输入正确的金额"),!1):e>i?(this.toastErrorTip(t,"对账金额不能大于默认金额"),!1):0>=e?(this.toastErrorTip(t,"对账金额应大于0"),!1):(t.val(e.toFixed(2)),!0)},toastErrorTip:function(t,i){var e=t.prev(".error"),a=12*i.length+30;e.length<1?(e=l('<span class="error">'+i+"</span>"),t.before(e)):e.html(i),e.width(a).addClass("anim-fadeIn");var o=t.data("timer");o&&clearTimeout(o),o=setTimeout(function(){e.fadeOut(500,function(){e.remove()})},4e3),t.data("timer",o)},reconcileIptFocus:function(t){var i=l(t.target);if(i.hasClass("default")){i.val("");i.removeClass("default")}},collectBillData:function(){var t=[],i=this.model.toJSON().records,e=function(t){for(var e=0,a=i.length;a>e;e++)if(i[e].cashFlowUuid==t)return i[e];return null};return this.$(".record-item").each(function(i,a){var o=l(a);if(o.find(".check-bill").get(0).checked){var n=e(o.data("cash_flow_uuid"));n.bookingAmount=o.find(".reconcile-money-input").val(),t.push(n)}}),{appId:this.appId,cashFlowMatchResultList:t,auditBillUuid:this.auditBillUuid}},submitBill:a.execOnceBeforeDone(function(t,i){if(this.validate()){var a=this.collectBillData(),l=this.amoutRelationship(a.cashFlowMatchResultList);l.relationship>0?(e.show("对账金额不能大于账单金额"),i()):l.relationship<0?(this.wrongDialogView.show("账单总金额"+l.amount.toFixed(2)+"元，其中"+l.sum.toFixed(2)+"元本次账单对账成功，剩余"+(l.amount-l.sum).toFixed(2)+"元未完成对账，请确认！"),i()):this._submitBill(a,i)}else i()}),amoutRelationship:function(t){var i=t.reduce(function(t,i){var e,a;return e="object"==typeof t?t.bookingAmount:t,a="object"==typeof i?i.bookingAmount:i,n(e)+n(a)},0);return{relationship:i-this.totalRent,sum:i,amount:this.totalRent}},_submitBill:function(t,i){var a=this;t.cashFlowMatchResultList;t.cashFlowMatchResultList=JSON.stringify(t.cashFlowMatchResultList),l.ajax({url:"./voucher-change",type:"post",data:t,dataType:"json",success:function(t){0==t.code?(a.updateBillItemEl(t.data.auditStatus),a.auditStatus=t.data.auditStatus,a.succDialogView.show("对帐结果提交成功，请确认!")):e.show(t.message)},complete:function(){l.isFunction(i)&&i()}})},updateBillItemEl:function(t){if(this.cashFlowItemEl){var i="";i+='<span class="reconcile-status reconcile-'+t.toLowerCase()+'">'+BillConst.RepaymentAuditStatus[t]+"</span>",this.cashFlowItemEl.find(".audit-cols").html(i),i="",i="CREATE"==t?'<a class="cancel-bill">取消</a>':'<a class="regulate-bill">调账</a>',i+='<a class="expand-bill" href=""><i class="icon icon-expand"></i></a>',this.cashFlowItemEl.find(".operation-cols").html(i)}},switchView:function(t){return this.viewMode=t,"match"===this.viewMode&&"CLOSE"===this.auditStatus?void this.$el.html('<td colspan="1000" style="text-align: center;">没有数据</td>'):void this.model.fetch()},validate:function(){var t=!1,i=this,e=this.$(".record-item");return e.length<1?0:(e.each(function(e,a){var o=l(a);o.find(".check-bill").get(0).checked&&(i.validateReconcileIpt(o.find(".reconcile-money-input"))||(t=!0))}),!t)},addBill:function(t){t.preventDefault(),this.recordList.children().last().is(".blank-item")||this.recordList.append(l('<tr class="blank-item">').html(r.blankBillTrTmpl))},_searchBill:function(t){var i=this;t=l.extend({},{appId:this.appId,auditBillUuid:this.auditBillUuid},t),l.getJSON("./query-cashFlow",t,function(t,a,l){if(0==t.code){var o=t.data.cashFlowMatchResult;if(o){var n=i.model;n.exitsBillPlan(o.cashFlowUuid)?e.show("流水已在列表中"):n.addBillingPlan(o)}else e.show("流水不存在")}else e.show(t.message)})},popupSidebarBillSelectView:function(t){var i=this;if(!i.openingSidebarView){var e=new SidebarBillSelectView(t);i.openingSidebarView=!0,e.on("getbillingplanuuid",function(t){i._searchBill({billingPlanUuid:t})}).on("removefromdomtree",function(){i.openingSidebarView=!1}),e.attachToBody(o).slideIn("right",200)}},getBillHandler:function(t){if(~["blur","focusout"].indexOf(t.type)||"keyup"===t.type&&13===t.keyCode){var i=t.target.value.trim();if(!i)return;this._searchBill({serialNo:i})}},unbindContract:function(t){t.preventDefault();var i=l(t.currentTarget),e=i.parents(".record-item").data("cash_flow_uuid"),a={auditBillUuid:this.auditBillUuid,contractId:this.contractId,cashFlowUuid:e,target:i};this.unbindDialogView.show(a)},_unbindContract:function(t){var i=this;l.post("./unbind-contract",{auditBillUuid:t.auditBillUuid,cashFlowUuid:t.cashFlowUuid,contractId:t.contractId},function(a){a=JSON.parse(a),i.unbindDialogView.hide(),0==a.code?i.clearRecordItem(t.target):e.show(a.message)})},clearRecordItem:function(t){t.parents(".record-item").remove()},vetoCashFlow:function(t){t.preventDefault();var i=l(t.currentTarget),e=i.parents(".record-item").data("cash_flow_uuid"),a={cashFlowUuid:e,target:i};this.vetoDialogView.show(a)},_vetoCashFlow:function(t){var i=this;l.post("./veto-cashFlow",{cashFlowUuid:t.cashFlowUuid},function(a){a=JSON.parse(a),i.vetoDialogView.hide(),0==a.code?i.clearRecordItem(t.target):e.show(a.message)})}});module.exports=u});