define(function(require,exports,module){require("component/autocomplete");var e=require("component/fileUpload"),t=require("baseView/baseFormView"),a=t.FieldsetView,n=t.SketchItemView,i=t.FormDialogView,o=jQuery,r=image_oss_host,s=n.extend({template:_.template(o("#contacterTtemTmpl").html()),toEdit:function(){var e=new c({model:this.model});e.show()}}),l=n.extend({template:_.template(o("#accountItemTmpl").html()),toEdit:function(){var e=new d({model:this.model});e.show()}}),c=i.extend({template:_.template(o("#editContacterTmpl").html(),{variable:"obj"}),initialize:function(){c.__super__.initialize.apply(this,arguments),this.defineValidator()},remove:function(){delete o.validator.methods.repeatMobile,c.__super__.initialize.apply(this,arguments)},defineValidator:function(){var e=this.collection||this.model.collection,t=this.model;o.validator.addMethod("repeatMobile",function(a,n){if(e){var i=e.findWhere({mobile:a});return i===t?!0:this.optional(n)||!i}return!0},"手机号不能重复"),this.validator=this.$(".form").validate({rules:{mobile:{mPhoneExt:!0,repeatMobile:!0}}})},validate:function(){var e=this.validator.form();return e},submitHandler:function(e){if(this.validate()){var t=this._extractDomData(this.$(".real-value"));this.model.set(t),this.hide()}}}),d=i.extend({template:_.template(o("#editAccountTmpl").html(),{variable:"obj"}),events:{"change [name=bankCode]":"onChangeBankSelect"},initialize:function(){c.__super__.initialize.apply(this,arguments),this.defineValidator(),this.bankLogoEl=this.$(".prefix-selectbox .bank-logo"),this.bankLogoUrlPrefix=this.bankLogoEl.data("imgurlprefix")},defineValidator:function(){var e=this.collection||this.model.collection,t=this.model;o.validator.addMethod("repeatAccountNo",function(a,n){if(e){var i=e.findWhere({accountNo:a});return i===t?!0:this.optional(n)||!i}return!0},"付款账号不能重复"),this.validator=this.$(".form").validate({rules:{accountNo:{repeatAccountNo:!0,number:!0}}})},validate:function(){var e=this.validator.form(),t=!0;return this.$("select[name$='bankCode']").val()&&(this.$("input[name$='accountNo']").val()?(this.$("input[name$='accountNo']").removeClass("error"),t=!0):(this.$("input[name$='accountNo']").addClass("error"),t=!1)),this.$("input[name$='accountNo']").val()&&(this.$("select[name$='bankCode']").val()?(this.$("select[name$='bankCode']").parent().removeClass("error"),t=!0):(this.$("select[name$='bankCode']").parent().addClass("error"),t=!1)),e&&t},remove:function(){delete o.validator.methods.repeatAccountNo,c.__super__.initialize.apply(this,arguments)},submitHandler:function(e){if(this.validate()){var t=this._extractDomData(this.$(".real-value"),!0);this.model.set(t),this.hide()}},onChangeBankSelect:function(e){var t=o(e.target).val();if(t){var a=this.bankLogoUrlPrefix+"bank_"+t.toLowerCase()+".png";this.bankLogoEl.attr("src",a),this.bankLogoEl.removeClass("hide")}else this.bankLogoEl.addClass("hide")}}),h=a.extend({events:{"click .radio-box":"onClickRadiobox","click .add-account":"addAccountHandler","click .add-manager":"addManagerHandler"},initialize:function(e){this.initFileUpload(),this.initAutoComplete(),this.tabs=this.$(".btm"),this.deleteTab=this.tabs.children(".hide").detach();var t=this.model.get("partyConcernedInfoList"),a=this.model.get("accountInfoList");0==this.model.get("renterType")?(this.personal_partyConcerneds=new Backbone.Collection(t),this.company_partyConcerneds=new Backbone.Collection,this.personal_accounts=new Backbone.Collection(a),this.company_accounts=new Backbone.Collection,this.addAllManager(this.personal_partyConcerneds),this.addAllAccount(this.personal_accounts)):(this.personal_partyConcerneds=new Backbone.Collection,this.company_partyConcerneds=new Backbone.Collection(t),this.personal_accounts=new Backbone.Collection,this.company_accounts=new Backbone.Collection(a),this.addAllManager(this.company_partyConcerneds),this.addAllAccount(this.company_accounts)),this.listenTo(this.personal_partyConcerneds,"add",this.addOneManager),this.listenTo(this.company_partyConcerneds,"add",this.addOneManager),this.listenTo(this.personal_accounts,"add",this.addOneAccount),this.listenTo(this.company_accounts,"add",this.addOneAccount)},initAutoComplete:function(){var e=this.$(".personal-name"),t=this.$(".company-name"),a={responseData:this.model.get("landLordList"),parcelItem:function(e){var t='<li class="item" data-uuid="'+e.tradePartyUUid+'">'+e.ownerName+"</li>";return t},filter:function(e,t){var a=[];if(!t)return a;for(var n=0;n<e.length;n++)-1!=e[n].ownerName.indexOf(t)&&a.push(e[n]);return a},onSync:function(e,t,a){e.length<1&&a.hide()},onSubmit:o.proxy(function(e,t){var a=t.data("uuid");this.stuffLandlordInfo(a)},this)};e.autocomplete(o.extend({container:e.next(".auto-complete-list")},a)),t.autocomplete(o.extend({container:t.next(".auto-complete-list")},a))},stuffLandlordInfo:function(e){var t=this.model.get("landLordList"),a=_.find(t,{tradePartyUUid:e}),n=function(e){if(o.isEmptyObject(e))return"";var t='<li class="item" data-original="'+e.imgKey+'" data-thumbnail="'+e.thumbNailsImgKey+'"><img class="img" src="'+r.thumbnail+"/"+e.thumbNailsImgKey+'"></li>';return t};if(this.switchTabView(a.ownerType),this.$(".top input[type=radio]").filter(function(){return this.value==a.ownerType}).get(0).checked=!0,this.$("[name=name]").val(a.ownerName),this.$("[name=certificateNo]").val(a.certificateNo),this.$("[name=certificateType]").find("option").each(function(){return this.value===a.certificateType?(this.selected=!0,!1):void 0}),0==a.ownerType){var i=n(a.frontCertificateImg);this.$(".front-pic-images").html(i),i=n(a.backCertificateImg),this.$(".back-pic-images").html(i)}else{var i=n(a.frontCertificateImg);this.$(".enterprise-pic-images").html(i)}this.model.set("tradePartyUuid",a.tradePartyUUid,{silent:!0}),this.model.set("tradePartyId",a.tradePartyId,{silent:!0})},initFileUpload:function(){var t=this;e.globalUploadImage(this.$(".file-input"),{onPlacement:function(e,a){t.$(a.data("target")).html(e)},onSuccess:function(e,t){t.removeClass("error")}})},addAccountHandler:function(e){e.preventDefault();var t,a=this,n=new Backbone.Model;t=0==a.getRenterTypeFromDom()?this.personal_accounts:this.company_accounts;var i=new d({model:n,collection:t});i.show(),n.once("change",function(){t.add(n)})},addOneAccount:function(e){var t=new l({model:e});this.$(".payers").append(t.render().$el),this.$(".add-account").removeClass("error")},addAllAccount:function(e){for(var t=0,a=e.length;a>t;t++)this.addOneAccount(e.at(t))},addManagerHandler:function(e){e.preventDefault();var t,a=this,n=this.initManageModel();t=0==a.getRenterTypeFromDom()?this.personal_partyConcerneds:this.company_partyConcerneds;var i=new c({model:n,collection:t});i.show(),n.once("change",function(){t.add(n)})},initManageModel:function(){var e=new Backbone.Model,t=o('[name="name"]').val();return e.set("name",t,{silent:!0}),e},addOneManager:function(e){var t=new s({model:e});this.$(".contact-persons").append(t.render().$el),this.$(".add-manager").removeClass("error")},addAllManager:function(e){for(var t=0,a=e.length;a>t;t++)this.addOneManager(e.at(t))},getCurTabView:function(){return this.tabs.children(":not(.hide)")},switchTabView:function(e){var t,a=this.getCurTabView();t=0==e?".personal":".company",a.is(t)||(this.deleteTab.removeClass("hide").appendTo(this.tabs),this.deleteTab=a.detach())},onClickRadiobox:function(e){var t=o(e.currentTarget);if(!t.find("input").get(0).disabled){var a=t.find("input[type=radio]").val();this.switchTabView(a)}},getRenterTypeFromDom:function(){var e=this.$("[name=lessee-type]:checked").val();return e},extractDomData:function(){var e=this._extractDomData(this.$(".real-value")),t=function(e){var t=e.children().first().data();return t?{imgKey:t.original,thumbNailsImgKey:t.thumbnail,imageName:""}:{}};return e.renterType=this.getRenterTypeFromDom(),0==e.renterType?(e.partyConcernedInfoList=this.personal_partyConcerneds.toJSON(),e.accountInfoList=this.personal_accounts.toJSON()):(e.partyConcernedInfoList=this.company_partyConcerneds.toJSON(),e.accountInfoList=this.company_accounts.toJSON()),this.$(".upload-imgs").each(function(){var a=o(this);a.hasClass("front-pic-images")?e.frontCertificateImg=t(a):a.hasClass("back-pic-images")?e.backCertificateImg=t(a):a.hasClass("enterprise-pic-images")&&(e.frontCertificateImg=t(a))}),e},validate:function(){var e=!0;return e}});module.exports=h});