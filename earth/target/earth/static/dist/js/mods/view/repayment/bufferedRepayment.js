define(function(require,exports,module){var e=require("baseView/tableContent"),i=require("component/dialogView"),t=require("component/popupTip"),l=_.invert(BillConst.RepaymentStatus),a=e.extend({events:{"click .expand-bill":"operateAuditView","click .regulate-bill":"operateAuditView","click .buffered-repay":"bufferedRepay","click #allExpand":"allExpandHandler"},initialize:function(){a.__super__.initialize.apply(this,arguments);var e=this;this.cancelDialogView=new i({bodyInnerTxt:"确认提交缓冲回款申请？"}),this.listenTo(this.cancelDialogView,"goahead",function(i){e._cancelAudit(i)}),this.on("refreshdata.tablelist",function(){e.clearBillCard(),e.$("#allExpand").html("全部展开").removeClass("expand")})},operateAuditView:function(e){e.preventDefault();var i=$(e.currentTarget),t=i.parents(".bill-item"),l=this._getOrderOptions(t);i.hasClass("expand-bill")?this.expandBill(l,t):i.hasClass("regulate-bill")&&this.regulateBill(l,t)},expandBill:function(e,i){"CREATE"===e.repaymentAuditStatus?e.mode="seem":e.mode="match";var t=this.getCashFlowCardByAuditBillId(e.auditBillUuid);t?this._foldBill(i,e):this._expandBill(i,e)},_expandBill:function(e,i){var t=this.getCashFlowCardByAuditBillId(i.auditBillUuid);return t?t:(t=new CashFlowCardView(i),e.addClass("z-active").after(t.$el),this.setCashFlowCardWithAuditBillId(i.auditBillUuid,t),t)},_foldBill:function(e,i){e.removeClass("z-active"),this.deleteCashFlowCardByAuditBillId(i.auditBillUuid)},_cancelAudit:function(e){var i=this;$.post("./buffered-repay-apply",{repaymentBillUuid:e.repaymentBillUuid},function(e){e=JSON.parse(e),i.cancelDialogView.hide(),i.refresh(),0==e.code?i.refresh():t.show(e.message)})},bufferedRepay:function(e){e.preventDefault();var i=$(e.currentTarget),t=$.extend({},this._getOrderOptions(i.parents(".bill-item")));this.cancelDialogView.show(t)},_getOrderOptions:function(e){var i=e.data("repaymentbilluuid"),t=e.data("appid"),a=e.find(".totalRent").html().trim(),n=l[e.find(".reconcile-status").html().trim()];if(!i)throw"no repaymentBillUuid";return{repaymentBillUuid:i,appId:t,totalRent:a,cashFlowItemEl:e,repaymentStatus:n}},getCashFlowCardByAuditBillId:function(e){return this.cashFlowCardViewList[e]},setCashFlowCardWithAuditBillId:function(e,i){this.cashFlowCardViewList[e]=i},deleteCashFlowCardByAuditBillId:function(e){var i=this.cashFlowCardViewList,t=i[e];return t?(t.remove(),delete i[e],t):void 0},clearBillCard:function(){this.cashFlowCardViewList;this.cashFlowCardViewList={}}});exports.BufferedRepaymentView=a});