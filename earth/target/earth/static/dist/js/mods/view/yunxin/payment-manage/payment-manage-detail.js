define(function(require,exports,module){var e=require("baseView/baseFormView").FormDialogView,t=require("component/dialogView"),a=require("component/popupTip"),i=new t({cancelBtnTxt:"关闭"}),n=global_config.root,o=jQuery,s=e.extend({template:_.template(o("#modifyOverdueStatusTmpl").html(),{variable:"obj"}),actions:{modify:"./confirm-overdue"},events:{"change [name=status]":"onChangeStatus","change [name=selectReason]":"onChangeSelectReason"},initialize:function(e){this.listenTo(this.model,"preChange:status",function(e){2==e?(this.$(".field-overdue-date").removeClass("hide"),this.$("[name=selectReason]").removeClass("hide"),this.$("[name=textareaReason]").addClass("hide")):(this.$(".field-overdue-date").addClass("hide"),this.$("[name=selectReason]").addClass("hide"),this.$("[name=textareaReason]").removeClass("hide"))}),s.__super__.initialize.apply(this,arguments),this.defineValidator()},defineValidator:function(){var e=this;this.validator=this.$(".form").validate({ignore:".hide [name], .hide",rules:{status:"required",textareaReason:{required:!0,maxlength:30},overdueDate:{required:!0}},showErrors:function(t,a){this.defaultShowErrors();var i=!1;a.forEach(function(e){var t=o(e.element);t.is("[name=overdueDate]")&&(i=!0)}),i?e.$("[name=overdueDate]").parent().addClass("error"):e.$("[name=overdueDate]").parent().removeClass("error")},errorPlacement:function(e,t){var a=o(t);a.is("[name=overdueDate]")||e.insertAfter(t)}})},reasonIsCandidate:function(e){return"余额不足"===e},render:function(){var e=this.model.toJSON(),t=e.status;e.reason;this.$el.html(this.template(e)),this.model.trigger("preChange:status",t),this.$("[name=status]").val(t)},validate:function(){return this.validator.form()},onChangeSelectReason:function(e){var t=o(e.target).val().trim();this.reasonIsCandidate(t)?this.$("[name=textareaReason]").addClass("hide"):this.$("[name=textareaReason]").removeClass("hide")},onChangeStatus:function(e){var t=o(e.target).val();this.model.trigger("preChange:status",t)},save:function(){var e=this,t={};t.status=this.$("[name=status]").val();var a=this.$("[name=textareaReason]"),i=this.$("[name=selectReason]");a.is(":visible")?t.reason=a.val():t.reason=i.val();var n=this.$(".field-overdue-date");n.is(":visible")&&(t.overdueDate=n.find("[name=overdueDate]").val());var s={url:this.actions.modify,type:"post",dataType:"json",data:t};s.success=function(a){0==a.code,e.model.trigger("modify:auditOverdue",t,a)},o.ajax(s)},submitHandler:function(e){this.validate()&&(this.save(),this.hide())}}),r=e.extend({template:_.template(o("#modifyRemarkTmpl").html(),{variable:"obj"}),actions:{modify:function(e){return n+"/assets/"+e+"/update-comment"}},initialize:function(){r.__super__.initialize.call(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$(".form").validate({rules:{comment:{required:!0,maxlength:50}}})},validate:function(){return this.validator.form()},save:function(){var e=this,t=this.extractDomData(),a={url:this.actions.modify(this.model.get("assetId")),type:"post",dataType:"json",data:t};a.success=function(a){0==a.code,e.model.trigger("modify:comment",t,a)},o.ajax(a)},submitHandler:function(){this.validate()&&(this.save(),this.hide())}}),d=e.extend({template:_.template(o("#refundTmpl").html(),{variable:"obj"}),actions:{refund:function(e){return n+"/assets/"+e+"/update-refund"}},initialize:function(){d.__super__.initialize.call(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$(".form").validate({rules:{comment:{required:!0,maxlength:30},refundAmount:{required:!0,nonNegativeNumber:!0,max:this.model.get("amount")?+this.model.get("amount"):!1}},messages:{refundAmount:{max:o.validator.format("退款金额不超过还款金额 {0} 元")}},errorPlacement:function(e,t){o(t).is("[name=refundAmount]")?o(t).parent().append(e):e.insertAfter(t)}})},validate:function(){return this.validator.form()},save:function(){var e=this,t=this.extractDomData(),a={url:this.actions.refund(this.model.get("assetId")),type:"post",dataType:"json",data:t};a.success=function(a){0==a.code,e.model.trigger("modify:refundAmount",t,a)},o.ajax(a)},submitHandler:function(){this.validate()&&(this.save(),this.hide())}}),l=Backbone.View.extend({el:".content",events:{"click #preAuditOverdue":"onClickPreAuditOverdue","click #modifyRemark":"onClickModifyRemark","click #btnRefund":"onClickBtnRefund"},initialize:function(e){this.initModel(e.assetId)},initModel:function(e){var t={};t.assetId=e,t.status=this.$("[name=overdueStatus]").val().trim(),t.refundAmount=+this.$(".refund-amount").data("value"),t.amount=+this.$(".amount").data("value"),t.comment=this.$(".comment").text().trim(),t.assetRecycleDate=this.$(".asset-recycle-date").text().trim(),t.actualRecycleDate=this.$(".actual-recycle-date").text().trim(),this.model=new Backbone.Model(t)},onClickPreAuditOverdue:function(e){e.preventDefault();var t=new s({model:this.model});this.model.once("modify:auditOverdue",function(e,t){0==t.code?(i.controlOperateBtns({excludeGoahed:!0,excludeCancel:!0}).show("操作成功"),setTimeout(function(){location.reload()},1e3)):i.controlOperateBtns({excludeGoahed:!0}).show(t.message||"操作失败，请重试")}),t.show()},onClickModifyRemark:function(e){e.preventDefault();var t=new r({model:this.model});this.model.once("modify:comment",function(e,t){0==t.code?(a.show("操作成功"),setTimeout(function(){location.reload()},1e3)):a.show(t.message||"操作失败，请重试")}),t.show()},onClickBtnRefund:function(e){e.preventDefault();var t=new d({model:this.model});this.model.once("modify:refundAmount",function(e,t){0==t.code?(a.show("操作成功"),setTimeout(function(){location.reload()},1e3)):a.show(t.message||"操作失败，请重试")}),t.show()}});module.exports=l});