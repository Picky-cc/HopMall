define(function(require,exports,module){var e=(require("scaffold/path"),require("component/dialogView")),t=require("component/popupTip"),i=require("baseView/baseFormView"),a=i.FormDialogView,n=new e,s=jQuery,o=global_config.root,r=a.extend({template:_.template(s("#addQuestionnaire").html()),id:"addQuesDialog",className:"modal fade form-modal",events:{"change  select":"onclickChangetype"},initialize:function(e){this.categorys=e.categorys,r.__super__.initialize.apply(this,arguments),this.defineValidator()},render:function(){var e=this.model.toJSON();e.categorys=this.categorys,this.$el.html(this.template(e))},defineValidator:function(){this.validator=this.$(".form").validate({rules:{type:"required"},ignore:":disabled"})},validate:function(){return this.validator.form()},submitHandler:function(e){e.preventDefault(),this.validate()&&(this.save(),this.hide())},onclickChangetype:function(e){var t=s(e.target).val();"自定义类别"==t?this.$("input").removeAttr("disabled"):this.$("input").attr("disabled",!0)}}),l=Backbone.View.extend({el:".form-wrapper",events:{"click .btn-questionnaire":"onClickAddquestionnaire","click .del-questionnaire":"onClickDelquestionnaire","click .submit":"onclickSubmit"},quesItemTmpl:_.template(s("#ItemQuestionnaire").html()),initialize:function(e){this.customerUuid=e;try{this.categorys=JSON.parse(this.$("[name=categorys]").val())||[]}catch(t){this.categorys=[]}},onClickAddquestionnaire:function(e){e.preventDefault();var t=this,i=new Backbone.Model,a=new r({model:i,categorys:this.categorys});a.show(),i.once("change",function(){var e,a=i.toJSON(),n=t.quesItemTmpl(a);if(s(".hd").each(function(){var t=s(this);t.text()!==a.type&&t.text()!==a.text||(e=t.parent().find(".bd"))}),e)e.append(n);else{var o='<fieldset class="register-info fieldset-group"><h5 class="hd questionnaire-list"></h5>'+n+'<div class="bd"></div></fieldset>';t.$(".submit").parents("fieldset").before(o),t.$("fieldset:last").prev().find("h5").text(a.text),t.categorys.push(a.text)}})},onClickDelquestionnaire:function(e){e.preventDefault();var t=s(e.target).parents(".filed-block"),i=t.find("input").val();i?(n.show("该问题已有答案，是否继续删除？"),this.listenTo(n,"goahead",function(e){t.remove(),n.hide()})):t.remove()},validate:function(){var e=!0,t=this.$(".multiline-input");return t.each(function(){""===s(this).val().trim()?(s(this).addClass("error"),e=!1):s(this).removeClass("error")}),e},onclickSubmit:function(e){e.preventDefault(),this.validate()&&this.save()},save:function(){var e={};e.definition=s(".questionnaire-tittle").parent().find("textarea").val(),e.qaMap=[],this.$(".questionnaire-list").each(function(){var t={};t.type=s(this).text(),t.qas=[],s(this).parent().find(".field-value").each(function(){var e={};e.question=s(this).find("textarea").val(),e.answer=s(this).find("input").val(),t.qas.push(e)}),e.qaMap.push(t)});var i={url:o+"/preloan/customer/configure",data:{k:"questionnaire",questionnaire:JSON.stringify(e),customerUuid:this.customerUuid},type:"post",dataType:"JSON"},a=this;i.success=function(e){0==e.code?(t.show("成功，正在跳转"),setTimeout(function(){location.href=o+"/preloan/customer?k=questionnaire&customerUuid="+a.customerUuid},1500)):t.show(e.message)},s.ajax(i)}});module.exports=l});