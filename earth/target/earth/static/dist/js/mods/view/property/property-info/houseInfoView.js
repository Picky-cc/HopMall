define(function(require,exports,module){var e=require("scaffold/util").validateUtil,t=require("entity/property/propertyModel").LeasingUnitAppendixsModel,i=(require("component/popupTip"),require("component/fileUpload")),a=require("baseView/baseFormView"),n=a.FieldsetView,o=a.SketchItemView,l=a.FormDialogView,s=(global_const.root,e.regExps),r=JSON.parse($("#stationTypeSizePriceMap").val()||"{}"),d=l.extend({template:_.template($("#editHouseInfoViewTmpl").html(),{variable:"obj"}),className:"modal fade form-modal",events:{"click .limit":"onClickRenterSexLimit","click .checkAllUtilites":"onToggleCheckAllUtilites"},initialize:function(e){this.isUpdate=e.isUpdate,d.__super__.initialize.apply(this,arguments),this.initFileUploader(),this.initValidator()},initValidator:function(){var e=this;jQuery.validator.addMethod("uniqueLeasingSubjectMatterName",function(t,i){var a=e.model.isLeasingSubjectMatterNameUnique(t.trim());return this.optional(i)||!a},"出租单元名称已存在"),this.validator=this.$(".form").validate({ignore:".hide [name], [type=file]",onsubmit:!1,groups:{houseType:"roomNum hallNum bathroomNum kitchenNum"},rules:{roomNum:"nonNegativeInteger",hallNum:"nonNegativeInteger",bathroomNum:"nonNegativeInteger",kitchenNum:"nonNegativeInteger",buildArea:"money",leasingSubjectMatterName:{required:!0,uniqueLeasingSubjectMatterName:!0}},messages:{roomNum:{nonNegativeInteger:"请输入正确的配置信息哦~"},hallNum:{nonNegativeInteger:"请输入正确的配置信息哦~"},bathroomNum:{nonNegativeInteger:"请输入正确的配置信息哦~"},kitchenNum:{nonNegativeInteger:"请输入正确的配置信息哦~"},buildArea:{money:"请输入正确的房间面积哦~"},promotionTitle:{minlength:"您的字数未达标"},promotionContent:{minlength:"您的字数未达标"}},errorPlacement:function(e,t){var i=t.parent(),a=t.attr("name");~["roomNum","hallNum","bathroomNum","kitchenNum"].indexOf(a)?i.parent().append(e):i.is(".parcel-input")?e.insertAfter(i):e.insertAfter(t)}})},initFileUploader:function(){var e=this.$(".roomImages"),t=this.$(".file-input");i.globalUploadImage(t,{limitNum:8,onPlacement:function(i,a){e.append(i),e.children().length>=8&&t.hide()}})},render:function(){var e=this.model.toJSON();e.isUpdate=this.isUpdate,this.$el.html(this.template(e))},validate:function(){return this.validator.form()},submitHandler:function(e){this.validate()&&(this.save(),this.hide())},extractDomData:function(){var e=function(e){var t=e.data();return t?{imgKey:t.original,thumbNailsImgKey:t.thumbnail,imageName:""}:{}},t=this._extractDomData(this.$("[data-params]")),i=[],a=[];this.$("input.utilitiesAndAmenity:checked").each(function(){var e=$(this),t=e.attr("value"),n=e.attr("alias"),o={};o.name=t,o.alias=n,i.push(o),a.push(n)}),t.utilitiesAndAmenityDesc=a.join("/"),t.utilitiesandAmenities=i;var n=[];this.$(".roomImages .item").each(function(){n.push(e($(this)))}),t.roomImgList=n;var o=this.$(".limit:checked").val();return t.limit=null==o?"none":o,"undefined"==typeof t.leasingSubjectMatterName&&(t.leasingSubjectMatterName=""+this.model.get("index")),t},onClickRenterSexLimit:function(e){var t=$(e.target).val(),i="man"==t?"women":"man";this.$("."+i).removeAttr("checked")},onToggleCheckAllUtilites:function(e){var t=e.target.checked;this.$(".house-support .utilitiesAndAmenity").each(function(){this.checked=t})}}),h=l.extend({template:_.template($("#editBusinessSpaceViewTmpl").html(),{variable:"obj"}),className:"modal fade form-modal",events:{"click #delete":"onDeleteItem","click #add":"onAddItem","change .type-select":"changeType"},initialize:function(e){this.isUpdate=e.isUpdate,h.__super__.initialize.apply(this,arguments),this.initFileUploader(),this.initValidator()},initValidator:function(){var e=this;jQuery.validator.addMethod("uniqueLeasingSubjectMatterName",function(t,i){var a=e.model.isLeasingSubjectMatterNameUnique(t.trim());return this.optional(i)||!a},"出租单元名称已存在"),this.validator=this.$(".form").validate({rules:{stationType:"required",leasingSubjectMatterName:{required:!0,uniqueLeasingSubjectMatterName:!0}}})},initFileUploader:function(){var e=this.$(".upload-imgs"),t=this.$(".file-input");i.globalUploadImage(this.$(".file-input"),{limitNum:8,onPlacement:function(i,a){e.append(i),e.children().length>=8&&t.hide()}})},extractDomData:function(){var e=function(e){var t=e.data();return t?{imgKey:t.original,thumbNailsImgKey:t.thumbnail,imageName:""}:{}},t=this,i=this._extractDomData(this.$(".real-value")),a=[];this.$(".upload-imgs").children().each(function(){a.push(e($(this)))}),i.stationImgList=a;var n=[];return this.$(".profession").each(function(){var e=$(this),i=t._extractDomData(e.find("[name]")),a=e.find(".type-and-money").val();if(a){var o=a.split("-");i.stationSize=o[0],i.price=o[2],i.stationSizeOrdianl=o[0]}n.push(i)}),i.stationList=n,"undefined"==typeof i.leasingSubjectMatterName&&(i.leasingSubjectMatterName=""+this.model.get("index")),i},render:function(){var e=this.model.toJSON();e.stationType=r,e.isUpdate=this.isUpdate,this.$el.html(this.template(e))},onDeleteItem:function(e){var t=$(e.target),i=t.parents(".profession");i.remove()},onAddItem:function(e){var t=$(e.target),i=t.parents(".profession").clone();i.find("a").attr("id","delete").text("删除"),i.find("label").hide(),i.find("select").removeClass("error"),i.find("input").val("1"),this.changeType({target:i.find("select").get(0)}),i.appendTo(".professions")},validate:function(){var e=!0;return this.$("[name=available]").each(function(){var t=$(this).val();t&&s.positiveInteger.test(t)?$(this).removeClass("error"):($(this).addClass("error"),e=!1)}),this.validator.form()&&e},changeType:function(e){var t=$(e.target);if("0"==t.val()){for(var i=r.Open,a=[],n=0;n<i.length;n++){var o="<option value="+i[n].stationSizeOrdianl+"-"+i[n].stationSize+"-"+i[n].priceDes+">"+i[n].desc+"</option>";a.push(o)}t.next().html(a.join(""))}else if("1"==t.val()){for(var l=r.Private,a=[],n=0;n<l.length;n++){var o="<option value="+l[n].stationSizeOrdianl+"-"+l[n].stationSize+"-"+l[n].priceDes+">"+l[n].desc+"</option>";a.push(o)}t.next().html(a.join(""))}},submitHandler:function(e){this.validate()&&(this.save(),this.hide())}}),m=o.extend({template:_.template($("#itemHouseViewTmpl").html()),render:function(){var e=this.model.toJSON();if(e.type=this.model.getLeaseTypeDesc(),"创业空间"==e.type){var t=e.stationList[0],i=[];if("0"==t.stationType)for(var a=r.Open,n=0;n<a.length;n++)a[n].stationSizeOrdianl==t.stationSizeOrdianl&&i.push("开放空间",a[n].desc,"*",t.available,"...");else if("1"==t.stationType)for(var o=r.Private,n=0;n<o.length;n++)o[n].stationSizeOrdianl==t.stationSizeOrdianl&&i.push("独立空间",o[n].desc,"*",t.available,"...");e.supportDesc=i.join(" ")}var l=this.template(e);return this.$el.html(l),this},toEdit:function(){var e,t=this.model.getLeaseTypeDesc();e="创业空间"==t?new h({model:this.model,isUpdate:!0}):new d({model:this.model,isUpdate:!0}),e.show()}}),c=n.extend({el:$(".house-info"),events:{"click .add":"onClickAdd"},initialize:function(e){this.sketchListEl=this.$(".sketch-list"),this.collection=new Backbone.Collection(this.model.get("leasingUnitAppendixs"),{model:t,completeModel:this.model}),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"all",this.save),this.addAll()},onClickAdd:function(e){e.preventDefault();var i,a=this,n={index:this.collection.length+1},o=this.model.getLeaseTypeDesc(),l=new t(n,{completeModel:this.model});i="创业空间"==o?new h({model:l}):new d({model:l}),l.once("change",function(){a.collection.add(l)}),i.show()},validate:function(){var e=this.collection.length>0;return e?this.$(".add").removeClass("error"):this.$(".add").addClass("error"),e},reSortRoomNo:function(){this.collection.each(function(e,t){e.set({index:t+1})})},addOne:function(e){var t=new m({model:e});this.sketchListEl.append(t.render().$el),this.$(".add").removeClass("error")},addAll:function(){for(var e=this.collection,t=0,i=e.length;i>t;t++)this.addOne(e.at(t))},save:function(){var e=this.collection.toJSON();this.model.set("leasingUnitAppendixs",e)}});module.exports=c});