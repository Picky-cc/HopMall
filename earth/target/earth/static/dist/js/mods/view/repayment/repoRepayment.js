define(function(require,exports,module){var t=require("baseView/tableContent"),e=require("component/dialogView"),a=require("component/popupTip"),i=require("scaffold/util"),n=t.extend({events:{"click .add-bill":"addBill","click .repo-delete":"deleteRepo","click .submit":"submitBill","keyup .contract-number":"getBillHandler","blur .contract-number":"getBillHandler","keyup .repo-amount":"validateAmount","blur .repo-amount":"validateAmount","change select":"_queryByParams"},initialize:function(){this.recordList=this.$(".record-list"),this.initDialogView()},addBill:function(t){t.preventDefault();var e=1;this.recordList.children().last().is(".blank-item")&&(e=Number(this.recordList.children().last().children().first().html())+1);var a=["<td>"+e+"</td>","<td><input type='text' placeholder='请输入租约编号...' class='contract-number'></td>","<td><input type='text' placeholder='' class='app-name' disabled='disabled'></td>","<td><input type='text' placeholder='' class='house-number' disabled='disabled'></td>","<td><input type='text' placeholder='' class='repo-amount'></td>","<td><a href='javascript:void(0)' class='repo-delete'>删除</a></td>"].join("");this.recordList.append($('<tr class="blank-item">').html(a))},deleteRepo:function(t){var e=$(t.target);e.parents(".blank-item").remove(),this.updateTotalAmout()},getBillHandler:function(t){if(~["blur","focusout"].indexOf(t.type)||"keyup"===t.type&&13===t.keyCode){var e=t.target.value.trim();if(!e)return;this._searchBill({contractNo:e,tar:t.target})}},_searchBill:function(t){var e=this,i=t.tar;t={contractNo:t.contractNo},$.getJSON("./query-contract",t,function(t,n,o){if(0==t.code){var r=t.data.contract;r?e.addContractHandler({contract:r,tar:i}):(a.show("合同不存在"),$(i).val(""))}else a.show(t.message),$(i).val("")})},addContractHandler:function(t){var e=$(t.tar);e.attr("contractid",t.contract.id),e.parents(".blank-item").find(".app-name").val(t.contract.app.name),e.parents(".blank-item").find(".house-number").val(t.contract.house.community)},validateAmount:function(t){if(~["blur","focusout"].indexOf(t.type)||"keyup"===t.type&&13===t.keyCode){var e=t.target.value.trim(),i=/^([1-9][\d]{0,7}|0)(\.[\d]{1,2})?$/;if(!e)return;if(!i.test(e))return a.show("请正确填写回购金额！"),$(t.target).val(""),void this.updateTotalAmout();this.updateTotalAmout()}},addBillingPlanHandler:function(t,e){this._processOneBillItemData(t),this.recordList.find(".blank-item").replaceWith(templateStorage.fillBillTrTmplFunc({item:t,appId:e.get("appId")})),this.updateTotalAmout()},initDialogView:function(){var t=this,a=this.wrongDialogView=new e;this.listenTo(a,"goahead",function(){a.hide(),t._submitBill(t.collectBillData())});var i=this.succDialogView=new e;this.listenTo(i,"goahead",function(){i.hide()})},_processOneBillItemData:function(t){var e=function(t){var e;e=t.receivableAmount-("match"===this.viewMode?t.settlementAmount:t.currentSpecificAmount),isNumber(e)||(e=t.receivableAmount),t.subtractAmount=Math.min(e,this.amount)},a=function(t){var e=[],a=[],i=t.showData.accountAndNameMap||{};$.each(i,function(t,i){e.push(t),a.push(i)}),t.showData.accountName=a.join(", "),t.showData.accountNo=e.join(", ")};if(null==t.receivableAmount)throw"该条记录错误，没有应付金额";null==t.settlementAmount&&(t.settlementAmount=0),null==t.currentSpecificAmount&&(t.currentSpecificAmount=0),e.call(this,t),a.call(this,t)},compactData:function(t){t.mode=this.viewMode;for(var e,a=t.records,i=0,n=0,o=a.length;o>n;n++)e=a[n],this._processOneBillItemData(e),"VOUCHER_ISSUED"==e.journalVoucherStatus&&(i+=toNumber("undefined"!=typeof e.bookingAmount?e.bookingAmount:e.subtractAmount));return t.totalDebitAmount=i.toFixed(2),t},checkBill:function(t){var e=$(t.target),a=e.parents(".record-item").find(".reconcile-money-input");this.validateReconcileIpt(a)&&(e.get(0).checked?(this.updateTotalAmout(toNumber(a.val())),a.removeClass("default")):this.updateTotalAmout(-toNumber(a.val())))},updateTotalAmout:function(){function t(){var t=0;return this.$(".blank-item").each(function(e,a){var i=$(a),n=Number(i.find(".repo-amount").val());isNaN(n)||(t+=n)}),t}var e=this.$(".summary .money"),a=t.call(this);e.html(a.toFixed(2))},reconcileMoneyInputBlurHandler:function(t){this.validateReconcileIpt($(t.target)),this.updateTotalAmout()},validateReconcileIpt:function(t){var e=t.children().first().html(),i=t.find(".contract-number").val().trim(),n=t.find(".app-name").val().trim(),o=t.find(".house-number").val().trim(),r=t.find(".repo-amount").val().trim();return i&&n&&o?(r=+r,isNaN(r)?(a.show("请正确输入"+e+"号租约的回购金额"),!1):!0):(a.show("请正确输入"+e+"号租约"),!1)},toastErrorTip:function(t,e){var a=t.prev(".error"),i=12*e.length+30;a.length<1?(a=$('<span class="error">'+e+"</span>"),t.before(a)):a.html(e),a.width(i).addClass("anim-fadeIn");var n=t.data("timer");n&&clearTimeout(n),n=setTimeout(function(){a.fadeOut(500,function(){a.remove()})},4e3),t.data("timer",n)},reconcileIptFocus:function(t){var e=$(t.target);if(e.hasClass("default")){e.val("");e.removeClass("default")}},collectBillData:function(){var t=this.$("#repoMode").val(),e=Number(this.$(".summary .money").html()),a=this.$(".datetimepicker-form-control").val(),i=this.$(".blank-item"),n="",o="";return i.each(function(t,e){var a=$(e);n+=a.find(".contract-number").attr("contractid")+",",o+=a.find(".repo-amount").val().trim()+","}),{repoMode:t,totalAmount:e,repoTime:a,contractIds:n,amounts:o}},submitBill:i.execOnceBeforeDone(function(t,e){if(this.validate()){var a=Number(this.$(".summary .money").html()),i=this.$(".datetimepicker-form-control").val();this.wrongDialogView.show("回购总金额"+a+"元，回购时间"+i+"，请确认"),e()}else e()}),validate:function(){var t=!1,e=this,i=this.$(".blank-item");if(i.length<1)return 0;i.each(function(t,a){var i=$(a);return e.validateReconcileIpt(i)?void 0:!1});var n=Number(this.$(".summary .money").html());if(0>=n)return a.show("请完整添加一条回购记录"),!1;var o=this.$("#repoMode").val();if(!o)return a.show("请选择回购模式"),!1;var r=this.$(".datetimepicker-form-control").val();return r?!t:(a.show("请填写回购时间"),!1)},amoutRelationship:function(t){var e=t.reduce(function(t,e){var a,i;return a="object"==typeof t?t.bookingAmount:t,i="object"==typeof e?e.bookingAmount:e,toNumber(a)+toNumber(i)},0);return{relationship:e-this.amount,sum:e,amount:this.amount}},_submitBill:function(t,e){var i=this;$.ajax({url:"./repo-repay-apply",type:"post",data:t,dataType:"json",success:function(t){0==t.code?i.succDialogView.show("回购回款提交成功!"):a.show(t.message)},complete:function(){$.isFunction(e)&&e()}})},updateBillItemEl:function(t){if(this.billItemEl){var e="";e+='<span class="reconcile-status reconcile-'+t.toLowerCase()+'">'+DebitCashFlowConst.AuditStatus[t]+"</span>",this.billItemEl.find(".audit-cols").html(e),e="",e="CREATE"==t?'<a class="cancel-bill">取消</a>':'<a class="regulate-bill">调账</a>',e+='<a class="detail-bill">详情</a>',this.billItemEl.find(".operation-cols").html(e)}},popupSidebarBillSelectView:function(t){var e=this;if(!e.openingSidebarView){var a=new SidebarBillSelectView(t);e.openingSidebarView=!0,a.on("getbillingplanuuid",function(t){e._searchBill({billingPlanUuid:t})}).on("removefromdomtree",function(){e.openingSidebarView=!1}),a.attachToBody($body).slideIn("right",200)}},_queryByParams:function(){}});exports.RepoRepaymentView=n});