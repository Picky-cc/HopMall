define(function(require,exports,module){require("component/autocomplete");var e=require("component/fileUpload"),t=require("baseView/baseFormView"),a=t.FieldsetView,n=t.SketchItemView,i=t.FormDialogView,o=global_config.root,r=jQuery,s=image_oss_host,c=n.extend({template:_.template(r("#contacterTtemTmpl").html()),toEdit:function(){var e=new d({model:this.model});e.show()}}),l=n.extend({template:_.template(r("#accountItemTmpl").html()),toEdit:function(){var e=new h({model:this.model});e.show()}}),d=i.extend({template:_.template(r("#editContacterTmpl").html(),{variable:"obj"}),initialize:function(){d.__super__.initialize.apply(this,arguments),this.defineValidator(),this.initAutoComplete()},initAutoComplete:function(){var e=this.$(".party-concerned-name"),t={action:o+"/party-concerned/search",parse:function(e){return 0==e.code?e.data.list:[]},search:function(){return{}},parcelItem:function(e){var t=void 0!==e.mobile&&"("+e.mobile+")",a="<li class='item' data-uuid="+e.partyConcernedUuid+">"+e.name+t+"</li>";return r.data(document.body,e.partyConcernedUuid,e),a},onSync:function(e,t,a){e.length<1&&a.hide()},onSubmit:r.proxy(function(e,t){var a=t.data("uuid"),n=r.data(document.body,a);this.fillPartyConcernedInfo(n)},this)};e.autocomplete(r.extend({container:e.next(".auto-complete-list")},t))},fillPartyConcernedInfo:function(e){this.model.set("partyConcernedId",e.partyConcernedId,{silent:!0}),this.model.set("partyConcernedUuid",e.partyConcernedUuid,{silent:!0}),this.$('[name="name"]').val(e.name),this.$('[name="mobile"]').val(e.mobile),this.$("#isBroker")[0].checked=e.broker},remove:function(){delete r.validator.methods.repeatMobile,d.__super__.initialize.apply(this,arguments)},defineValidator:function(){var e=this.collection||this.model.collection,t=this.model;r.validator.addMethod("repeatMobile",function(a,n){if(e){var i=e.findWhere({mobile:a});return i===t?!0:this.optional(n)||!i}return!0},"手机号不能重复"),this.validator=this.$(".form").validate({rules:{mobile:{mPhoneExt:!0,repeatMobile:!0}}})},validate:function(){var e=this.validator.form();return e},submitHandler:function(e){if(this.validate()){var t=this._extractDomData(this.$(".real-value"));t.broker=this.$("input[type=checkbox]")[0].checked,this.model.set(t),this.hide()}}}),h=i.extend({template:_.template(r("#editAccountTmpl").html(),{variable:"obj"}),events:{"change [name=bankCode]":"onChangeBankSelect"},initialize:function(){d.__super__.initialize.apply(this,arguments),this.defineValidator(),this.bankLogoEl=this.$(".prefix-selectbox .bank-logo"),this.bankLogoUrlPrefix=this.bankLogoEl.data("imgurlprefix")},defineValidator:function(){var e=this.collection||this.model.collection,t=this.model;r.validator.addMethod("repeatAccountNo",function(a,n){if(e){var i=e.findWhere({accountNo:a});return i===t?!0:this.optional(n)||!i}return!0},"付款账号不能重复"),this.validator=this.$(".form").validate({rules:{accountNo:{repeatAccountNo:!0,number:!0}}})},validate:function(){var e=this.validator.form(),t=!0;return this.$("select[name$='bankCode']").val()&&(this.$("input[name$='accountNo']").val()?(this.$("input[name$='accountNo']").removeClass("error"),t=!0):(this.$("input[name$='accountNo']").addClass("error"),t=!1)),this.$("input[name$='accountNo']").val()&&(this.$("select[name$='bankCode']").val()?(this.$("select[name$='bankCode']").parent().removeClass("error"),t=!0):(this.$("select[name$='bankCode']").parent().addClass("error"),t=!1)),e&&t},remove:function(){delete r.validator.methods.repeatAccountNo,d.__super__.initialize.apply(this,arguments)},submitHandler:function(e){if(this.validate()){var t=this._extractDomData(this.$(".real-value"),!0);this.model.set(t),this.hide()}},onChangeBankSelect:function(e){var t=r(e.target).val();if(t){var a=this.bankLogoUrlPrefix+"bank_"+t.toLowerCase()+".png";this.bankLogoEl.attr("src",a),this.bankLogoEl.removeClass("hide")}else this.bankLogoEl.addClass("hide")}}),u=a.extend({events:{"click .radio-box":"switchTabView","click .add-account":"addAccountHandler","click .add-manager":"addManagerHandler"},initialize:function(e){this.initFileUpload(),this.initAutoComplete(),this.tabs=this.$(".btm"),this.deleteTab=this.tabs.children(".hide").detach();var t=this.model.get("partyConcernedInfoList"),a=this.model.get("accountInfoList");0==this.model.get("renterType")?(this.personal_partyConcerneds=new Backbone.Collection(t),this.company_partyConcerneds=new Backbone.Collection,this.personal_accounts=new Backbone.Collection(a),this.company_accounts=new Backbone.Collection,this.addAllManager(this.personal_partyConcerneds),this.addAllAccount(this.personal_accounts)):(this.personal_partyConcerneds=new Backbone.Collection,this.company_partyConcerneds=new Backbone.Collection(t),this.personal_accounts=new Backbone.Collection,this.company_accounts=new Backbone.Collection(a),this.addAllManager(this.company_partyConcerneds),this.addAllAccount(this.company_accounts)),this.listenTo(this.personal_partyConcerneds,"add",this.addOneManager),this.listenTo(this.company_partyConcerneds,"add",this.addOneManager),this.listenTo(this.personal_accounts,"add",this.addOneAccount),this.listenTo(this.company_accounts,"add",this.addOneAccount),this.listenTo(this.personal_partyConcerneds,"reset",this.addAllManager),this.listenTo(this.company_partyConcerneds,"reset",this.addAllManager),this.listenTo(this.personal_accounts,"reset",this.addAllAccount),this.listenTo(this.company_accounts,"reset",this.addAllAccount)},initAutoComplete:function(){var e=this.$(".personal-name"),t=this.$(".company-name"),a={action:o+"/trade-party/search",parse:function(e){return 0==e.code?e.data.list:[]},search:function(){var e={};return e.tradePartyLegalType="0"==r('[name="lessee-type"]:checked').val()?"NATURAL_HUMAN":"LEGAL_ENTITY",e.partyOrder="Second_Party",e},parcelItem:function(e){var t="<li class='item' data-uuid="+e.tradePartyUuid+">"+e.name+"</li>";return r.data(document.body,e.tradePartyUuid,e),t},onSync:function(e,t,a){e.length<1&&a.hide()},onSubmit:r.proxy(function(e,t){var a=t.data("uuid"),n=r.data(document.body,a);this.stuffTradePartyInfo(n)},this)};e.autocomplete(r.extend({container:e.next(".auto-complete-list")},a)),t.autocomplete(r.extend({container:t.next(".auto-complete-list")},a))},stuffTradePartyInfo:function(e){function t(e){for(;e.length;)e.pop().destroy()}this.model.set("tradePartyId",e.tradePartyId),this.model.set("tradePartyUuid",e.tradePartyUuid);var a=e,n=function(e){if(r.isEmptyObject(e))return"";var t='<li class="item" data-original="'+e.imgKey+'" data-thumbnail="'+e.thumbNailsImgKey+'"><img class="img" src="'+s.thumbnail+"/"+e.thumbNailsImgKey+'"></li>';return t};if(this.$("[name=name]").val(a.name),this.$("[name=certificateNo]").val(a.certificateNo),this.$("[name=certificateType]").find("option").each(function(){return this.value===a.certificateType?(this.selected=!0,!1):void 0}),0==a.renterType){var i=n(a.frontCertificateImg);this.$(".front-pic-images").html(i),i=n(a.backCertificateImg),this.$(".back-pic-images").html(i),t(this.personal_accounts),t(this.personal_partyConcerneds),this.personal_accounts.reset(a.accountInfoList),this.personal_partyConcerneds.reset(a.partyConcernedInfoList)}else{var i=n(a.frontCertificateImg);this.$(".enterprise-pic-images").html(i),t(this.company_accounts),t(this.company_partyConcerneds),this.company_accounts.reset(a.accountInfoList),this.company_partyConcerneds.reset(a.partyConcernedInfoList)}},initFileUpload:function(){var t=this;e.globalUploadImage(this.$(".file-input"),{onPlacement:function(e,a){t.$(a.data("target")).html(e)},onSuccess:function(e,t){t.removeClass("error")}})},addAccountHandler:function(e){e.preventDefault();var t,a=this,n=new Backbone.Model;t=0==a.getRenterTypeFromDom()?this.personal_accounts:this.company_accounts;var i=new h({model:n,collection:t});i.show(),n.once("change",function(){t.add(n)})},addOneAccount:function(e){var t=new l({model:e});this.$(".payers").append(t.render().$el),this.$(".add-account").removeClass("error")},addAllAccount:function(e){for(var t=0,a=e.length;a>t;t++)this.addOneAccount(e.at(t))},addManagerHandler:function(e){e.preventDefault();var t,a=this,n=new Backbone.Model;t=0==a.getRenterTypeFromDom()?this.personal_partyConcerneds:this.company_partyConcerneds;var i=new d({model:n,collection:t});i.show(),n.once("change",function(){t.add(n)})},addOneManager:function(e){var t=new c({model:e});this.$(".contact-persons").append(t.render().$el),this.$(".add-manager").removeClass("error")},addAllManager:function(e){for(var t=0,a=e.length;a>t;t++)this.addOneManager(e.at(t))},getCurTabView:function(){return this.tabs.children(":not(.hide)")},switchTabView:function(e){var t=r(e.currentTarget);if(!t.find("input").get(0).disabled){var a=this.getCurTabView(),n=t.data("target");a.is(n)||(this.deleteTab.removeClass("hide").appendTo(this.tabs),this.deleteTab=a.detach())}},getRenterTypeFromDom:function(){var e=this.$("[name=lessee-type]:checked").val();return e},extractDomData:function(){var e=this._extractDomData(this.$(".real-value"),!0),t=function(e){var t=e.children().first().data();return t?{imgKey:t.original,thumbNailsImgKey:t.thumbnail,imageName:""}:{}};return e.renterType=this.getRenterTypeFromDom(),0==e.renterType?(e.partyConcernedInfoList=this.personal_partyConcerneds.toJSON(),e.accountInfoList=this.personal_accounts.toJSON()):(e.partyConcernedInfoList=this.company_partyConcerneds.toJSON(),e.accountInfoList=this.company_accounts.toJSON()),this.$(".upload-imgs").each(function(){var a=r(this);a.hasClass("front-pic-images")?e.frontCertificateImg=t(a):a.hasClass("back-pic-images")?e.backCertificateImg=t(a):a.hasClass("enterprise-pic-images")&&(e.frontCertificateImg=t(a))}),e},validate:function(){var e=!0;return e}});module.exports=u});