define(function(require,exports,module){var e=require("baseView/baseFormView").FormDialogView,t=require("component/popupTip"),i=require("component/areaSelect"),a=global_config.root,n=global_const.loadingImg,o=jQuery,r=e.extend({template:_.template(o("#editCustomerInfoTmpl").html(),{variable:"obj"}),actions:{submit:a+"/modifyContractAccount/repaymentInfo/modify"},initialize:function(){r.__super__.initialize.call(this,arguments),this.defineValidator(),this.areaSelect=new i({el:this.$(".area-select")}),this.$(".selectpicker").selectpicker("render")},defineValidator:function(){this.validator=this.$(".form").validate({rules:{bankAccount:"required",cityCode:"required",provinceCode:"required"}})},validate:function(){var e=!0;return"请选择"===this.$(".filter-option").html()?(this.$(".dropdown-toggle").addClass("error"),e=!1):(e=!0,this.$(".dropdown-toggle").removeClass("error")),this.validator.form()&&e},save:function(){var e=this,t=o("[name=contractId]").val().trim();if(t){var i=this.extractDomData();i.contractId=t,i.bankCode=o("[name=bankCode]").val();var a={url:this.actions.submit,type:"post",dataType:"json",data:i};a.success=function(t){e.model.trigger("model:edit-customer-info",t,i)},o.ajax(a)}},submitHandler:function(){this.validate()&&(this.save(),this.hide())}}),s=e.extend({template:_.template(o("#terminateContractTmpl").html(),{variable:"obj"}),actions:{submit:a+"/contracts/invalidate"},initialize:function(){s.__super__.initialize.call(this,arguments),this.defineValidator()},defineValidator:function(){this.validator=this.$(".form").validate({rules:{comment:{required:!0,maxlength:50}}})},validate:function(){return this.validator.form()},save:function(){var e=this,t=this.extractDomData();t.contractId=this.model.get("contractId");var i={url:this.actions.submit,type:"post",dataType:"json",data:t};i.success=function(i){e.model.trigger("model:terminate-contract",i,t)},o.ajax(i)},submitHandler:function(){this.validate()&&(this.save(),this.hide())}}),l={initialize:function(e){this.$tabMenuItem=e.$tabMenuItem,this.mInitialize&&this.mInitialize(e)},hide:function(){this.$el.hide(),this.$tabMenuItem.removeClass("active")},show:function(){this.$el.show(),this.$tabMenuItem.addClass("active")}},c=Backbone.View.extend({events:{"click .expand":"onClickExpand"},orderDetailTemplate:_.template(o("#orderDetailTmpl").html()||""),initialize:function(){this.$loading=o('<tr><td colspan="8" align="center"></td></tr>').find("td").append(n.clone()),this.expanded=!1,this.on("request:orderdetail",function(){this.$el.after(this.$loading)}),this.on("response:orderdetail",function(e){if(this.$loading.remove(),0==e.code){var i=this.orderDetailTemplate(e.data);this.$el.after(i)}else t.show(e.message)})},onClickExpand:function(e){e.preventDefault(),this.toggleOrderDetail()},toggleOrderDetail:function(){this.expanded?this.collapseOrderDetail():this.expandOrderDetail()},collapseOrderDetail:function(){this.expanded=!1,this.$el.removeClass("active");var e=this.$el.next(".bill-card-box");e.remove()},expandOrderDetail:function(){this.expanded=!0,this.$el.addClass("active");var e={remittanceApplicationUuid:this.$el.data("remittance-application-uuid")},t={url:"./detail/planlist",type:"get",dataType:"json",data:e};t.success=function(e){this.trigger("response:orderdetail",e)}.bind(this),this.trigger("request:orderdetail"),o.ajax(t)}}),d=Backbone.View.extend(o.extend({},l,{mInitialize:function(e){this.$(".item-release").toArray().forEach(function(e,t){var i=new c({el:e});0==t&&i.expandOrderDetail()})}})),h=Backbone.View.extend(o.extend({},l,{})),m=Backbone.View.extend({el:".content",events:{"click #terminateContract":"onClickTerminateContract","click .edit-customer-info":"onClickEditCustomerInfo","click .tab-menu-item":"onClickTabMenuItem","mouseover .showPopover":"showPopover","click .icon-bankcard":"onClickBankcard","mouseout .showPopover":"showPopover"},initialize:function(e){this.initModel(e),this.initTabContentView(),o(window).on("click",function(){o("body").find(".popover").last().hasClass("clickShow")&&o("body").find(".popover").popover("hide")})},initModel:function(e){this.model=new Backbone.Model(e);var t={};t.contractNo=this.$(".contractNo").text().trim(),t.amount=this.$(".amount").text().trim(),t.customer=this.$(".customer").text().trim(),t.idCardNum=this.$(".idcard-num").text().trim(),t.customerSource=this.$(".customer-source").text().trim(),t.bank=this.$(".bank").text().trim(),this.model.set(t)},showPopover:function(e){e.preventDefault();var t=o(e.target),i=t.siblings(".account").html();t.popover({content:i}),t.popover("toggle")},onClickBankcard:function(e){e.preventDefault(),this.showPopover(e);var t=o(e.target);return t.on("shown.bs.popover",function(){o("body").find(".popover").last().addClass("clickShow")}),t.on("hidden.bs.popover",function(){t.removeClass("active")}),t.toggleClass("active"),!1},initTabContentView:function(){var e=this.tabContentViews={};e.release=new d({el:this.$(".tab-content-item-release").get(0),$tabMenuItem:this.$(".tab-menu-item-release")}),e.repay=new h({el:this.$(".tab-content-item-repay").get(0),$tabMenuItem:this.$(".tab-menu-item-repay")}),e.release.hide(),e.repay.hide(),this.activeTabContentView=e.repay,this.activeTabContentView.show(),this.$(".tabs").show()},handleAfterPopupHide:function(e){0==e.code?(t.show("操作成功"),setTimeout(function(){location.reload()},1e3)):t.show(e.message||"操作失败，请重试")},onClickEditCustomerInfo:function(e){e.preventDefault();var t=new r({model:this.model});this.model.once("model:edit-customer-info",this.handleAfterPopupHide),t.show()},onClickTerminateContract:function(){var e=new s({model:this.model});this.model.once("model:terminate-contract",this.handleAfterPopupHide),e.show()},onClickTabMenuItem:function(e){e.preventDefault();var t=o(e.currentTarget),i=t.data("target"),a=this.tabContentViews[i];this.activeTabContentView.hide(),a.show(),this.activeTabContentView=a}});module.exports=m});